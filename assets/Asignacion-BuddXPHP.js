import{j as e,a as L,r as t,S as y,b as A,A as S,d as q}from"./index-D_5yPiNa.js";import{i as I,z as M,m as $,E as F,t as D,G as O}from"./index-BCRNc57j.js";import{P as R}from"./PageTransition-DiW9MPnf.js";import"./iconBase-DP8UkxFN.js";const U=({mensaje:l,onClose:p})=>{if(!l)return null;const i=`alert alert-${l.tipo} alert-dismissible fade show`;return e.jsxs("div",{className:i,role:"alert",children:[l.texto,e.jsx("button",{type:"button",className:"btn-close",onClick:p,"aria-label":"Close"})]})},z=()=>{const l=L();return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h2",{className:"text-dark mb-0",children:[e.jsx(I,{className:"me-2"})," Asignacion"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn btn-outline-orange btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>l("/estudiantes"),children:[e.jsx(M,{})," ",e.jsx("span",{children:"Estudiantes"})]}),e.jsxs("button",{className:"btn btn-outline-orange btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>l("/dashboard"),children:[e.jsx($,{})," ",e.jsx("span",{children:"Volver"})]})]})]})},H=({aperturas:l,selectedApertura:p,onAperturaChange:i,getSelectedAperturaDetails:u})=>{const g=l.filter((o,j,f)=>f.findIndex(c=>c.titulo===o.titulo&&c.periodo_nombre===o.periodo_nombre)===j);return e.jsx("div",{className:"col-12 col-md-6",children:e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"mb-3",children:"Seleccionar Cuestionario"}),g.length===0?e.jsx("p",{className:"text-muted text-center mb-0",children:"Sin cuestionarios."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"apertura_id",className:"form-label",children:"Cuestionario:"}),e.jsxs("select",{id:"apertura_id",className:"form-select",value:p,onChange:o=>i(o.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Seleccione --"}),g.map(o=>e.jsxs("option",{value:o.id,children:[o.titulo," (",o.periodo_nombre,")"]},o.id))]})]}),e.jsx("div",{children:u()?e.jsxs("div",{className:"alert alert-info mb-0",children:[e.jsx("strong",{children:u()?.titulo}),e.jsxs("p",{className:"mb-0 mt-1",children:[u()?.periodo_nombre," - ",u()?.programa_nombre]})]}):e.jsx("p",{className:"text-muted text-center mb-0",children:"Seleccione cuestionario."})})]})]})})})},J=({estudiantes:l,selectedEstudiantes:p,filtroEstudiante:i,seleccionarTodos:u,onFiltroChange:g,onToggleSeleccionarTodos:o,onEstudianteCheckboxChange:j,filteredEstudiantes:f})=>e.jsx("div",{className:"col-12 col-md-6",children:e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"mb-3",children:"Seleccionar Estudiantes"}),e.jsx("div",{children:l.length===0?e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("p",{className:"mb-1",children:"Sin estudiantes."}),e.jsx("p",{className:"mb-0",children:"Importe estudiantes."})]}):e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Estudiantes:"}),e.jsxs("div",{className:"d-flex gap-2 mb-2",children:[e.jsx("input",{id:"estudiante_nombre",type:"text",placeholder:"Buscar...",className:"form-control",value:i,onChange:c=>g(c.target.value)}),e.jsx("button",{type:"button",className:"btn btn-outline-orange w-30 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:o,children:e.jsx("span",{children:u?"Ninguno":"Todos"})})]}),e.jsx("div",{className:"border rounded p-3",style:{maxHeight:"200px",overflowY:"auto"},children:f.map(c=>e.jsxs("div",{className:"form-check",children:[e.jsx("input",{type:"checkbox",id:`estudiante_${c.id}`,checked:p.includes(c.id),onChange:()=>j(c.id),className:"form-check-input"}),e.jsxs("label",{htmlFor:`estudiante_${c.id}`,className:"form-check-label",children:[c.nombre," - ",c.programa_nombre]})]},c.id))})]})})]})})}),V=()=>e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-muted",children:"Sin asignaciones."})}),Y=({asignaciones:l,onEliminarAsignacion:p})=>{const i=l,[u,g]=t.useState(""),[o,j]=t.useState(""),[f,c]=t.useState(""),b=t.useMemo(()=>Array.from(new Set(i.map(a=>a.cuestionario_titulo))).sort((a,s)=>a.localeCompare(s,"es",{sensitivity:"base"})),[i]),w=t.useMemo(()=>Array.from(new Set(i.map(a=>a.periodo_nombre))).sort((a,s)=>a.localeCompare(s,"es",{sensitivity:"base"})),[i]),E=t.useMemo(()=>i.filter(s=>{const n=!u||s.cuestionario_titulo===u,d=!o||s.periodo_nombre===o,m=f.trim().toLowerCase(),h=!m||s.estudiante_nombre.toLowerCase().includes(m)||s.email.toLowerCase().includes(m);return n&&d&&h}).sort((s,n)=>s.estudiante_nombre.localeCompare(n.estudiante_nombre,"es",{sensitivity:"base"})),[i,u,o,f]);return e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3",children:[e.jsx("h5",{className:"mb-0",children:"Asignaciones"}),e.jsxs("div",{className:"d-flex flex-column flex-sm-row gap-2",children:[e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"text",className:"form-control pe-5",placeholder:"Buscar estudiante o email",value:f,onChange:a=>c(a.target.value)}),e.jsx("i",{className:"fas fa-search position-absolute text-secondary",style:{right:10,top:"50%",transform:"translateY(-50%)"}})]}),e.jsxs("select",{className:"form-select w-25",value:u,onChange:a=>g(a.target.value),children:[e.jsx("option",{value:"",children:"Todos los cuestionarios"}),b.map((a,s)=>e.jsx("option",{value:a,children:a},s))]}),e.jsxs("select",{className:"form-select w-25",value:o,onChange:a=>j(a.target.value),children:[e.jsx("option",{value:"",children:"Todos los periodos"}),w.map((a,s)=>e.jsx("option",{value:a,children:a},s))]})]})]}),i.length===0?e.jsx(V,{}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-borderless mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-user me-2"}),"Estudiante"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-envelope me-2"}),"Email"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-file-alt me-2"}),"Cuestionario"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-calendar me-2"}),"Periodo"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-cogs me-2"}),"Acciones"]})})]})}),e.jsx("tbody",{children:E.map(a=>e.jsxs("tr",{className:"border-bottom",children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:a.estudiante_nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:a.email})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:a.cuestionario_titulo})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:a.periodo_nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("button",{className:"btn btn-outline-danger btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>p(a.id),title:"Eliminar",children:e.jsx("i",{className:"fas fa-trash"})})})]},a.id))})]})})]})})},G=({onRecargarDatos:l,asignaciones:p})=>{const[i,u]=t.useState([]),[g,o]=t.useState(""),[j,f]=t.useState(!1),[c,b]=t.useState(!1);t.useEffect(()=>{w()},[p]);const w=()=>{try{const s=new Map;p.forEach(d=>{const m=d.programa_nombre||"Sin programa";s.has(m)||s.set(m,[]),s.get(m)?.push(d)});const n=Array.from(s.entries()).map(([d,m])=>({programa_nombre:d,asignaciones:m,total_asignaciones:m.length}));u(n),n.length===1?(o(n[0].programa_nombre),f(!0)):f(!1)}catch(s){console.error("Error al procesar programas:",s),u([])}},E=async()=>{if(!g){y.fire({icon:"warning",title:"Atención",text:"Debe seleccionar un programa"});return}const s=i.find(d=>d.programa_nombre===g);if(!s)return;(await y.fire({title:"¿Está completamente seguro?",html:`
        <p>Esta acción eliminará <strong>TODAS</strong> las asignaciones del programa:</p>
        <p><strong>"${s.programa_nombre}"</strong></p>
        <p>Total de asignaciones a eliminar: <span style="color: red; font-weight: bold;">${s.total_asignaciones}</span></p>
        <br>
        <p style="color: red;"><strong>⚠️ Esta acción NO se puede deshacer</strong></p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar TODAS",cancelButtonText:"Cancelar",input:"checkbox",inputPlaceholder:"Confirmo que entiendo que esta acción es irreversible",inputValidator:d=>!d&&"Debe confirmar que entiende las consecuencias"})).isConfirmed&&await a(s)},a=async s=>{try{b(!0);const n=localStorage.getItem("usuario"),m=(n?JSON.parse(n):null)?.id||"";let h=0,C=0;for(const _ of s.asignaciones)try{const v=await A.delete(S.asignacion.eliminar(_.id),{params:{usuario_id:m}});v?.data?.success?h++:(C++,console.error("Error en respuesta:",v?.data?.message||v?.data?.error))}catch(v){C++,console.error("Error al eliminar asignación individual:",v?.response?.data?.message||v?.message)}h>0?(await y.fire({icon:C>0?"warning":"success",title:C>0?"Eliminación parcial":"¡Eliminación completada!",html:`
            <p>Se eliminaron <strong>${h}</strong> asignaciones</p>
            <p>del programa: <strong>"${s.programa_nombre}"</strong></p>
            ${C>0?`<p style="color: orange;">Errores: ${C}</p>`:""}
          `,timer:3e3,showConfirmButton:!1}),o(""),l()):await y.fire({icon:"error",title:"Error",text:"No se pudieron eliminar las asignaciones"})}catch(n){console.error("Error general:",n),y.fire({icon:"error",title:"Error",text:n instanceof Error?n.message:"Error al eliminar asignaciones"})}finally{b(!1)}};return i.length===0?e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(F,{className:"me-2"})," Eliminar Asignaciones por Programa"]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx(D,{className:"me-2"})," No hay programas con asignaciones activas."]})]})}):e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(F,{className:"me-2"})," Eliminar Asignaciones por Programa"]}),e.jsxs("div",{className:"alert alert-warning",children:[e.jsx(D,{className:"me-2"}),e.jsx("strong",{children:"¡ATENCIÓN!"})," Esta acción eliminará TODAS las asignaciones del programa seleccionado."]}),e.jsx("div",{className:"row g-12",children:e.jsx("div",{className:"col-md-12",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"programa_eliminar",className:"form-label fw-bold",style:{color:"#1e293b"},children:"Seleccione el programa para eliminar todas sus asignaciones:"}),e.jsxs("div",{className:"d-flex flex-column flex-md-row align-items-stretch align-items-md-center gap-2 w-100",children:[e.jsxs("select",{style:{width:"100%"},id:"programa_eliminar",className:"form-select flex-grow-1",value:g,onChange:s=>o(s.target.value),disabled:c||j,children:[!j&&e.jsx("option",{value:"",children:"-- Seleccione un programa --"}),i.map((s,n)=>e.jsxs("option",{value:s.programa_nombre,children:[s.programa_nombre," (",s.total_asignaciones," asignaciones)"]},n))]}),e.jsx("div",{className:"d-grid d-md-inline-flex",children:e.jsx("button",{type:"button",className:"btn btn-outline-danger w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:E,disabled:!g||c,children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm"}),e.jsx("span",{children:"Eliminando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{}),e.jsx("span",{children:"Eliminar Todas"})]})})})]})]})})}),g&&e.jsxs("div",{className:"alert alert-warning mt-3",children:[e.jsx("strong",{children:"Resumen de la acción:"}),e.jsxs("ul",{className:"mb-0 mt-2",children:[e.jsxs("li",{children:["Programa: ",e.jsx("strong",{children:i.find(s=>s.programa_nombre===g)?.programa_nombre})]}),e.jsxs("li",{children:["Asignaciones a eliminar: ",e.jsx("strong",{children:i.find(s=>s.programa_nombre===g)?.total_asignaciones})]}),e.jsx("li",{children:e.jsxs("strong",{children:[e.jsx(D,{})," Esta acción NO se puede deshacer"]})})]})]})]})})},K=()=>{const l=t.useContext(q),[p,i]=t.useState([]),[u,g]=t.useState([]),[o,j]=t.useState([]),[f,c]=t.useState(!1),b=t.useMemo(()=>l?.user?.id,[l?.user?.id]),w=t.useCallback(async()=>{try{c(!0);const[n,d,m]=await Promise.all([A.get(S.cuestionario.abiertos).catch(r=>(console.error("Error al obtener cuestionarios abiertos:",r),{data:[]})),A.get(S.estudiante.base).catch(r=>{if(r?.response?.status===404)return{data:{estudiantes:[]}};throw r}),A.get(S.asignacion.obtener(b||"me"))]),h=n?.data,_=(Array.isArray(h)?h:Array.isArray(h?.cuestionarios_abiertos)?h.cuestionarios_abiertos:Array.isArray(h?.abiertos)?h.abiertos:Array.isArray(h?.data?.cuestionarios_abiertos)?h.data.cuestionarios_abiertos:Array.isArray(h?.data)?h.data:[]).map(r=>({id:Number(r.apertura_id??r.id??r.cuestionario_id??0),titulo:String(r.titulo??r.cuestionario_titulo??"Cuestionario"),descripcion:String(r.descripcion??r.cuestionario_descripcion??""),periodo_nombre:String(r.periodo_nombre??r.periodo??"No especificado"),fecha_inicio:String(r.fecha_inicio??r.inicio??""),fecha_fin:String(r.fecha_fin??r.fin??""),programa_nombre:String(r.programa_nombre??r.programa??"No especificado")})),v=Array.isArray(d?.data?.estudiantes)?d?.data?.estudiantes:Array.isArray(d?.data?.data?.estudiantes)?d?.data?.data?.estudiantes:[],P=Array.isArray(m?.data?.asignaciones)?m?.data?.asignaciones:Array.isArray(m?.data?.data?.asignaciones)?m?.data?.data?.asignaciones:[];i(_),g(v);const B=new Map;_.forEach(r=>{r&&typeof r.id=="number"&&B.set(r.id,r)});const T=P.map(r=>({...r,programa_nombre:r.programa_nombre||B.get(r.id_apertura)?.programa_nombre||"Sin programa"}));j(T)}catch(n){await y.fire({icon:"error",title:"Error",text:n?.message||"Error al cargar los datos de asignación"})}finally{c(!1)}},[b]),E=t.useCallback(async(n,d)=>{await A.post(S.asignacion.crear,{id_apertura:Number(n),id_estudiante:d})},[]),a=t.useCallback(async n=>{await A.delete(S.asignacion.eliminar(n))},[]),s=t.useRef(!1);return t.useEffect(()=>{!b||s.current||(s.current=!0,w())},[b,w]),{aperturas:p,estudiantes:u,asignaciones:o,loading:f,cargarDatos:w,asignar:E,eliminarAsignacion:a}},ee=()=>{const{aperturas:l,estudiantes:p,asignaciones:i,cargarDatos:u,asignar:g,eliminarAsignacion:o,loading:j}=K(),[f,c]=t.useState(null),[b,w]=t.useState(""),[E,a]=t.useState(!1),[s,n]=t.useState(""),[d,m]=t.useState([]),h=async x=>{if(x.preventDefault(),!s||d.length===0){c({texto:"Debe seleccionar un cuestionario y al menos un estudiante",tipo:"warning"});return}try{await g(s,d),y.fire({icon:"success",title:"¡Éxito!",text:"Asignación realizada con éxito",timer:1500,showConfirmButton:!1}),n(""),m([]),a(!1),u()}catch(N){console.error("Error general:",N),y.fire({icon:"error",title:"Error",text:N instanceof Error?N.message:"Error al realizar la asignación"})}},C=async x=>{y.fire({title:"¿Está seguro?",text:"¿Desea eliminar esta asignación?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"}).then(async N=>{if(N.isConfirmed)try{await o(x),y.fire({icon:"success",title:"¡Éxito!",text:"Asignación eliminada con éxito",timer:1500,showConfirmButton:!1}),u()}catch(k){console.error("Error general:",k),y.fire({icon:"error",title:"Error",text:k instanceof Error?k.message:"Error al eliminar la asignación"})}})},_=()=>{const x=!E;a(x),m(x?T.map(N=>N.id):[])},v=x=>{m(N=>N.includes(x)?N.filter(k=>k!==x):[...N,x])},P=s&&l.find(x=>x.id===parseInt(s))||null,T=p.filter(x=>P?x.programa_nombre===P.programa_nombre:!0).filter(x=>x.nombre.toLowerCase().includes(b.toLowerCase())||x.email.toLowerCase().includes(b.toLowerCase())||x.programa_nombre.toLowerCase().includes(b.toLowerCase())),r=()=>s&&l.find(x=>x.id===parseInt(s))||null;return e.jsx(R,{children:e.jsx("div",{className:"min-vh-100 bg-light",children:e.jsxs("div",{className:"container-fluid py-3",children:[e.jsx(z,{}),e.jsx(U,{mensaje:f,onClose:()=>c(null)}),e.jsxs("div",{className:"row g-4",children:[e.jsxs("div",{className:"col-12",children:[e.jsxs("form",{onSubmit:h,children:[e.jsxs("div",{className:"row g-3",children:[e.jsx(H,{aperturas:l,selectedApertura:s,onAperturaChange:n,getSelectedAperturaDetails:r}),e.jsx(J,{estudiantes:p,selectedEstudiantes:d,filtroEstudiante:b,seleccionarTodos:E,onFiltroChange:w,onToggleSeleccionarTodos:_,onEstudianteCheckboxChange:v,filteredEstudiantes:T})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",disabled:j||l.length===0||p.length===0,children:[e.jsx(O,{}),e.jsx("span",{children:"Asignar"})]})})]}),e.jsx("hr",{className:"my-4"}),e.jsx("div",{className:"mt-2",children:e.jsx(G,{onRecargarDatos:u,asignaciones:i})})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("hr",{className:"my-4"}),e.jsx(Y,{asignaciones:i,onEliminarAsignacion:C})]})]})]})})})};export{ee as default};
