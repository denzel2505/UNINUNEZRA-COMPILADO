import{j as e,a as U,r as i,S as w,b as S,A as _,d as z}from"./index-CkH1TajL.js";import{i as H,z as J,m as V,E as q,t as L,G as Y}from"./index-DTaE7NR5.js";import{P as G}from"./PageTransition-Co3V1ZrG.js";import"./iconBase-DH91qiyX.js";const K=({mensaje:d,onClose:f})=>{if(!d)return null;const c=`alert alert-${d.tipo} alert-dismissible fade show`;return e.jsxs("div",{className:c,role:"alert",children:[d.texto,e.jsx("button",{type:"button",className:"btn-close",onClick:f,"aria-label":"Close"})]})},Q=()=>{const d=U();return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h2",{className:"text-dark mb-0",children:[e.jsx(H,{className:"me-2"})," Asignacion"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn btn-outline-orange btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>d("/estudiantes"),children:[e.jsx(J,{})," ",e.jsx("span",{children:"Estudiantes"})]}),e.jsxs("button",{className:"btn btn-outline-orange btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>d("/dashboard"),children:[e.jsx(V,{})," ",e.jsx("span",{children:"Volver"})]})]})]})},W=({aperturas:d,selectedApertura:f,onAperturaChange:c,getSelectedAperturaDetails:g})=>{const p=d.filter((l,N,j)=>j.findIndex(t=>t.titulo===l.titulo&&t.periodo_nombre===l.periodo_nombre)===N);return e.jsx("div",{className:"col-12 col-md-6",children:e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"mb-3",children:"Seleccionar Cuestionario"}),p.length===0?e.jsx("p",{className:"text-muted text-center mb-0",children:"Sin cuestionarios."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"apertura_id",className:"form-label",children:"Cuestionario:"}),e.jsxs("select",{id:"apertura_id",className:"form-select",value:f,onChange:l=>c(l.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Seleccione --"}),p.map(l=>e.jsxs("option",{value:l.id,children:[l.titulo," (",l.periodo_nombre,")"]},l.id))]})]}),e.jsx("div",{children:g()?e.jsxs("div",{className:"alert alert-info mb-0",children:[e.jsx("strong",{children:g()?.titulo}),e.jsxs("p",{className:"mb-0 mt-1",children:[g()?.periodo_nombre," - ",g()?.programa_nombre]})]}):e.jsx("p",{className:"text-muted text-center mb-0",children:"Seleccione cuestionario."})})]})]})})})},X=({estudiantes:d,selectedEstudiantes:f,filtroEstudiante:c,seleccionarTodos:g,onFiltroChange:p,onToggleSeleccionarTodos:l,onEstudianteCheckboxChange:N,filteredEstudiantes:j})=>e.jsx("div",{className:"col-12 col-md-6",children:e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"mb-3",children:"Seleccionar Estudiantes"}),e.jsx("div",{children:d.length===0?e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("p",{className:"mb-1",children:"Sin estudiantes."}),e.jsx("p",{className:"mb-0",children:"Importe estudiantes."})]}):e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Estudiantes:"}),e.jsxs("div",{className:"d-flex gap-2 mb-2",children:[e.jsx("input",{id:"estudiante_nombre",type:"text",placeholder:"Buscar...",className:"form-control",value:c,onChange:t=>p(t.target.value)}),e.jsx("button",{type:"button",className:"btn btn-outline-orange w-30 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:l,children:e.jsx("span",{children:g?"Ninguno":"Todos"})})]}),e.jsx("div",{className:"border rounded p-3",style:{maxHeight:"200px",overflowY:"auto"},children:j.map(t=>e.jsxs("div",{className:"form-check",children:[e.jsx("input",{type:"checkbox",id:`estudiante_${t.id}`,checked:f.includes(t.id),onChange:()=>N(t.id),className:"form-check-input"}),e.jsx("label",{htmlFor:`estudiante_${t.id}`,className:"form-check-label",children:(()=>{const b=Array.isArray(t.programas)&&t.programas.length?t.programas.map(v=>v.nombre).join(", "):"";return b?`${t.nombre} - ${b}`:t.nombre})()})]},t.id))})]})})]})})}),Z=()=>e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-muted",children:"Sin asignaciones."})}),ee=({asignaciones:d,onEliminarAsignacion:f})=>{const c=d,[g,p]=i.useState(""),[l,N]=i.useState(""),[j,t]=i.useState(""),b=i.useMemo(()=>Array.from(new Set(c.map(r=>r.cuestionario_titulo))).sort((r,s)=>r.localeCompare(s,"es",{sensitivity:"base"})),[c]),v=i.useMemo(()=>Array.from(new Set(c.map(r=>r.periodo_nombre))).sort((r,s)=>r.localeCompare(s,"es",{sensitivity:"base"})),[c]),E=i.useMemo(()=>c.filter(s=>{const n=!g||s.cuestionario_titulo===g,m=!l||s.periodo_nombre===l,u=j.trim().toLowerCase(),y=!u||s.estudiante_nombre.toLowerCase().includes(u)||s.email.toLowerCase().includes(u);return n&&m&&y}).sort((s,n)=>s.estudiante_nombre.localeCompare(n.estudiante_nombre,"es",{sensitivity:"base"})),[c,g,l,j]);return e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3",children:[e.jsx("h5",{className:"mb-0",children:"Asignaciones"}),e.jsxs("div",{className:"d-flex flex-column flex-sm-row gap-2",children:[e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"text",className:"form-control pe-5",placeholder:"Buscar estudiante o email",value:j,onChange:r=>t(r.target.value)}),e.jsx("i",{className:"fas fa-search position-absolute text-secondary",style:{right:10,top:"50%",transform:"translateY(-50%)"}})]}),e.jsxs("select",{className:"form-select w-25",value:g,onChange:r=>p(r.target.value),children:[e.jsx("option",{value:"",children:"Todos los cuestionarios"}),b.map((r,s)=>e.jsx("option",{value:r,children:r},s))]}),e.jsxs("select",{className:"form-select w-25",value:l,onChange:r=>N(r.target.value),children:[e.jsx("option",{value:"",children:"Todos los periodos"}),v.map((r,s)=>e.jsx("option",{value:r,children:r},s))]})]})]}),c.length===0?e.jsx(Z,{}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-borderless mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-user me-2"}),"Estudiante"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-envelope me-2"}),"Email"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-file-alt me-2"}),"Cuestionario"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-calendar me-2"}),"Periodo"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-cogs me-2"}),"Acciones"]})})]})}),e.jsx("tbody",{children:E.map(r=>e.jsxs("tr",{className:"border-bottom",children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:r.estudiante_nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:r.email})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:r.cuestionario_titulo})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-dark",children:r.periodo_nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("button",{className:"btn btn-outline-danger btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>f(r.id),title:"Eliminar",children:e.jsx("i",{className:"fas fa-trash"})})})]},r.id))})]})})]})})},se=({onRecargarDatos:d,asignaciones:f})=>{const[c,g]=i.useState([]),[p,l]=i.useState(""),[N,j]=i.useState(!1),[t,b]=i.useState(!1);i.useEffect(()=>{v()},[f]);const v=()=>{try{const s=new Map;f.forEach(m=>{const u=m.programa_nombre||"Sin programa";s.has(u)||s.set(u,[]),s.get(u)?.push(m)});const n=Array.from(s.entries()).map(([m,u])=>({programa_nombre:m,asignaciones:u,total_asignaciones:u.length}));g(n),n.length===1?(l(n[0].programa_nombre),j(!0)):j(!1)}catch(s){console.error("Error al procesar programas:",s),g([])}},E=async()=>{if(!p){w.fire({icon:"warning",title:"Atención",text:"Debe seleccionar un programa"});return}const s=c.find(m=>m.programa_nombre===p);if(!s)return;(await w.fire({title:"¿Está completamente seguro?",html:`
        <p>Esta acción eliminará <strong>TODAS</strong> las asignaciones del programa:</p>
        <p><strong>"${s.programa_nombre}"</strong></p>
        <p>Total de asignaciones a eliminar: <span style="color: red; font-weight: bold;">${s.total_asignaciones}</span></p>
        <br>
        <p style="color: red;"><strong>⚠️ Esta acción NO se puede deshacer</strong></p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar TODAS",cancelButtonText:"Cancelar",input:"checkbox",inputPlaceholder:"Confirmo que entiendo que esta acción es irreversible",inputValidator:m=>!m&&"Debe confirmar que entiende las consecuencias"})).isConfirmed&&await r(s)},r=async s=>{try{b(!0);const n=localStorage.getItem("usuario"),u=(n?JSON.parse(n):null)?.id||"";let y=0,x=0;for(const P of s.asignaciones)try{const A=await S.delete(_.asignacion.eliminar(P.id),{params:{usuario_id:u}});A?.data?.success?y++:(x++,console.error("Error en respuesta:",A?.data?.message||A?.data?.error))}catch(A){x++,console.error("Error al eliminar asignación individual:",A?.response?.data?.message||A?.message)}y>0?(await w.fire({icon:x>0?"warning":"success",title:x>0?"Eliminación parcial":"¡Eliminación completada!",html:`
            <p>Se eliminaron <strong>${y}</strong> asignaciones</p>
            <p>del programa: <strong>"${s.programa_nombre}"</strong></p>
            ${x>0?`<p style="color: orange;">Errores: ${x}</p>`:""}
          `,timer:3e3,showConfirmButton:!1}),l(""),d()):await w.fire({icon:"error",title:"Error",text:"No se pudieron eliminar las asignaciones"})}catch(n){console.error("Error general:",n),w.fire({icon:"error",title:"Error",text:n instanceof Error?n.message:"Error al eliminar asignaciones"})}finally{b(!1)}};return c.length===0?e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(q,{className:"me-2"})," Eliminar Asignaciones por Programa"]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx(L,{className:"me-2"})," No hay programas con asignaciones activas."]})]})}):e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(q,{className:"me-2"})," Eliminar Asignaciones por Programa"]}),e.jsxs("div",{className:"alert alert-warning",children:[e.jsx(L,{className:"me-2"}),e.jsx("strong",{children:"¡ATENCIÓN!"})," Esta acción eliminará TODAS las asignaciones del programa seleccionado."]}),e.jsx("div",{className:"row g-12",children:e.jsx("div",{className:"col-md-12",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"programa_eliminar",className:"form-label fw-bold",style:{color:"#1e293b"},children:"Seleccione el programa para eliminar todas sus asignaciones:"}),e.jsxs("div",{className:"d-flex flex-column flex-md-row align-items-stretch align-items-md-center gap-2 w-100",children:[e.jsxs("select",{style:{width:"100%"},id:"programa_eliminar",className:"form-select flex-grow-1",value:p,onChange:s=>l(s.target.value),disabled:t||N,children:[!N&&e.jsx("option",{value:"",children:"-- Seleccione un programa --"}),c.map((s,n)=>e.jsxs("option",{value:s.programa_nombre,children:[s.programa_nombre," (",s.total_asignaciones," asignaciones)"]},n))]}),e.jsx("div",{className:"d-grid d-md-inline-flex",children:e.jsx("button",{type:"button",className:"btn btn-outline-danger w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:E,disabled:!p||t,children:t?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm"}),e.jsx("span",{children:"Eliminando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{}),e.jsx("span",{children:"Eliminar Todas"})]})})})]})]})})}),p&&e.jsxs("div",{className:"alert alert-warning mt-3",children:[e.jsx("strong",{children:"Resumen de la acción:"}),e.jsxs("ul",{className:"mb-0 mt-2",children:[e.jsxs("li",{children:["Programa: ",e.jsx("strong",{children:c.find(s=>s.programa_nombre===p)?.programa_nombre})]}),e.jsxs("li",{children:["Asignaciones a eliminar: ",e.jsx("strong",{children:c.find(s=>s.programa_nombre===p)?.total_asignaciones})]}),e.jsx("li",{children:e.jsxs("strong",{children:[e.jsx(L,{})," Esta acción NO se puede deshacer"]})})]})]})]})})},ae=()=>{const d=i.useContext(z),[f,c]=i.useState([]),[g,p]=i.useState([]),[l,N]=i.useState([]),[j,t]=i.useState(!1),b=i.useMemo(()=>d?.user?.id,[d?.user?.id]),v=i.useCallback(async()=>{try{t(!0);const[n,m,u,y]=await Promise.all([S.get(_.cuestionario.abiertos).catch(a=>(console.error("Error al obtener cuestionarios abiertos:",a),{data:[]})),S.get(_.estudiante.base).catch(a=>{if(a?.response?.status===404)return{data:{estudiantes:[]}};throw a}),S.get(_.asignacion.obtener(b||"me")),S.get(_.programas.base).catch(()=>({data:[]}))]),x=n?.data,A=(Array.isArray(x)?x:Array.isArray(x?.cuestionarios_abiertos)?x.cuestionarios_abiertos:Array.isArray(x?.abiertos)?x.abiertos:Array.isArray(x?.data?.cuestionarios_abiertos)?x.data.cuestionarios_abiertos:Array.isArray(x?.data)?x.data:[]).map(a=>({id:Number(a.apertura_id??a.id??a.cuestionario_id??0),titulo:String(a.titulo??a.cuestionario_titulo??"Cuestionario"),descripcion:String(a.descripcion??a.cuestionario_descripcion??""),periodo_nombre:String(a.periodo_nombre??a.periodo??"No especificado"),fecha_inicio:String(a.fecha_inicio??a.inicio??""),fecha_fin:String(a.fecha_fin??a.fin??""),programa_nombre:String(a.programa_nombre??a.programa??"No especificado")}));let k=Array.isArray(m?.data?.estudiantes)?m?.data?.estudiantes:Array.isArray(m?.data?.data?.estudiantes)?m?.data?.data?.estudiantes:[];const B=y?.data?.data??y?.data;let C=[];if(Array.isArray(B?.programas)?C=B.programas:Array.isArray(y?.data)&&(C=y?.data),Array.isArray(C)&&C.length===1){const a=C[0]||{},T=Number(a?.id??NaN),M=String(a?.nombre??"").trim();k=k.filter($=>{const D=Array.isArray($?.programas)?$.programas:[];if(!D.length)return!1;const R=!Number.isNaN(T)&&D.some(I=>Number(I?.id)===T),O=!R&&!!M&&D.some(I=>String(I?.nombre??"").trim()===M);return R||O})}const F=Array.isArray(u?.data?.asignaciones)?u?.data?.asignaciones:Array.isArray(u?.data?.data?.asignaciones)?u?.data?.data?.asignaciones:[];c(A),p(k);const o=new Map;A.forEach(a=>{a&&typeof a.id=="number"&&o.set(a.id,a)});const h=F.map(a=>({...a,programa_nombre:a.programa_nombre||o.get(a.id_apertura)?.programa_nombre||"Sin programa"}));N(h)}catch(n){await w.fire({icon:"error",title:"Error",text:n?.message||"Error al cargar los datos de asignación"})}finally{t(!1)}},[b]),E=i.useCallback(async(n,m)=>{await S.post(_.asignacion.crear,{id_apertura:Number(n),id_estudiante:m})},[]),r=i.useCallback(async n=>{await S.delete(_.asignacion.eliminar(n))},[]),s=i.useRef(!1);return i.useEffect(()=>{!b||s.current||(s.current=!0,v())},[b,v]),{aperturas:f,estudiantes:g,asignaciones:l,loading:j,cargarDatos:v,asignar:E,eliminarAsignacion:r}},oe=()=>{const{aperturas:d,estudiantes:f,asignaciones:c,cargarDatos:g,asignar:p,eliminarAsignacion:l,loading:N}=ae(),[j,t]=i.useState(null),[b,v]=i.useState(""),[E,r]=i.useState(!1),[s,n]=i.useState(""),[m,u]=i.useState([]),y=async o=>{if(o.preventDefault(),!s||m.length===0){t({texto:"Debe seleccionar un cuestionario y al menos un estudiante",tipo:"warning"});return}try{await p(s,m),w.fire({icon:"success",title:"¡Éxito!",text:"Asignación realizada con éxito",timer:1500,showConfirmButton:!1}),n(""),u([]),r(!1),g()}catch(h){console.error("Error general:",h),w.fire({icon:"error",title:"Error",text:h instanceof Error?h.message:"Error al realizar la asignación"})}},x=async o=>{w.fire({title:"¿Está seguro?",text:"¿Desea eliminar esta asignación?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"}).then(async h=>{if(h.isConfirmed)try{await l(o),w.fire({icon:"success",title:"¡Éxito!",text:"Asignación eliminada con éxito",timer:1500,showConfirmButton:!1}),g()}catch(a){console.error("Error general:",a),w.fire({icon:"error",title:"Error",text:a instanceof Error?a.message:"Error al eliminar la asignación"})}})},P=()=>{const o=!E;r(o),u(o?C.map(h=>h.id):[])},A=o=>{u(h=>h.includes(o)?h.filter(a=>a!==o):[...h,o])},k=s&&d.find(o=>o.id===parseInt(s))||null,C=f.filter(o=>k?(Array.isArray(o.programas)?o.programas.map(a=>String(a?.nombre??"")).filter(Boolean):[]).includes(k.programa_nombre):!0).filter(o=>{const h=b.toLowerCase(),a=Array.isArray(o.programas)?o.programas.map(T=>String(T?.nombre??"")).join(", ").toLowerCase():"";return String(o.nombre||"").toLowerCase().includes(h)||String(o.email||"").toLowerCase().includes(h)||a.includes(h)}),F=()=>s&&d.find(o=>o.id===parseInt(s))||null;return e.jsx(G,{children:e.jsx("div",{className:"min-vh-100 bg-light",children:e.jsxs("div",{className:"container-fluid py-3",children:[e.jsx(Q,{}),e.jsx(K,{mensaje:j,onClose:()=>t(null)}),e.jsxs("div",{className:"row g-4",children:[e.jsxs("div",{className:"col-12",children:[e.jsxs("form",{onSubmit:y,children:[e.jsxs("div",{className:"row g-3",children:[e.jsx(W,{aperturas:d,selectedApertura:s,onAperturaChange:n,getSelectedAperturaDetails:F}),e.jsx(X,{estudiantes:f,selectedEstudiantes:m,filtroEstudiante:b,seleccionarTodos:E,onFiltroChange:v,onToggleSeleccionarTodos:P,onEstudianteCheckboxChange:A,filteredEstudiantes:C})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",disabled:N||d.length===0||f.length===0,children:[e.jsx(Y,{}),e.jsx("span",{children:"Asignar"})]})})]}),e.jsx("hr",{className:"my-4"}),e.jsx("div",{className:"mt-2",children:e.jsx(se,{onRecargarDatos:g,asignaciones:c})})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("hr",{className:"my-4"}),e.jsx(ee,{asignaciones:c,onEliminarAsignacion:x})]})]})]})})})};export{oe as default};
