import{j as e,a as I,r as o,S as f,b as C,A as S,d as L}from"./index-DaOhVVWd.js";import{i as $,A as M,m as O,H as D,t as F,I as R}from"./index-B8Flq_4W.js";import{P as q}from"./PageTransition-Couod70-.js";import"./iconBase-Cr-ff6zs.js";const H=({mensaje:t,onClose:x})=>{if(!t)return null;const d=`alert alert-${t.tipo} alert-dismissible fade show`;return e.jsxs("div",{className:d,role:"alert",children:[t.texto,e.jsx("button",{type:"button",className:"btn-close",onClick:x,"aria-label":"Close"})]})},U=()=>{const t=I();return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h2",{className:"text-dark mb-0",children:[e.jsx($,{className:"me-2"})," Asignacion"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn btn-outline-orange btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>t("/estudiantes"),children:[e.jsx(M,{})," ",e.jsx("span",{children:"Estudiantes"})]}),e.jsxs("button",{className:"btn btn-outline-orange btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>t("/dashboard"),children:[e.jsx(O,{})," ",e.jsx("span",{children:"Volver"})]})]})]})},z=({aperturas:t,selectedApertura:x,onAperturaChange:d,getSelectedAperturaDetails:n})=>{const g=t.filter((m,j,N)=>N.findIndex(i=>i.titulo===m.titulo&&i.periodo_nombre===m.periodo_nombre)===j);return e.jsx("div",{className:"col-12 col-md-6",children:e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"mb-3",children:"Seleccionar Cuestionario"}),g.length===0?e.jsx("p",{className:"text-muted text-center mb-0",children:"Sin cuestionarios."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"apertura_id",className:"form-label",children:"Cuestionario:"}),e.jsxs("select",{id:"apertura_id",className:"form-select",value:x,onChange:m=>d(m.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Seleccione --"}),g.map(m=>e.jsxs("option",{value:m.id,children:[m.titulo," (",m.periodo_nombre,")"]},m.id))]})]}),e.jsx("div",{children:n()?e.jsxs("div",{className:"alert alert-info mb-0",children:[e.jsx("strong",{children:n()?.titulo}),e.jsxs("p",{className:"mb-0 mt-1",children:[n()?.periodo_nombre," - ",n()?.programa_nombre]})]}):e.jsx("p",{className:"text-muted text-center mb-0",children:"Seleccione cuestionario."})})]})]})})})},J=({estudiantes:t,selectedEstudiantes:x,filtroEstudiante:d,seleccionarTodos:n,onFiltroChange:g,onToggleSeleccionarTodos:m,onEstudianteCheckboxChange:j,filteredEstudiantes:N})=>e.jsx("div",{className:"col-12 col-md-6",children:e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"mb-3",children:"Seleccionar Estudiantes"}),e.jsx("div",{children:t.length===0?e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("p",{className:"mb-1",children:"Sin estudiantes."}),e.jsx("p",{className:"mb-0",children:"Importe estudiantes."})]}):e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Estudiantes:"}),e.jsxs("div",{className:"d-flex gap-2 mb-2",children:[e.jsx("input",{id:"estudiante_nombre",type:"text",placeholder:"Buscar...",className:"form-control",value:d,onChange:i=>g(i.target.value)}),e.jsx("button",{type:"button",className:"btn btn-outline-orange w-30 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:m,children:e.jsx("span",{children:n?"Ninguno":"Todos"})})]}),e.jsx("div",{className:"border rounded p-3",style:{maxHeight:"200px",overflowY:"auto"},children:N.map(i=>e.jsxs("div",{className:"form-check",children:[e.jsx("input",{type:"checkbox",id:`estudiante_${i.id}`,checked:x.includes(i.id),onChange:()=>j(i.id),className:"form-check-input"}),e.jsxs("label",{htmlFor:`estudiante_${i.id}`,className:"form-check-label",children:[i.nombre," - ",i.programa_nombre]})]},i.id))})]})})]})})}),V=()=>e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-muted",children:"Sin asignaciones."})}),Y=({asignaciones:t,onEliminarAsignacion:x})=>{const d=t;return e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"mb-3",children:"Asignaciones"}),d.length===0?e.jsx(V,{}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-borderless mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-hashtag me-2"}),"ID"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-user me-2"}),"Estudiante"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-envelope me-2"}),"Email"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-file-alt me-2"}),"Cuestionario"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-calendar me-2"}),"Periodo"]})}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-center",children:[e.jsx("i",{className:"fas fa-cogs me-2"}),"Acciones"]})})]})}),e.jsx("tbody",{children:d.map(n=>e.jsxs("tr",{className:"border-bottom",children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"fw-bold",style:{color:"#1e293b"},children:n.id})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"fw-bold",style:{color:"#1e293b"},children:n.estudiante_nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:n.email})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"fw-bold",style:{color:"#1e293b"},children:n.cuestionario_titulo})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"badge rounded-pill",style:{backgroundColor:"#3b82f6",color:"white"},children:n.periodo_nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("button",{className:"btn btn-outline-danger btn-sm d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>x(n.id),title:"Eliminar",children:e.jsx("i",{className:"fas fa-trash"})})})]},n.id))})]})})]})})},G=({onRecargarDatos:t,asignaciones:x})=>{const[d,n]=o.useState([]),[g,m]=o.useState(""),[j,N]=o.useState(!1),[i,p]=o.useState(!1);o.useEffect(()=>{E()},[x]);const E=()=>{try{const s=new Map;x.forEach(c=>{const u=c.programa_nombre||"Sin programa";s.has(u)||s.set(u,[]),s.get(u)?.push(c)});const r=Array.from(s.entries()).map(([c,u])=>({programa_nombre:c,asignaciones:u,total_asignaciones:u.length}));n(r),r.length===1?(m(r[0].programa_nombre),N(!0)):N(!1)}catch(s){console.error("Error al procesar programas:",s),n([])}},w=async()=>{if(!g){f.fire({icon:"warning",title:"Atención",text:"Debe seleccionar un programa"});return}const s=d.find(c=>c.programa_nombre===g);if(!s)return;(await f.fire({title:"¿Está completamente seguro?",html:`
        <p>Esta acción eliminará <strong>TODAS</strong> las asignaciones del programa:</p>
        <p><strong>"${s.programa_nombre}"</strong></p>
        <p>Total de asignaciones a eliminar: <span style="color: red; font-weight: bold;">${s.total_asignaciones}</span></p>
        <br>
        <p style="color: red;"><strong>⚠️ Esta acción NO se puede deshacer</strong></p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar TODAS",cancelButtonText:"Cancelar",input:"checkbox",inputPlaceholder:"Confirmo que entiendo que esta acción es irreversible",inputValidator:c=>!c&&"Debe confirmar que entiende las consecuencias"})).isConfirmed&&await _(s)},_=async s=>{try{p(!0);const r=localStorage.getItem("usuario"),u=(r?JSON.parse(r):null)?.id||"";let h=0,v=0;for(const A of s.asignaciones)try{const y=await C.delete(S.asignacion.eliminar(A.id),{params:{usuario_id:u}});y?.data?.success?h++:(v++,console.error("Error en respuesta:",y?.data?.message||y?.data?.error))}catch(y){v++,console.error("Error al eliminar asignación individual:",y?.response?.data?.message||y?.message)}h>0?(await f.fire({icon:v>0?"warning":"success",title:v>0?"Eliminación parcial":"¡Eliminación completada!",html:`
            <p>Se eliminaron <strong>${h}</strong> asignaciones</p>
            <p>del programa: <strong>"${s.programa_nombre}"</strong></p>
            ${v>0?`<p style="color: orange;">Errores: ${v}</p>`:""}
          `,timer:3e3,showConfirmButton:!1}),m(""),t()):await f.fire({icon:"error",title:"Error",text:"No se pudieron eliminar las asignaciones"})}catch(r){console.error("Error general:",r),f.fire({icon:"error",title:"Error",text:r instanceof Error?r.message:"Error al eliminar asignaciones"})}finally{p(!1)}};return d.length===0?e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(D,{className:"me-2"})," Eliminar Asignaciones por Programa"]}),e.jsxs("div",{className:"alert alert-info",children:[e.jsx(F,{className:"me-2"})," No hay programas con asignaciones activas."]})]})}):e.jsx("div",{className:"card shadow-sm border",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h5",{className:"mb-3",children:[e.jsx(D,{className:"me-2"})," Eliminar Asignaciones por Programa"]}),e.jsxs("div",{className:"alert alert-warning",children:[e.jsx(F,{className:"me-2"}),e.jsx("strong",{children:"¡ATENCIÓN!"})," Esta acción eliminará TODAS las asignaciones del programa seleccionado."]}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-md-8",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"programa_eliminar",className:"form-label fw-bold",style:{color:"#1e293b"},children:"Seleccione el programa para eliminar todas sus asignaciones:"}),e.jsxs("select",{id:"programa_eliminar",className:"form-select",value:g,onChange:s=>m(s.target.value),disabled:i||j,children:[!j&&e.jsx("option",{value:"",children:"-- Seleccione un programa --"}),d.map((s,r)=>e.jsxs("option",{value:s.programa_nombre,children:[s.programa_nombre," (",s.total_asignaciones," asignaciones)"]},r))]})]})}),e.jsx("div",{className:"col-md-4 d-flex align-items-end",children:e.jsx("button",{type:"button",className:"btn btn-outline-danger w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:w,disabled:!g||i,children:i?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm"}),e.jsx("span",{children:"Eliminando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{}),e.jsx("span",{children:"Eliminar Todas"})]})})})]}),g&&e.jsxs("div",{className:"alert alert-danger mt-3",children:[e.jsx("strong",{children:"⚠️ Resumen de la acción:"}),e.jsxs("ul",{className:"mb-0 mt-2",children:[e.jsxs("li",{children:["Programa: ",e.jsx("strong",{children:d.find(s=>s.programa_nombre===g)?.programa_nombre})]}),e.jsxs("li",{children:["Asignaciones a eliminar: ",e.jsx("strong",{children:d.find(s=>s.programa_nombre===g)?.total_asignaciones})]}),e.jsx("li",{children:e.jsx("strong",{children:"⚠️ Esta acción NO se puede deshacer"})})]})]})]})})},K=()=>{const t=o.useContext(L),[x,d]=o.useState([]),[n,g]=o.useState([]),[m,j]=o.useState([]),[N,i]=o.useState(!1),p=o.useMemo(()=>t?.user?.id,[t?.user?.id]),E=o.useCallback(async()=>{try{i(!0);const[r,c,u]=await Promise.all([C.get(S.cuestionario.abiertos).catch(a=>(console.error("Error al obtener cuestionarios abiertos:",a),{data:[]})),C.get(S.estudiante.base).catch(a=>{if(a?.response?.status===404)return{data:{estudiantes:[]}};throw a}),C.get(S.asignacion.obtener(p||"me"))]),h=r?.data,A=(Array.isArray(h)?h:Array.isArray(h?.cuestionarios_abiertos)?h.cuestionarios_abiertos:Array.isArray(h?.abiertos)?h.abiertos:Array.isArray(h?.data?.cuestionarios_abiertos)?h.data.cuestionarios_abiertos:Array.isArray(h?.data)?h.data:[]).map(a=>({id:Number(a.apertura_id??a.id??a.cuestionario_id??0),titulo:String(a.titulo??a.cuestionario_titulo??"Cuestionario"),descripcion:String(a.descripcion??a.cuestionario_descripcion??""),periodo_nombre:String(a.periodo_nombre??a.periodo??"No especificado"),fecha_inicio:String(a.fecha_inicio??a.inicio??""),fecha_fin:String(a.fecha_fin??a.fin??""),programa_nombre:String(a.programa_nombre??a.programa??"No especificado")})),y=Array.isArray(c?.data?.estudiantes)?c?.data?.estudiantes:Array.isArray(c?.data?.data?.estudiantes)?c?.data?.data?.estudiantes:[],T=Array.isArray(u?.data?.asignaciones)?u?.data?.asignaciones:Array.isArray(u?.data?.data?.asignaciones)?u?.data?.data?.asignaciones:[];d(A),g(y);const B=new Map;A.forEach(a=>{a&&typeof a.id=="number"&&B.set(a.id,a)});const k=T.map(a=>({...a,programa_nombre:a.programa_nombre||B.get(a.id_apertura)?.programa_nombre||"Sin programa"}));j(k)}catch(r){await f.fire({icon:"error",title:"Error",text:r?.message||"Error al cargar los datos de asignación"})}finally{i(!1)}},[p]),w=o.useCallback(async(r,c)=>{await C.post(S.asignacion.crear,{id_apertura:Number(r),id_estudiante:c})},[]),_=o.useCallback(async r=>{await C.delete(S.asignacion.eliminar(r))},[]),s=o.useRef(!1);return o.useEffect(()=>{!p||s.current||(s.current=!0,E())},[p,E]),{aperturas:x,estudiantes:n,asignaciones:m,loading:N,cargarDatos:E,asignar:w,eliminarAsignacion:_}},ee=()=>{const{aperturas:t,estudiantes:x,asignaciones:d,cargarDatos:n,asignar:g,eliminarAsignacion:m,loading:j}=K(),[N,i]=o.useState(null),[p,E]=o.useState(""),[w,_]=o.useState(!1),[s,r]=o.useState(""),[c,u]=o.useState([]),h=async l=>{if(l.preventDefault(),!s||c.length===0){i({texto:"Debe seleccionar un cuestionario y al menos un estudiante",tipo:"warning"});return}try{await g(s,c),f.fire({icon:"success",title:"¡Éxito!",text:"Asignación realizada con éxito",timer:1500,showConfirmButton:!1}),r(""),u([]),_(!1),n()}catch(b){console.error("Error general:",b),f.fire({icon:"error",title:"Error",text:b instanceof Error?b.message:"Error al realizar la asignación"})}},v=async l=>{f.fire({title:"¿Está seguro?",text:"¿Desea eliminar esta asignación?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"}).then(async b=>{if(b.isConfirmed)try{await m(l),f.fire({icon:"success",title:"¡Éxito!",text:"Asignación eliminada con éxito",timer:1500,showConfirmButton:!1}),n()}catch(P){console.error("Error general:",P),f.fire({icon:"error",title:"Error",text:P instanceof Error?P.message:"Error al eliminar la asignación"})}})},A=()=>{const l=!w;_(l),u(l?k.map(b=>b.id):[])},y=l=>{u(b=>b.includes(l)?b.filter(P=>P!==l):[...b,l])},T=s&&t.find(l=>l.id===parseInt(s))||null,k=x.filter(l=>T?l.programa_nombre===T.programa_nombre:!0).filter(l=>l.nombre.toLowerCase().includes(p.toLowerCase())||l.email.toLowerCase().includes(p.toLowerCase())||l.programa_nombre.toLowerCase().includes(p.toLowerCase())),a=()=>s&&t.find(l=>l.id===parseInt(s))||null;return e.jsx(q,{children:e.jsx("div",{className:"min-vh-100 bg-light",children:e.jsxs("div",{className:"container-fluid py-3",children:[e.jsx(U,{}),e.jsx(H,{mensaje:N,onClose:()=>i(null)}),e.jsxs("div",{className:"row g-4",children:[e.jsxs("div",{className:"col-12",children:[e.jsxs("form",{onSubmit:h,children:[e.jsxs("div",{className:"row g-3",children:[e.jsx(z,{aperturas:t,selectedApertura:s,onAperturaChange:r,getSelectedAperturaDetails:a}),e.jsx(J,{estudiantes:x,selectedEstudiantes:c,filtroEstudiante:p,seleccionarTodos:w,onFiltroChange:E,onToggleSeleccionarTodos:A,onEstudianteCheckboxChange:y,filteredEstudiantes:k})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",disabled:j||t.length===0||x.length===0,children:[e.jsx(R,{}),e.jsx("span",{children:"Asignar"})]})})]}),e.jsx("hr",{className:"my-4"}),e.jsx("div",{className:"mt-2",children:e.jsx(G,{onRecargarDatos:n,asignaciones:d})})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("hr",{className:"my-4"}),e.jsx(Y,{asignaciones:d,onEliminarAsignacion:v})]})]})]})})})};export{ee as default};
