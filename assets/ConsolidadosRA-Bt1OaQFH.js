import{r as n,A as h,c as S,a as G,j as t,S as v}from"./index-4_f5pIIv.js";import{r as O,X as U}from"./index-O__zhACk.js";import{G as H}from"./iconBase-BPqFUofc.js";const W="_programButton_i9myy_5",q="_programHeader_i9myy_39",J="_programTitle_i9myy_53",X="_countBadge_i9myy_67",K="_chevron_i9myy_93",Q="_dropdownContent_i9myy_107",Y="_fadeIn_i9myy_119",j={programButton:W,programHeader:q,programTitle:J,countBadge:X,chevron:K,dropdownContent:Q,fadeIn:Y};function ee(){const[c,p]=n.useState(!1),[N,y]=n.useState(null),[l,x]=n.useState(null),u=n.useCallback(async d=>{try{p(!0),y(null);const s=h.informes.informes_periodo?.startsWith("/")?h.informes.informes_periodo:`/${h.informes.informes_periodo}`,m=await S.post(s,{estudiante_id:d.estudianteId,periodo_id:d.periodoId}),r=m?.data?.data??m?.data;return x(r),r}catch(s){const m=s?.response?.data?.message||s?.message||"Error al consultar informes por periodo";throw y(m),s}finally{p(!1)}},[]);return{loading:c,error:N,data:l,fetchInformesPeriodo:u}}function te(){const[c,p]=n.useState(!1),[N,y]=n.useState(null),[l,x]=n.useState([]),u=n.useRef(!1),d=n.useCallback(async()=>{try{if(u.current&&l.length>0)return l;p(!0),y(null);const s=h.periodo.base?.startsWith("/")?h.periodo.base:`/${h.periodo.base}`,r=(await S.get(s))?.data??{},w=Array.isArray(r?.data?.periodos)?r.data.periodos:Array.isArray(r?.periodos)?r.periodos:Array.isArray(r)?r:[];return x(w),u.current=!0,w}catch(s){const m=s?.response?.data?.message||s?.message||"Error al obtener periodos";throw y(m),s}finally{p(!1)}},[]);return{loading:c,error:N,data:l,fetchPeriodos:d,hasLoaded:u.current}}function ae(){const[c,p]=n.useState(!1),[N,y]=n.useState(null),[l,x]=n.useState([]),u=n.useRef(!1),d=n.useCallback(async()=>{try{if(u.current&&l.length>0)return l;p(!0),y(null);const s=h.estudiante.base?.startsWith("/")?h.estudiante.base:`/${h.estudiante.base}`,r=(await S.get(s))?.data??{},_=(Array.isArray(r?.data?.estudiantes)?r.data.estudiantes:Array.isArray(r?.data)?r.data:Array.isArray(r?.items)?r.items:Array.isArray(r?.estudiantes)?r.estudiantes:Array.isArray(r)?r:[]).map(o=>({id:String(o.id??o.estudiante_id??""),nombre:String(o.nombre||[o.nombres,o.apellidos].filter(Boolean).join(" ")||o.identificacion||o.id||""),programas:Array.isArray(o.programas)?o.programas.map(b=>({id:String(b.id),nombre:String(b.nombre||`Programa ${b.id}`)})):void 0,identificacion:o.identificacion!=null?String(o.identificacion):void 0})).filter(o=>o.id);return x(_),u.current=!0,_}catch(s){const m=s?.response?.data?.message||s?.message||"Error al obtener estudiantes";throw y(m),s}finally{p(!1)}},[l.length]);return{loading:c,error:N,data:l,fetchEstudiantes:d,hasLoaded:u.current}}function re(c){return H({attr:{viewBox:"0 0 256 256",fill:"currentColor"},child:[{tag:"path",attr:{d:"M200,112a8,8,0,0,1-8,8H152a8,8,0,0,1,0-16h40A8,8,0,0,1,200,112Zm-8,24H152a8,8,0,0,0,0,16h40a8,8,0,0,0,0-16Zm40-80V200a16,16,0,0,1-16,16H40a16,16,0,0,1-16-16V56A16,16,0,0,1,40,40H216A16,16,0,0,1,232,56ZM216,200V56H40V200H216Zm-80.26-34a8,8,0,1,1-15.5,4c-2.63-10.26-13.06-18-24.25-18s-21.61,7.74-24.25,18a8,8,0,1,1-15.5-4,39.84,39.84,0,0,1,17.19-23.34,32,32,0,1,1,45.12,0A39.76,39.76,0,0,1,135.75,166ZM96,136a16,16,0,1,0-16-16A16,16,0,0,0,96,136Z"},child:[]}]})(c)}function ne(c){return H({attr:{viewBox:"0 0 256 256",fill:"currentColor"},child:[{tag:"path",attr:{d:"M226.53,56.41l-96-32a8,8,0,0,0-5.06,0l-96,32A8,8,0,0,0,24,64v80a8,8,0,0,0,16,0V75.1L73.59,86.29a64,64,0,0,0,20.65,88.05c-18,7.06-33.56,19.83-44.94,37.29a8,8,0,1,0,13.4,8.74C77.77,197.25,101.57,184,128,184s50.23,13.25,65.3,36.37a8,8,0,0,0,13.4-8.74c-11.38-17.46-27-30.23-44.94-37.29a64,64,0,0,0,20.65-88l44.12-14.7a8,8,0,0,0,0-15.18ZM176,120A48,48,0,1,1,89.35,91.55l36.12,12a8,8,0,0,0,5.06,0l36.12-12A47.89,47.89,0,0,1,176,120ZM128,87.57,57.3,64,128,40.43,198.7,64Z"},child:[]}]})(c)}const de=()=>{const c=G(),[p,N]=n.useState({}),{fetchInformesPeriodo:y,loading:l}=ee(),[x,u]=n.useState(null),{data:d,fetchPeriodos:s,loading:m}=te(),[r,w]=n.useState(""),{data:_,fetchEstudiantes:o}=ae();let b=!1;try{const e=localStorage.getItem("user"),a=e?JSON.parse(e):null,i=Number(a?.rol??a?.rol_user??a?.role??a?.tipo??a?.tipo_usuario),g=Number(localStorage.getItem("rol"));b=(Number.isFinite(i)?i:Number.isFinite(g)?g:NaN)===0}catch{}const D=n.useMemo(()=>{const e=new Map;return(_||[]).forEach(a=>{(Array.isArray(a.programas)&&a.programas.length>0?a.programas:[{id:"sin-programa",nombre:"Sin programa"}]).forEach(g=>{const A=String(g.id);e.has(A)||e.set(A,{id:A,nombre:String(g.nombre||`Programa ${g.id}`),estudiantes:[]}),e.get(A).estudiantes.push({id:a.id,nombre:a.nombre,identificacion:a.identificacion})})}),Array.from(e.values())},[_]),F=e=>{N(a=>({...a,[e]:!a[e]}))};n.useEffect(()=>{s().catch(()=>{})},[]),n.useEffect(()=>{if(!r&&Array.isArray(d)&&d.length>0){const e=d[0];e?.id!=null&&w(String(e.id))}},[d,r]);const P=n.useMemo(()=>(d||[]).find(e=>String(e?.id)===String(r)),[d,r]),M=e=>{if(!e)return null;const a=new Date(String(e).replace(/\//g,"-"));return isNaN(a.getTime())?null:a},V=e=>{if(!e)return null;const a=e.fecha_fin??e.fin??e.fechaFin??e.fecha_final??e.fecha_cierre??e.fecha_termino;return M(a)},E=n.useMemo(()=>{const e=V(P);if(!e)return!1;const a=new Date;a.setHours(0,0,0,0);const i=new Date(e);return i.setHours(0,0,0,0),i.getTime()<=a.getTime()},[P]);return n.useEffect(()=>{o().catch(()=>{})},[]),n.useEffect(()=>{b||c("/dashboard",{replace:!0})},[b,c]),b?t.jsxs("div",{className:`p-6 ${j.fadeIn}`,children:[t.jsxs("div",{className:"d-flex justify-content-between",children:[t.jsxs("div",{className:"mb-6 ",children:[t.jsx("h1",{className:"text-2xl font-semibold text-gray-800",children:"Consolidados de Resultados de Aprendizaje"}),t.jsx("p",{className:"text-gray-500 mt-1",children:"Genere y navegue los reportes consolidados por programa y estudiante."})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("p",{children:"Seleccione un periodo para generar consolidados"}),t.jsxs("select",{className:"form-select mt-2",value:r,onChange:e=>w(e.target.value),disabled:m,children:[t.jsx("option",{value:"",children:"Seleccionar periodo"}),(d||[]).map(e=>t.jsx("option",{value:String(e.id),children:e.nombre||e.descripcion||`Periodo ${e.id}`},e.id))]})]})]}),t.jsxs("div",{className:"space-y-4",children:[r?E?null:t.jsx("div",{className:"alert alert-warning",children:"Los reportes aún no están disponibles porque el periodo seleccionado sigue en curso. Vuelva a intentarlo cuando el periodo haya finalizado."}):t.jsx("div",{className:"alert alert-info",children:"Seleccione un periodo para continuar."}),E&&D.map(e=>t.jsxs("div",{className:"bg-white rounded shadow mb-4",children:[t.jsx("button",{className:`w-full flex items-center justify-between px-4 py-3 text-left hover:bg-gray-50 ${j.programButton}`,onClick:()=>F(e.id),children:t.jsx("div",{className:"flex-1",children:t.jsxs("div",{className:j.programHeader,children:[t.jsx("h2",{className:j.programTitle,children:e.nombre}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("span",{style:{marginRight:"15px"},className:j.countBadge,children:[e.estudiantes.length," estudiante(s)"]}),t.jsx("span",{className:j.chevron,children:p[e.id]?t.jsx(O,{}):t.jsx(U,{})})]})]})})}),p[e.id]&&t.jsx("div",{className:`border-t border-gray-100 ${j.dropdownContent}`,children:e.estudiantes.length===0?t.jsx("div",{className:"p-4 text-gray-500",children:"No hay estudiantes para este programa."}):t.jsx("ul",{className:"divide-y divide-gray-100",children:e.estudiantes.map(a=>t.jsx("li",{className:"d-flex justify-content-between px-4 py-3",children:t.jsxs("div",{className:"d-flex justify-content-between border-bottom w-100 mb-4",children:[t.jsxs("div",{children:[t.jsxs("span",{className:"d-block mb-2 size-sm",children:[t.jsx(ne,{})," Estudiante: ",t.jsx("p",{className:"d-inline text-gray-800 font-medium",children:a.nombre})]}),t.jsxs("span",{className:"d-block mb-2 size-sm",children:[t.jsx(re,{})," Identificacion: ",t.jsx("p",{className:"d-inline text-sm text-gray-500",children:a.identificacion||a.id})]})]}),t.jsx("div",{children:t.jsx("button",{style:{marginRight:"15px"},className:"btn btn-outline-secondary btn-sm",disabled:!r||l&&x===a.id,onClick:async()=>{try{if(!E){await v.fire({icon:"warning",title:"Periodo en curso",text:"Los reportes estarán disponibles cuando finalice el periodo seleccionado.",confirmButtonText:"Entendido"});return}if(!r){await v.fire({icon:"warning",title:"Periodo requerido",text:"Seleccione un periodo primero.",confirmButtonText:"Entendido"});return}u(a.id);try{const f=(await S.post(h.informes.informes_validar,{estudiante_id:a.id,programa_id:Number(e.id),periodo_id:Number(r)}))?.data??{},Z=f?.success,C=f?.data??f,k=!!C?.puede_generar_informe;if(Z===!1){await v.fire({icon:"warning",title:"No se pudo validar",text:String(f?.message||"No fue posible validar los cuestionarios."),confirmButtonText:"Entendido"});return}if(!k){const $=Array.isArray(C?.cuestionarios_pendientes)?C.cuestionarios_pendientes:[],T=$.length,L=T>0?`<ul style="text-align:left;">${$.map(z=>`<li>${z?.titulo??"Cuestionario pendiente"}</li>`).join("")}</ul>`:"";await v.fire({icon:"info",title:"Cuestionarios pendientes",html:`${String(f?.message||"El estudiante tiene cuestionarios pendientes.")}<br/><br/>Pendientes: <b>${T}</b>${L?"<br/>"+L:""}`,confirmButtonText:"Entendido"});return}}catch{await v.fire({icon:"error",title:"No fue posible validar",text:"Ocurrió un problema al validar los cuestionarios. Intente nuevamente.",confirmButtonText:"Entendido"});return}const i=await y({estudianteId:a.id,periodoId:Number(r)}),g=Array.isArray(i)?i:Array.isArray(i?.data)?i.data:Array.isArray(i?.data?.data)?i.data.data:[];if(!g||g.length===0){await v.fire({icon:"info",title:"Sin informes",text:`Este estudiante${a?.nombre?` (${a.nombre})`:""} aún no tiene informes en el periodo seleccionado.`,confirmButtonText:"Aceptar"});return}const A=g[0],R=A?.cuestionario_id;let I;if(R){const f=(await S.get(h.cuestionario.mostrarNivel(R)))?.data??{};I=Array.isArray(f?.data?.ra)?f.data.ra:Array.isArray(f?.ra)?f.ra:Array.isArray(f)?f:[],console.debug("RA niveles",I)}else console.warn("No se encontró cuestionario_id en informes/periodo");c(`/reporte-aprendizaje/estudiante/${encodeURIComponent(a.id)}?programaId=${encodeURIComponent(e.id)}`,{state:{informePeriodo:A,informesList:g,raList:I}})}catch(i){console.error("Error al consultar informes/periodo",i),await v.fire({icon:"error",title:"No se pudo obtener el informe",text:"Ocurrió un problema al obtener el informe del estudiante. Intente nuevamente.",confirmButtonText:"Entendido"})}finally{u(null)}},children:l&&x===a.id?"Cargando…":"Ver Reporte"})})]})},a.id))})})]},e.id))]})]}):null};export{de as default};
