import{r as s,A as h,c as _,a as R,j as e,S as $}from"./index-bvBplxLg.js";import{r as B,W as L}from"./index-CU0cwZ_L.js";import{G as E}from"./iconBase-BtrJDtBd.js";const H="_programButton_i9myy_5",Z="_programHeader_i9myy_39",k="_programTitle_i9myy_53",F="_countBadge_i9myy_67",M="_chevron_i9myy_93",V="_dropdownContent_i9myy_107",D="_fadeIn_i9myy_119",j={programButton:H,programHeader:Z,programTitle:k,countBadge:F,chevron:M,dropdownContent:V,fadeIn:D};function T(){const[i,f]=s.useState(!1),[A,g]=s.useState(null),[d,y]=s.useState(null),c=s.useCallback(async l=>{try{f(!0),g(null);const o=h.informes.informes_periodo?.startsWith("/")?h.informes.informes_periodo:`/${h.informes.informes_periodo}`,m=await _.post(o,{estudiante_id:l.estudianteId,periodo_id:l.periodoId}),r=m?.data?.data??m?.data;return y(r),r}catch(o){const m=o?.response?.data?.message||o?.message||"Error al consultar informes por periodo";throw g(m),o}finally{f(!1)}},[]);return{loading:i,error:A,data:d,fetchInformesPeriodo:c}}function z(){const[i,f]=s.useState(!1),[A,g]=s.useState(null),[d,y]=s.useState([]),c=s.useRef(!1),l=s.useCallback(async()=>{try{if(c.current&&d.length>0)return d;f(!0),g(null);const o=h.periodo.base?.startsWith("/")?h.periodo.base:`/${h.periodo.base}`,r=(await _.get(o))?.data??{},N=Array.isArray(r?.data?.periodos)?r.data.periodos:Array.isArray(r?.periodos)?r.periodos:Array.isArray(r)?r:[];return y(N),c.current=!0,N}catch(o){const m=o?.response?.data?.message||o?.message||"Error al obtener periodos";throw g(m),o}finally{f(!1)}},[]);return{loading:i,error:A,data:d,fetchPeriodos:l,hasLoaded:c.current}}function W(){const[i,f]=s.useState(!1),[A,g]=s.useState(null),[d,y]=s.useState([]),c=s.useRef(!1),l=s.useCallback(async()=>{try{if(c.current&&d.length>0)return d;f(!0),g(null);const o=h.estudiante.base?.startsWith("/")?h.estudiante.base:`/${h.estudiante.base}`,r=(await _.get(o))?.data??{},S=(Array.isArray(r?.data?.estudiantes)?r.data.estudiantes:Array.isArray(r?.data)?r.data:Array.isArray(r?.items)?r.items:Array.isArray(r?.estudiantes)?r.estudiantes:Array.isArray(r)?r:[]).map(n=>({id:String(n.id??n.estudiante_id??""),nombre:String(n.nombre||[n.nombres,n.apellidos].filter(Boolean).join(" ")||n.identificacion||n.id||""),programas:Array.isArray(n.programas)?n.programas.map(x=>({id:String(x.id),nombre:String(x.nombre||`Programa ${x.id}`)})):void 0,identificacion:n.identificacion!=null?String(n.identificacion):void 0})).filter(n=>n.id);return y(S),c.current=!0,S}catch(o){const m=o?.response?.data?.message||o?.message||"Error al obtener estudiantes";throw g(m),o}finally{f(!1)}},[d.length]);return{loading:i,error:A,data:d,fetchEstudiantes:l,hasLoaded:c.current}}function G(i){return E({attr:{viewBox:"0 0 256 256",fill:"currentColor"},child:[{tag:"path",attr:{d:"M200,112a8,8,0,0,1-8,8H152a8,8,0,0,1,0-16h40A8,8,0,0,1,200,112Zm-8,24H152a8,8,0,0,0,0,16h40a8,8,0,0,0,0-16Zm40-80V200a16,16,0,0,1-16,16H40a16,16,0,0,1-16-16V56A16,16,0,0,1,40,40H216A16,16,0,0,1,232,56ZM216,200V56H40V200H216Zm-80.26-34a8,8,0,1,1-15.5,4c-2.63-10.26-13.06-18-24.25-18s-21.61,7.74-24.25,18a8,8,0,1,1-15.5-4,39.84,39.84,0,0,1,17.19-23.34,32,32,0,1,1,45.12,0A39.76,39.76,0,0,1,135.75,166ZM96,136a16,16,0,1,0-16-16A16,16,0,0,0,96,136Z"},child:[]}]})(i)}function U(i){return E({attr:{viewBox:"0 0 256 256",fill:"currentColor"},child:[{tag:"path",attr:{d:"M226.53,56.41l-96-32a8,8,0,0,0-5.06,0l-96,32A8,8,0,0,0,24,64v80a8,8,0,0,0,16,0V75.1L73.59,86.29a64,64,0,0,0,20.65,88.05c-18,7.06-33.56,19.83-44.94,37.29a8,8,0,1,0,13.4,8.74C77.77,197.25,101.57,184,128,184s50.23,13.25,65.3,36.37a8,8,0,0,0,13.4-8.74c-11.38-17.46-27-30.23-44.94-37.29a64,64,0,0,0,20.65-88l44.12-14.7a8,8,0,0,0,0-15.18ZM176,120A48,48,0,1,1,89.35,91.55l36.12,12a8,8,0,0,0,5.06,0l36.12-12A47.89,47.89,0,0,1,176,120ZM128,87.57,57.3,64,128,40.43,198.7,64Z"},child:[]}]})(i)}const Q=()=>{const i=R(),[f,A]=s.useState({}),{fetchInformesPeriodo:g,loading:d}=T(),[y,c]=s.useState(null),{data:l,fetchPeriodos:o,loading:m}=z(),[r,N]=s.useState(""),{data:S,fetchEstudiantes:n}=W();let x=!1;try{const a=localStorage.getItem("user"),t=a?JSON.parse(a):null,u=Number(t?.rol??t?.rol_user??t?.role??t?.tipo??t?.tipo_usuario),p=Number(localStorage.getItem("rol"));x=(Number.isFinite(u)?u:Number.isFinite(p)?p:NaN)===0}catch{}const C=s.useMemo(()=>{const a=new Map;return(S||[]).forEach(t=>{(Array.isArray(t.programas)&&t.programas.length>0?t.programas:[{id:"sin-programa",nombre:"Sin programa"}]).forEach(p=>{const b=String(p.id);a.has(b)||a.set(b,{id:b,nombre:String(p.nombre||`Programa ${p.id}`),estudiantes:[]}),a.get(b).estudiantes.push({id:t.id,nombre:t.nombre,identificacion:t.identificacion})})}),Array.from(a.values())},[S]),P=a=>{A(t=>({...t,[a]:!t[a]}))};return s.useEffect(()=>{o().catch(()=>{})},[]),s.useEffect(()=>{if(!r&&Array.isArray(l)&&l.length>0){const a=l[0];a?.id!=null&&N(String(a.id))}},[l]),s.useEffect(()=>{n().catch(()=>{})},[]),s.useEffect(()=>{x||i("/dashboard",{replace:!0})},[x,i]),x?e.jsxs("div",{className:`p-6 ${j.fadeIn}`,children:[e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"mb-6 ",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-800",children:"Consolidados de Resultados de Aprendizaje"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Genere y navegue los reportes consolidados por programa y estudiante."})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{children:"Seleccione un periodo para generar consolidados"}),e.jsxs("select",{className:"form-select mt-2",value:r,onChange:a=>N(a.target.value),disabled:m,children:[e.jsx("option",{value:"",children:"Seleccionar periodo"}),(l||[]).map(a=>e.jsx("option",{value:String(a.id),children:a.nombre||a.descripcion||`Periodo ${a.id}`},a.id))]})]})]}),e.jsx("div",{className:"space-y-4",children:C.map(a=>e.jsxs("div",{className:"bg-white rounded shadow mb-4",children:[e.jsx("button",{className:`w-full flex items-center justify-between px-4 py-3 text-left hover:bg-gray-50 ${j.programButton}`,onClick:()=>P(a.id),children:e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:j.programHeader,children:[e.jsx("h2",{className:j.programTitle,children:a.nombre}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("span",{style:{marginRight:"15px"},className:j.countBadge,children:[a.estudiantes.length," estudiante(s)"]}),e.jsx("span",{className:j.chevron,children:f[a.id]?e.jsx(B,{}):e.jsx(L,{})})]})]})})}),f[a.id]&&e.jsx("div",{className:`border-t border-gray-100 ${j.dropdownContent}`,children:a.estudiantes.length===0?e.jsx("div",{className:"p-4 text-gray-500",children:"No hay estudiantes para este programa."}):e.jsx("ul",{className:"divide-y divide-gray-100",children:a.estudiantes.map(t=>e.jsx("li",{className:"d-flex justify-content-between px-4 py-3",children:e.jsxs("div",{className:"d-flex justify-content-between border-bottom w-100 mb-4",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"d-block mb-2 size-sm",children:[e.jsx(U,{})," Estudiante: ",e.jsx("p",{className:"d-inline text-gray-800 font-medium",children:t.nombre})]}),e.jsxs("span",{className:"d-block mb-2 size-sm",children:[e.jsx(G,{})," Identificacion: ",e.jsx("p",{className:"d-inline text-sm text-gray-500",children:t.identificacion||t.id})]})]}),e.jsx("div",{children:e.jsx("button",{style:{marginRight:"15px"},className:"btn btn-outline-secondary btn-sm",disabled:!r||d&&y===t.id,onClick:async()=>{try{if(!r){alert("Seleccione un periodo primero.");return}c(t.id);const u=await g({estudianteId:t.id,periodoId:Number(r)}),p=Array.isArray(u)?u:Array.isArray(u?.data)?u.data:Array.isArray(u?.data?.data)?u.data.data:[];if(!p||p.length===0){await $.fire({icon:"info",title:"Sin informes",text:`Este estudiante${t?.nombre?` (${t.nombre})`:""} aún no tiene informes.`,confirmButtonText:"Aceptar"});return}const b=p[0],I=b?.cuestionario_id;let w;if(I){const v=(await _.get(h.cuestionario.mostrarNivel(I)))?.data??{};w=Array.isArray(v?.data?.ra)?v.data.ra:Array.isArray(v?.ra)?v.ra:Array.isArray(v)?v:[],console.debug("RA niveles",w)}else console.warn("No se encontró cuestionario_id en informes/periodo");i(`/reporte-aprendizaje/estudiante/${encodeURIComponent(t.id)}?programaId=${encodeURIComponent(a.id)}`,{state:{informePeriodo:b,informesList:p,raList:w}})}catch(u){console.error("Error al consultar informes/periodo",u),alert("No se pudo obtener el informe del estudiante.")}finally{c(null)}},children:d&&y===t.id?"Cargando…":"Ver Reporte"})})]})},t.id))})})]},a.id))})]}):null};export{Q as default};
