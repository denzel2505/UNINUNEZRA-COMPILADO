import{r as p,c as C,A as I,S as f,_ as W,a as Y,j as e}from"./index-4_f5pIIv.js";import{P as k}from"./PageTransition-BlxOQiVy.js";import{u as Q}from"./useAuthentication-OwBKS9a4.js";import{A as Z,n as ee,K as re,L as ae,M as te,N as se,O as ie}from"./index-O__zhACk.js";import{u as ne}from"./index.esm-Cxwau0hN.js";import"./iconBase-BPqFUofc.js";const oe=()=>{const{user:l}=Q(),[d,s]=p.useState([]),[g,w]=p.useState([]),[i,E]=p.useState(!0),[j,_]=p.useState(null),[c,F]=p.useState(""),[S,$]=p.useState("todos"),[q,T]=p.useState(""),O=p.useRef(null),U=p.useRef(!1),P=p.useRef({main:null}),B=p.useRef({}),L=async()=>{try{if(P.current.main){await P.current.main;return}B.current.estudiantes?.abort(),B.current.programas?.abort(),B.current.estudiantes=new AbortController,B.current.programas=new AbortController,E(!0),_(null),P.current.main=(async()=>{const[a,r]=await Promise.all([C.get(I.estudiante.base).catch(h=>{if(h?.response?.status===404)return{data:{estudiantes:[]}};throw h?.name==="CanceledError",h}),C.get(I.programas.base)]);let t=a?.data?.estudiantes??[];const n=r?.data?.data??r?.data;let v=[];if(Array.isArray(n?.programas)?v=n.programas:Array.isArray(n?.programa)?v=n.programa:n?.programa&&typeof n.programa=="object"?v=[n.programa]:Array.isArray(r?.data)&&(v=r?.data),!t.length)try{const h=l?.id||"",o=await C.get(`${I.estudiante.base}?usuario_id=${h}`);Array.isArray(o?.data?.data?.estudiantes)&&(t=o.data.data.estudiantes)}catch{}const D=t.map(h=>{const o={...h};let N=[];Array.isArray(o.programas)?N=o.programas:Array.isArray(o.programa)?N=o.programa:o.programa&&typeof o.programa=="object"?N=[o.programa]:Array.isArray(o.data?.programas)&&(N=o.data.programas);const y=[...N].sort((x,b)=>String(x?.nombre||"").localeCompare(String(b?.nombre||""),"es"));o.programas=y;const M=y.map(x=>x?.nombre).filter(Boolean).join(", ");return o.programa_nombre=String(o.programa_nombre||M||""),o});s(D),w(v)})(),await P.current.main}catch{_("Error al cargar los datos"),f.fire({icon:"error",title:"Error",text:"Error al cargar los datos"})}finally{E(!1),P.current.main=null}},X=async(a,r)=>{try{let t=await C.put(I.estudiante.habilitar,{id:a,identificacion:r});return t?.data?.success||(t=await C.post(I.estudiante.habilitar,{id:a,identificacion:r})),t?.data?.success?(f.fire({icon:"success",title:"¡Éxito!",text:t?.data?.mensaje||t?.data?.message||"Estudiante habilitado",timer:1500,showConfirmButton:!1}),L(),!0):(f.fire({icon:"warning",title:"Advertencia",text:t?.data?.message||"No se pudo habilitar al estudiante"}),!1)}catch(t){return f.fire({icon:"error",title:"Error",text:t?.response?.data?.message||"Error al procesar la solicitud"}),!1}};p.useEffect(()=>{if(!U.current)return U.current=!0,L(),()=>{B.current.estudiantes?.abort(),B.current.programas?.abort()}},[]);const z=async a=>{try{const r=await C.post(I.estudiante.agregar,{nombre:a.nombre,email:a.email,identificacion:a.identificacion,programa_id:Number(a.programaId)});return r?.data?.success?(f.fire({icon:"success",title:"¡Éxito!",text:r?.data?.mensaje||"Estudiante agregado",timer:1500,showConfirmButton:!1}),L(),!0):(f.fire({icon:"warning",title:"Advertencia",text:r?.data?.message||"Error al agregar estudiante"}),!1)}catch{return f.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},H=async()=>{if(d.length===0)return f.fire({icon:"info",title:"Información",text:"No hay estudiantes para eliminar"}),!1;if(!(await f.fire({title:"¿Eliminar TODOS los estudiantes?",html:`
        <p>Esta acción eliminará <strong>${d.length} estudiante(s)</strong>.</p>
        <p><strong>¡Esta acción no se puede deshacer!</strong></p>
        <p>¿Está absolutamente seguro?</p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar todos",cancelButtonText:"Cancelar",focusCancel:!0,input:"text",inputPlaceholder:'Escriba "ELIMINAR" para confirmar',inputValidator:r=>{if(r!=="ELIMINAR")return'Debe escribir "ELIMINAR" para confirmar'}})).isConfirmed)return!1;try{const r=l?.id||"",n=await(await C.get(`${I.estudiante.base}?eliminar_todos=true&usuario_id=${r}`)).data;return n.success?(f.fire({icon:"success",title:"¡Éxito!",text:n.mensaje||`${n.eliminados} estudiante(s) eliminado(s)`,timer:2e3,showConfirmButton:!1}),L(),!0):(f.fire({icon:"warning",title:"Advertencia",text:n.mensaje||"Error al eliminar estudiantes"}),!1)}catch{return f.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},J=a=>{const r=a,t=r?.estado??r?.habilitado??r?.activo??r?.is_active??r?.status;if(typeof t=="boolean")return t;if(typeof t=="number")return t===1;if(typeof t=="string"){const n=t.toLowerCase();return n==="1"||n==="activo"||n==="activa"||n==="habilitado"||n==="habilitada"||n==="true"}return!0},K=d.filter(a=>{const r=c.toLowerCase(),t=(a.programa_nombre||(a.programas||[]).map(h=>h.nombre).join(", ")).toLowerCase(),n=a.nombre.toLowerCase().includes(r)||a.email.toLowerCase().includes(r)||a.identificacion.toLowerCase().includes(r)||t.includes(r),v=J(a);return n&&(S==="todos"||S==="activos"&&v||S==="inactivos"&&!v)});return{estudiantes:d,programas:g,loading:i,error:j,busqueda:c,setBusqueda:F,estadoFiltro:S,setEstadoFiltro:$,selectedFileName:q,setSelectedFileName:T,fileInputRef:O,cargarDatos:L,agregarEstudiante:z,habilitarEstudiante:X,eliminarTodosEstudiantes:H,importarEstudiantes:async a=>{try{const r=a.name.split(".").pop()?.toLowerCase(),t=r==="xlsx"||r==="xls";if(!t&&!(r==="csv"))throw new Error("Formato no soportado. Use un archivo .xlsx, .xls o .csv");const v=document.getElementById("programaId"),D=v?Number(v.value):void 0,h=await new Promise((x,b)=>{const u=new FileReader;u.onerror=()=>b(new Error("No se pudo leer el archivo")),u.onload=()=>x(u.result),t?u.readAsArrayBuffer(a):u.readAsText(a)});let o=[];if(t){const x=await W(()=>import("./xlsx-DLvP5s0v.js"),[]),b=x.read(h,{type:"array"}),u=b.SheetNames[0],R=b.Sheets[u];o=x.utils.sheet_to_json(R,{defval:""}).map(m=>({nombre:String(m.nombre??m.Nombre??m.NOMBRE??"").trim(),email:String(m.email??m.Correo??m.EMAIL??"").trim(),identificacion:String(m.identificacion??m.ID??m.cedula??m.Cédula??"").trim()})).filter(m=>m.nombre&&m.email&&m.identificacion)}else{const b=new TextDecoder().decode(h).split(/\r?\n/).filter(A=>A.trim().length>0),u=(b.shift()||"").split(",").map(A=>A.trim().toLowerCase()),R=u.indexOf("nombre"),G=u.indexOf("email"),m=u.indexOf("identificacion");o=b.map(A=>{const V=A.split(",");return{nombre:String(V[R]||"").trim(),email:String(V[G]||"").trim(),identificacion:String(V[m]||"").trim()}}).filter(A=>A.nombre&&A.email&&A.identificacion)}if(!o.length)throw new Error("No se encontraron estudiantes válidos en el archivo");const N={estudiantes:o};D&&!isNaN(D)&&(N.programa_id=D);let y=await C.post(I.estudiante.agregarAll,N,{headers:{"Content-Type":"application/json"}}).catch(async x=>{const b=x?.response?.status;if(b===400||b===415){const u=new FormData;N.programa_id&&u.append("programa_id",String(N.programa_id)),u.append("estudiantes",JSON.stringify(N.estudiantes));try{return await C.post(I.estudiante.agregarAll,u)}catch(R){throw R}}throw x});const M=y&&y.status>=200&&y.status<300&&(y?.data?.error===void 0||y?.data?.error===!1);if(y?.data?.success||M)return f.fire({icon:"success",title:"¡Éxito!",text:y?.data?.message||"Estudiantes importados",timer:1500,showConfirmButton:!1}),L(),T(""),O.current&&(O.current.value=""),!0;throw new Error(y?.data?.message||"Error al importar estudiantes")}catch(r){const t=r?.response?.data?.message||r?.response?.data?.error;return f.fire({icon:"error",title:"Error",text:t||r.message||"Error al importar estudiantes"}),!1}},handleFileChange:a=>{a.target.files&&a.target.files.length>0?T(a.target.files[0].name):T("")},estudiantesFiltrados:K}},le=({titulo:l="Estudiantes",backUrl:d="/asignar",onBack:s})=>{const g=Y(),w=()=>{s?s():g(d)};return e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h2",{className:"h4 mb-0 d-flex align-items-center gap-2",children:[e.jsx(Z,{})," ",l]}),e.jsx("div",{children:e.jsxs("button",{className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:w,type:"button",children:[e.jsx(ee,{})," Volver"]})})]})},ce=({programas:l,onSubmit:d})=>{const{register:s,handleSubmit:g,reset:w,formState:{errors:i},setValue:E}=ne({defaultValues:{nombre:"",email:"",identificacion:"",programaId:""}}),j=p.useMemo(()=>(l||[]).filter(c=>{const F=Number(c?.id)===99,S=typeof c?.nombre=="string"&&/\bgeneral\b/i.test(c.nombre);return!(F||S)}),[l]);p.useEffect(()=>{j.length===1?E("programaId",String(j[0].id)):j.length===0&&E("programaId","")},[j,E]);const _=c=>{d(c,()=>w())};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(re,{})," Agregar"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:g(_),autoComplete:"off",className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"nombre",className:"form-label",children:"Nombre:"}),e.jsx("input",{type:"text",id:"nombre",className:`form-control ${i.nombre?"is-invalid":""}`,placeholder:"Nombre completo",...s("nombre",{required:"El nombre es requerido",minLength:{value:2,message:"Mínimo 2 caracteres"}})}),i.nombre&&e.jsx("div",{className:"form-text text-danger",children:i.nombre.message})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"email",className:"form-label",children:"Email:"}),e.jsx("input",{type:"email",id:"email",className:`form-control ${i.email?"is-invalid":""}`,placeholder:"correo@dominio.com",...s("email",{required:"El email es requerido",pattern:{value:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"Email no válido"}})}),i.email&&e.jsx("div",{className:"form-text text-danger",children:i.email.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"identificacion",className:"form-label",children:"ID:"}),e.jsx("input",{type:"text",id:"identificacion",className:`form-control ${i.identificacion?"is-invalid":""}`,placeholder:"Documento de identidad",...s("identificacion",{required:"La identificación es requerida",minLength:{value:3,message:"Mínimo 3 caracteres"}})}),i.identificacion&&e.jsx("div",{className:"form-text text-danger",children:i.identificacion.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"programaId",className:"form-label",children:"Programa:"}),e.jsxs("select",{id:"programaId",className:`form-select ${i.programaId?"is-invalid":""}`,...s("programaId",{required:"El programa es requerido"}),disabled:j.length===1,children:[j.length!==1&&e.jsx("option",{value:"",children:"-- Seleccione --"}),j.map(c=>{const F=[c.nombre,c.nivel_nombre&&String(c.nivel_nombre).trim(),c.campus_nombre&&String(c.campus_nombre).trim()].filter(Boolean).join(" - ");return e.jsx("option",{value:c.id,children:F},c.id)})]}),i.programaId&&e.jsx("div",{className:"form-text text-danger",children:i.programaId.message})]}),e.jsx("div",{className:"col-12",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(ae,{className:"me-2"})," Guardar"]})})]})})]})},de=({fileInputRef:l,selectedFileName:d,handleFileChange:s,onImportar:g})=>{const w=i=>{i.preventDefault(),l.current?.files&&l.current.files.length>0&&g(l.current.files[0])};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4 mt-3",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(te,{})," Importar Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:w,className:"row g-3 align-items-end",children:[e.jsxs("div",{className:"col-12 col-md",children:[e.jsx("label",{className:"form-label mb-1",children:"Formato"}),e.jsx("div",{className:"text-muted small",children:"nombre, email, ID, programa"})]}),e.jsxs("div",{className:"col-12 col-md-auto",children:[e.jsx("label",{htmlFor:"archivo_estudiantes",className:"form-label",children:"Archivo"}),e.jsx("input",{type:"file",id:"archivo_estudiantes",ref:l,accept:".csv,.xlsx,.xls",className:"form-control",onChange:s}),e.jsx("div",{className:"form-text",children:d||"Seleccionar"})]}),e.jsx("div",{className:"col-12 col-md-auto",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(se,{})," Importar"]})})]})})]})},me=({value:l,onChange:d,placeholder:s="Buscar..."})=>e.jsxs("div",{className:"position-relative",style:{minWidth:"220px"},children:[e.jsx("input",{type:"text",placeholder:s,className:"form-control pe-5",value:l,onChange:d}),e.jsx(ie,{className:"position-absolute text-secondary",style:{right:10,top:"50%",transform:"translateY(-50%)"}})]}),ue=({estudiantes:l})=>{if(l.length===0)return e.jsx("div",{className:"alert alert-warning mb-0",children:"Sin estudiantes registrados."});const d=s=>{const g=(s.programas||[]).slice();return g.length>0?(g.sort((i,E)=>String(i?.nombre||"").localeCompare(String(E?.nombre||""),"es")),e.jsx("div",{className:"d-flex flex-wrap gap-1",children:g.map(i=>e.jsx("span",{className:"badge text-bg-primary",children:i.nombre},`${s.id}-${i.id}`))})):(s.programa_nombre||"").trim()||"—"};return e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Programa"})]})}),e.jsx("tbody",{children:l.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.nombre}),e.jsx("td",{children:s.email}),e.jsx("td",{children:s.identificacion}),e.jsx("td",{children:d(s)})]},s.id))})]})})},Ne=()=>{const{estudiantesFiltrados:l,programas:d,loading:s,error:g,busqueda:w,setBusqueda:i,selectedFileName:E,fileInputRef:j,agregarEstudiante:_,importarEstudiantes:c,handleFileChange:F}=oe();return s?e.jsx(k,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-primary mb-2",role:"status"}),e.jsx("p",{className:"text-muted mb-0",children:"Cargando..."})]})})}):g?e.jsx(k,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsx("div",{className:"alert alert-danger mb-0",role:"alert",children:g})})}):e.jsx(k,{children:e.jsx("div",{className:"container-fluid py-3 bg-light min-vh-100",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xxl-11",children:[e.jsx(le,{}),e.jsxs("div",{className:"row g-3 mt-1",children:[e.jsxs("div",{className:"col-12 col-lg-5 d-flex flex-column gap-3",children:[e.jsx(ce,{programas:d,onSubmit:(S,$)=>{_(S).then(q=>{q&&$()})}}),e.jsx(de,{fileInputRef:j,selectedFileName:E,handleFileChange:F,onImportar:c})]}),e.jsxs("div",{className:"col-12 col-lg-7",children:[e.jsx("div",{className:"d-flex flex-wrap gap-2 justify-content-end align-items-center mb-3",children:e.jsx(me,{value:w,onChange:S=>i(S.target.value)})}),e.jsx("div",{className:"card border-0 shadow-sm rounded-4",children:e.jsx("div",{className:"card-body p-0",children:e.jsx(ue,{estudiantes:l})})})]})]})]})})})})};export{Ne as default};
