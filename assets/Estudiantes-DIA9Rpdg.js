import{r as x,b as j,A as v,S as m,_ as z,a as G,j as e}from"./index-D_5yPiNa.js";import{P as R}from"./PageTransition-DiW9MPnf.js";import{u as K}from"./useAuthentication-ByJgdbzj.js";import{z as W,m as Y,H as Q,I as Z,J as ee,K as te,L as ae}from"./index-BCRNc57j.js";import{u as se}from"./index.esm-DiO9pYnW.js";import"./iconBase-DP8UkxFN.js";const re=()=>{const{user:r}=K(),[n,c]=x.useState([]),[u,g]=x.useState([]),[o,S]=x.useState(!0),[I,f]=x.useState(null),[L,P]=x.useState(""),[N,q]=x.useState("todos"),[T,B]=x.useState(""),$=x.useRef(null),C=async()=>{try{S(!0),f(null);const[s,t]=await Promise.all([j.get(v.estudiante.base).catch(w=>{if(w?.response?.status===404)return{data:{estudiantes:[]}};throw w}),j.get(v.programas.base)]);let a=s?.data?.estudiantes??[];const i=t?.data?.data??t?.data;let p=[];if(Array.isArray(i?.programas)?p=i.programas:Array.isArray(i?.programa)?p=i.programa:i?.programa&&typeof i.programa=="object"?p=[i.programa]:Array.isArray(t?.data)&&(p=t?.data),!a.length)try{const w=r?.id||"",F=await j.get(`${v.estudiante.base}?usuario_id=${w}`);Array.isArray(F?.data?.data?.estudiantes)&&(a=F.data.data.estudiantes)}catch{}c(a),g(p)}catch{f("Error al cargar los datos"),m.fire({icon:"error",title:"Error",text:"Error al cargar los datos"})}finally{S(!1)}},k=async(s,t)=>{try{let a=await j.put(v.estudiante.habilitar,{id:s,identificacion:t});return a?.data?.success||(a=await j.post(v.estudiante.habilitar,{id:s,identificacion:t})),a?.data?.success?(m.fire({icon:"success",title:"¡Éxito!",text:a?.data?.mensaje||a?.data?.message||"Estudiante habilitado",timer:1500,showConfirmButton:!1}),C(),!0):(m.fire({icon:"warning",title:"Advertencia",text:a?.data?.message||"No se pudo habilitar al estudiante"}),!1)}catch(a){return m.fire({icon:"error",title:"Error",text:a?.response?.data?.message||"Error al procesar la solicitud"}),!1}};x.useEffect(()=>{C()},[]);const V=async s=>{try{const t=await j.post(v.estudiante.agregar,{nombre:s.nombre,email:s.email,identificacion:s.identificacion,programa_id:Number(s.programaId)});return t?.data?.success?(m.fire({icon:"success",title:"¡Éxito!",text:t?.data?.mensaje||"Estudiante agregado",timer:1500,showConfirmButton:!1}),C(),!0):(m.fire({icon:"warning",title:"Advertencia",text:t?.data?.message||"Error al agregar estudiante"}),!1)}catch{return m.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},U=async()=>{if(n.length===0)return m.fire({icon:"info",title:"Información",text:"No hay estudiantes para eliminar"}),!1;if(!(await m.fire({title:"¿Eliminar TODOS los estudiantes?",html:`
        <p>Esta acción eliminará <strong>${n.length} estudiante(s)</strong>.</p>
        <p><strong>¡Esta acción no se puede deshacer!</strong></p>
        <p>¿Está absolutamente seguro?</p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar todos",cancelButtonText:"Cancelar",focusCancel:!0,input:"text",inputPlaceholder:'Escriba "ELIMINAR" para confirmar',inputValidator:t=>{if(t!=="ELIMINAR")return'Debe escribir "ELIMINAR" para confirmar'}})).isConfirmed)return!1;try{const t=r?.id||"",i=await(await j.get(`${v.estudiante.base}?eliminar_todos=true&usuario_id=${t}`)).data;return i.success?(m.fire({icon:"success",title:"¡Éxito!",text:i.mensaje||`${i.eliminados} estudiante(s) eliminado(s)`,timer:2e3,showConfirmButton:!1}),C(),!0):(m.fire({icon:"warning",title:"Advertencia",text:i.mensaje||"Error al eliminar estudiantes"}),!1)}catch{return m.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},H=s=>{const t=s,a=t?.estado??t?.habilitado??t?.activo??t?.is_active??t?.status;if(typeof a=="boolean")return a;if(typeof a=="number")return a===1;if(typeof a=="string"){const i=a.toLowerCase();return i==="1"||i==="activo"||i==="activa"||i==="habilitado"||i==="habilitada"||i==="true"}return!0},J=n.filter(s=>{const t=L.toLowerCase(),a=s.nombre.toLowerCase().includes(t)||s.email.toLowerCase().includes(t)||s.identificacion.toLowerCase().includes(t)||s.programa_nombre.toLowerCase().includes(t),i=H(s);return a&&(N==="todos"||N==="activos"&&i||N==="inactivos"&&!i)});return{estudiantes:n,programas:u,loading:o,error:I,busqueda:L,setBusqueda:P,estadoFiltro:N,setEstadoFiltro:q,selectedFileName:T,setSelectedFileName:B,fileInputRef:$,cargarDatos:C,agregarEstudiante:V,habilitarEstudiante:k,eliminarTodosEstudiantes:U,importarEstudiantes:async s=>{try{const t=s.name.split(".").pop()?.toLowerCase(),a=t==="xlsx"||t==="xls";if(!a&&!(t==="csv"))throw new Error("Formato no soportado. Use un archivo .xlsx, .xls o .csv");const p=document.getElementById("programaId"),w=p?Number(p.value):void 0,F=await new Promise((E,h)=>{const d=new FileReader;d.onerror=()=>h(new Error("No se pudo leer el archivo")),d.onload=()=>E(d.result),a?d.readAsArrayBuffer(s):d.readAsText(s)});let D=[];if(a){const E=await z(()=>import("./xlsx-DLvP5s0v.js"),[]),h=E.read(F,{type:"array"}),d=h.SheetNames[0],_=h.Sheets[d];D=E.utils.sheet_to_json(_,{defval:""}).map(l=>({nombre:String(l.nombre??l.Nombre??l.NOMBRE??"").trim(),email:String(l.email??l.Correo??l.EMAIL??"").trim(),identificacion:String(l.identificacion??l.ID??l.cedula??l.Cédula??"").trim()})).filter(l=>l.nombre&&l.email&&l.identificacion)}else{const h=new TextDecoder().decode(F).split(/\r?\n/).filter(b=>b.trim().length>0),d=(h.shift()||"").split(",").map(b=>b.trim().toLowerCase()),_=d.indexOf("nombre"),M=d.indexOf("email"),l=d.indexOf("identificacion");D=h.map(b=>{const O=b.split(",");return{nombre:String(O[_]||"").trim(),email:String(O[M]||"").trim(),identificacion:String(O[l]||"").trim()}}).filter(b=>b.nombre&&b.email&&b.identificacion)}if(!D.length)throw new Error("No se encontraron estudiantes válidos en el archivo");const A={estudiantes:D};w&&!isNaN(w)&&(A.programa_id=w);let y=await j.post(v.estudiante.agregarAll,A,{headers:{"Content-Type":"application/json"}}).catch(async E=>{const h=E?.response?.status;if(h===400||h===415){const d=new FormData;A.programa_id&&d.append("programa_id",String(A.programa_id)),d.append("estudiantes",JSON.stringify(A.estudiantes));try{return await j.post(v.estudiante.agregarAll,d)}catch(_){throw _}}throw E});const X=y&&y.status>=200&&y.status<300&&(y?.data?.error===void 0||y?.data?.error===!1);if(y?.data?.success||X)return m.fire({icon:"success",title:"¡Éxito!",text:y?.data?.message||"Estudiantes importados",timer:1500,showConfirmButton:!1}),C(),B(""),$.current&&($.current.value=""),!0;throw new Error(y?.data?.message||"Error al importar estudiantes")}catch(t){const a=t?.response?.data?.message||t?.response?.data?.error;return m.fire({icon:"error",title:"Error",text:a||t.message||"Error al importar estudiantes"}),!1}},handleFileChange:s=>{s.target.files&&s.target.files.length>0?B(s.target.files[0].name):B("")},estudiantesFiltrados:J}},ie=({titulo:r="Estudiantes",backUrl:n="/asignar",onBack:c})=>{const u=G(),g=()=>{c?c():u(n)};return e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h2",{className:"h4 mb-0 d-flex align-items-center gap-2",children:[e.jsx(W,{})," ",r]}),e.jsx("div",{children:e.jsxs("button",{className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:g,type:"button",children:[e.jsx(Y,{})," Volver"]})})]})},ne=({programas:r,onSubmit:n})=>{const{register:c,handleSubmit:u,reset:g,formState:{errors:o},setValue:S}=se({defaultValues:{nombre:"",email:"",identificacion:"",programaId:""}});x.useEffect(()=>{r.length===1&&S("programaId",String(r[0].id))},[r,S]);const I=f=>{n(f,()=>g())};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(Q,{})," Agregar"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:u(I),autoComplete:"off",className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"nombre",className:"form-label",children:"Nombre:"}),e.jsx("input",{type:"text",id:"nombre",className:`form-control ${o.nombre?"is-invalid":""}`,placeholder:"Nombre completo",...c("nombre",{required:"El nombre es requerido",minLength:{value:2,message:"Mínimo 2 caracteres"}})}),o.nombre&&e.jsx("div",{className:"form-text text-danger",children:o.nombre.message})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"email",className:"form-label",children:"Email:"}),e.jsx("input",{type:"email",id:"email",className:`form-control ${o.email?"is-invalid":""}`,placeholder:"correo@dominio.com",...c("email",{required:"El email es requerido",pattern:{value:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"Email no válido"}})}),o.email&&e.jsx("div",{className:"form-text text-danger",children:o.email.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"identificacion",className:"form-label",children:"ID:"}),e.jsx("input",{type:"text",id:"identificacion",className:`form-control ${o.identificacion?"is-invalid":""}`,placeholder:"Documento de identidad",...c("identificacion",{required:"La identificación es requerida",minLength:{value:3,message:"Mínimo 3 caracteres"}})}),o.identificacion&&e.jsx("div",{className:"form-text text-danger",children:o.identificacion.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"programaId",className:"form-label",children:"Programa:"}),e.jsxs("select",{id:"programaId",className:`form-select ${o.programaId?"is-invalid":""}`,...c("programaId",{required:"El programa es requerido"}),disabled:r.length===1,children:[r.length!==1&&e.jsx("option",{value:"",children:"-- Seleccione --"}),r.map(f=>e.jsx("option",{value:f.id,children:f.nombre},f.id))]}),o.programaId&&e.jsx("div",{className:"form-text text-danger",children:o.programaId.message})]}),e.jsx("div",{className:"col-12",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(Z,{className:"me-2"})," Guardar"]})})]})})]})},oe=({fileInputRef:r,selectedFileName:n,handleFileChange:c,onImportar:u})=>{const g=o=>{o.preventDefault(),r.current?.files&&r.current.files.length>0&&u(r.current.files[0])};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4 mt-3",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(ee,{})," Importar Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:g,className:"row g-3 align-items-end",children:[e.jsxs("div",{className:"col-12 col-md",children:[e.jsx("label",{className:"form-label mb-1",children:"Formato"}),e.jsx("div",{className:"text-muted small",children:"nombre, email, ID, programa"})]}),e.jsxs("div",{className:"col-12 col-md-auto",children:[e.jsx("label",{htmlFor:"archivo_estudiantes",className:"form-label",children:"Archivo"}),e.jsx("input",{type:"file",id:"archivo_estudiantes",ref:r,accept:".csv,.xlsx,.xls",className:"form-control",onChange:c}),e.jsx("div",{className:"form-text",children:n||"Seleccionar"})]}),e.jsx("div",{className:"col-12 col-md-auto",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(te,{})," Importar"]})})]})})]})},le=({value:r,onChange:n,placeholder:c="Buscar..."})=>e.jsxs("div",{className:"position-relative",style:{minWidth:"220px"},children:[e.jsx("input",{type:"text",placeholder:c,className:"form-control pe-5",value:r,onChange:n}),e.jsx(ae,{className:"position-absolute text-secondary",style:{right:10,top:"50%",transform:"translateY(-50%)"}})]}),ce=({estudiantes:r})=>r.length===0?e.jsx("div",{className:"alert alert-warning mb-0",children:"Sin estudiantes registrados."}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Programa"})]})}),e.jsx("tbody",{children:r.map(n=>e.jsxs("tr",{children:[e.jsx("td",{children:n.nombre}),e.jsx("td",{children:n.email}),e.jsx("td",{children:n.identificacion}),e.jsx("td",{children:n.programa_nombre})]},n.id))})]})}),be=()=>{const{estudiantesFiltrados:r,programas:n,loading:c,error:u,busqueda:g,setBusqueda:o,selectedFileName:S,fileInputRef:I,agregarEstudiante:f,importarEstudiantes:L,handleFileChange:P}=re();return c?e.jsx(R,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-primary mb-2",role:"status"}),e.jsx("p",{className:"text-muted mb-0",children:"Cargando..."})]})})}):u?e.jsx(R,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsx("div",{className:"alert alert-danger mb-0",role:"alert",children:u})})}):e.jsx(R,{children:e.jsx("div",{className:"container-fluid py-3 bg-light min-vh-100",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xxl-11",children:[e.jsx(ie,{}),e.jsxs("div",{className:"row g-3 mt-1",children:[e.jsxs("div",{className:"col-12 col-lg-5 d-flex flex-column gap-3",children:[e.jsx(ne,{programas:n,onSubmit:(N,q)=>{f(N).then(T=>{T&&q()})}}),e.jsx(oe,{fileInputRef:I,selectedFileName:S,handleFileChange:P,onImportar:L})]}),e.jsxs("div",{className:"col-12 col-lg-7",children:[e.jsx("div",{className:"d-flex flex-wrap gap-2 justify-content-end align-items-center mb-3",children:e.jsx(le,{value:g,onChange:N=>o(N.target.value)})}),e.jsx("div",{className:"card border-0 shadow-sm rounded-4",children:e.jsx("div",{className:"card-body p-0",children:e.jsx(ce,{estudiantes:r})})})]})]})]})})})})};export{be as default};
