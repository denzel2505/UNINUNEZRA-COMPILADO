import{r as f,b as v,A as N,S as u,_ as W,a as Y,j as e}from"./index-CkH1TajL.js";import{P as k}from"./PageTransition-Co3V1ZrG.js";import{u as Q}from"./useAuthentication-weheBjpg.js";import{z as Z,m as ee,H as te,I as ae,J as re,K as se,L as ie}from"./index-DTaE7NR5.js";import{u as ne}from"./index.esm-DYjrEONH.js";import"./iconBase-DH91qiyX.js";const oe=()=>{const{user:s}=Q(),[n,c]=f.useState([]),[h,p]=f.useState([]),[o,S]=f.useState(!0),[F,m]=f.useState(null),[C,q]=f.useState(""),[w,T]=f.useState("todos"),[$,P]=f.useState(""),O=f.useRef(null),V=f.useRef(!1),_=f.useRef({main:null}),I=f.useRef({}),A=async()=>{try{if(_.current.main){await _.current.main;return}I.current.estudiantes?.abort(),I.current.programas?.abort(),I.current.estudiantes=new AbortController,I.current.programas=new AbortController,S(!0),m(null),_.current.main=(async()=>{const[r,t]=await Promise.all([v.get(N.estudiante.base).catch(x=>{if(x?.response?.status===404)return{data:{estudiantes:[]}};throw x?.name==="CanceledError",x}),v.get(N.programas.base)]);let a=r?.data?.estudiantes??[];const i=t?.data?.data??t?.data;let b=[];if(Array.isArray(i?.programas)?b=i.programas:Array.isArray(i?.programa)?b=i.programa:i?.programa&&typeof i.programa=="object"?b=[i.programa]:Array.isArray(t?.data)&&(b=t?.data),!a.length)try{const x=s?.id||"",L=await v.get(`${N.estudiante.base}?usuario_id=${x}`);Array.isArray(L?.data?.data?.estudiantes)&&(a=L.data.data.estudiantes)}catch{}c(a),p(b)})(),await _.current.main}catch{m("Error al cargar los datos"),u.fire({icon:"error",title:"Error",text:"Error al cargar los datos"})}finally{S(!1),_.current.main=null}},H=async(r,t)=>{try{let a=await v.put(N.estudiante.habilitar,{id:r,identificacion:t});return a?.data?.success||(a=await v.post(N.estudiante.habilitar,{id:r,identificacion:t})),a?.data?.success?(u.fire({icon:"success",title:"¡Éxito!",text:a?.data?.mensaje||a?.data?.message||"Estudiante habilitado",timer:1500,showConfirmButton:!1}),A(),!0):(u.fire({icon:"warning",title:"Advertencia",text:a?.data?.message||"No se pudo habilitar al estudiante"}),!1)}catch(a){return u.fire({icon:"error",title:"Error",text:a?.response?.data?.message||"Error al procesar la solicitud"}),!1}};f.useEffect(()=>{if(!V.current)return V.current=!0,A(),()=>{I.current.estudiantes?.abort(),I.current.programas?.abort()}},[]);const J=async r=>{try{const t=await v.post(N.estudiante.agregar,{nombre:r.nombre,email:r.email,identificacion:r.identificacion,programa_id:Number(r.programaId)});return t?.data?.success?(u.fire({icon:"success",title:"¡Éxito!",text:t?.data?.mensaje||"Estudiante agregado",timer:1500,showConfirmButton:!1}),A(),!0):(u.fire({icon:"warning",title:"Advertencia",text:t?.data?.message||"Error al agregar estudiante"}),!1)}catch{return u.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},X=async()=>{if(n.length===0)return u.fire({icon:"info",title:"Información",text:"No hay estudiantes para eliminar"}),!1;if(!(await u.fire({title:"¿Eliminar TODOS los estudiantes?",html:`
        <p>Esta acción eliminará <strong>${n.length} estudiante(s)</strong>.</p>
        <p><strong>¡Esta acción no se puede deshacer!</strong></p>
        <p>¿Está absolutamente seguro?</p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar todos",cancelButtonText:"Cancelar",focusCancel:!0,input:"text",inputPlaceholder:'Escriba "ELIMINAR" para confirmar',inputValidator:t=>{if(t!=="ELIMINAR")return'Debe escribir "ELIMINAR" para confirmar'}})).isConfirmed)return!1;try{const t=s?.id||"",i=await(await v.get(`${N.estudiante.base}?eliminar_todos=true&usuario_id=${t}`)).data;return i.success?(u.fire({icon:"success",title:"¡Éxito!",text:i.mensaje||`${i.eliminados} estudiante(s) eliminado(s)`,timer:2e3,showConfirmButton:!1}),A(),!0):(u.fire({icon:"warning",title:"Advertencia",text:i.mensaje||"Error al eliminar estudiantes"}),!1)}catch{return u.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},z=r=>{const t=r,a=t?.estado??t?.habilitado??t?.activo??t?.is_active??t?.status;if(typeof a=="boolean")return a;if(typeof a=="number")return a===1;if(typeof a=="string"){const i=a.toLowerCase();return i==="1"||i==="activo"||i==="activa"||i==="habilitado"||i==="habilitada"||i==="true"}return!0},G=n.filter(r=>{const t=C.toLowerCase(),a=r.nombre.toLowerCase().includes(t)||r.email.toLowerCase().includes(t)||r.identificacion.toLowerCase().includes(t)||r.programa_nombre.toLowerCase().includes(t),i=z(r);return a&&(w==="todos"||w==="activos"&&i||w==="inactivos"&&!i)});return{estudiantes:n,programas:h,loading:o,error:F,busqueda:C,setBusqueda:q,estadoFiltro:w,setEstadoFiltro:T,selectedFileName:$,setSelectedFileName:P,fileInputRef:O,cargarDatos:A,agregarEstudiante:J,habilitarEstudiante:H,eliminarTodosEstudiantes:X,importarEstudiantes:async r=>{try{const t=r.name.split(".").pop()?.toLowerCase(),a=t==="xlsx"||t==="xls";if(!a&&!(t==="csv"))throw new Error("Formato no soportado. Use un archivo .xlsx, .xls o .csv");const b=document.getElementById("programaId"),x=b?Number(b.value):void 0,L=await new Promise((E,g)=>{const d=new FileReader;d.onerror=()=>g(new Error("No se pudo leer el archivo")),d.onload=()=>E(d.result),a?d.readAsArrayBuffer(r):d.readAsText(r)});let R=[];if(a){const E=await W(()=>import("./xlsx-DLvP5s0v.js"),[]),g=E.read(L,{type:"array"}),d=g.SheetNames[0],D=g.Sheets[d];R=E.utils.sheet_to_json(D,{defval:""}).map(l=>({nombre:String(l.nombre??l.Nombre??l.NOMBRE??"").trim(),email:String(l.email??l.Correo??l.EMAIL??"").trim(),identificacion:String(l.identificacion??l.ID??l.cedula??l.Cédula??"").trim()})).filter(l=>l.nombre&&l.email&&l.identificacion)}else{const g=new TextDecoder().decode(L).split(/\r?\n/).filter(j=>j.trim().length>0),d=(g.shift()||"").split(",").map(j=>j.trim().toLowerCase()),D=d.indexOf("nombre"),U=d.indexOf("email"),l=d.indexOf("identificacion");R=g.map(j=>{const M=j.split(",");return{nombre:String(M[D]||"").trim(),email:String(M[U]||"").trim(),identificacion:String(M[l]||"").trim()}}).filter(j=>j.nombre&&j.email&&j.identificacion)}if(!R.length)throw new Error("No se encontraron estudiantes válidos en el archivo");const B={estudiantes:R};x&&!isNaN(x)&&(B.programa_id=x);let y=await v.post(N.estudiante.agregarAll,B,{headers:{"Content-Type":"application/json"}}).catch(async E=>{const g=E?.response?.status;if(g===400||g===415){const d=new FormData;B.programa_id&&d.append("programa_id",String(B.programa_id)),d.append("estudiantes",JSON.stringify(B.estudiantes));try{return await v.post(N.estudiante.agregarAll,d)}catch(D){throw D}}throw E});const K=y&&y.status>=200&&y.status<300&&(y?.data?.error===void 0||y?.data?.error===!1);if(y?.data?.success||K)return u.fire({icon:"success",title:"¡Éxito!",text:y?.data?.message||"Estudiantes importados",timer:1500,showConfirmButton:!1}),A(),P(""),O.current&&(O.current.value=""),!0;throw new Error(y?.data?.message||"Error al importar estudiantes")}catch(t){const a=t?.response?.data?.message||t?.response?.data?.error;return u.fire({icon:"error",title:"Error",text:a||t.message||"Error al importar estudiantes"}),!1}},handleFileChange:r=>{r.target.files&&r.target.files.length>0?P(r.target.files[0].name):P("")},estudiantesFiltrados:G}},le=({titulo:s="Estudiantes",backUrl:n="/asignar",onBack:c})=>{const h=Y(),p=()=>{c?c():h(n)};return e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h2",{className:"h4 mb-0 d-flex align-items-center gap-2",children:[e.jsx(Z,{})," ",s]}),e.jsx("div",{children:e.jsxs("button",{className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:p,type:"button",children:[e.jsx(ee,{})," Volver"]})})]})},ce=({programas:s,onSubmit:n})=>{const{register:c,handleSubmit:h,reset:p,formState:{errors:o},setValue:S}=ne({defaultValues:{nombre:"",email:"",identificacion:"",programaId:""}});f.useEffect(()=>{s.length===1&&S("programaId",String(s[0].id))},[s,S]);const F=m=>{n(m,()=>p())};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(te,{})," Agregar"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:h(F),autoComplete:"off",className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"nombre",className:"form-label",children:"Nombre:"}),e.jsx("input",{type:"text",id:"nombre",className:`form-control ${o.nombre?"is-invalid":""}`,placeholder:"Nombre completo",...c("nombre",{required:"El nombre es requerido",minLength:{value:2,message:"Mínimo 2 caracteres"}})}),o.nombre&&e.jsx("div",{className:"form-text text-danger",children:o.nombre.message})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"email",className:"form-label",children:"Email:"}),e.jsx("input",{type:"email",id:"email",className:`form-control ${o.email?"is-invalid":""}`,placeholder:"correo@dominio.com",...c("email",{required:"El email es requerido",pattern:{value:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"Email no válido"}})}),o.email&&e.jsx("div",{className:"form-text text-danger",children:o.email.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"identificacion",className:"form-label",children:"ID:"}),e.jsx("input",{type:"text",id:"identificacion",className:`form-control ${o.identificacion?"is-invalid":""}`,placeholder:"Documento de identidad",...c("identificacion",{required:"La identificación es requerida",minLength:{value:3,message:"Mínimo 3 caracteres"}})}),o.identificacion&&e.jsx("div",{className:"form-text text-danger",children:o.identificacion.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"programaId",className:"form-label",children:"Programa:"}),e.jsxs("select",{id:"programaId",className:`form-select ${o.programaId?"is-invalid":""}`,...c("programaId",{required:"El programa es requerido"}),disabled:s.length===1,children:[s.length!==1&&e.jsx("option",{value:"",children:"-- Seleccione --"}),s.map(m=>{const C=[m.nombre,m.nivel_nombre&&String(m.nivel_nombre).trim(),m.campus_nombre&&String(m.campus_nombre).trim()].filter(Boolean).join(" - ");return e.jsx("option",{value:m.id,children:C},m.id)})]}),o.programaId&&e.jsx("div",{className:"form-text text-danger",children:o.programaId.message})]}),e.jsx("div",{className:"col-12",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(ae,{className:"me-2"})," Guardar"]})})]})})]})},de=({fileInputRef:s,selectedFileName:n,handleFileChange:c,onImportar:h})=>{const p=o=>{o.preventDefault(),s.current?.files&&s.current.files.length>0&&h(s.current.files[0])};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4 mt-3",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(re,{})," Importar Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:p,className:"row g-3 align-items-end",children:[e.jsxs("div",{className:"col-12 col-md",children:[e.jsx("label",{className:"form-label mb-1",children:"Formato"}),e.jsx("div",{className:"text-muted small",children:"nombre, email, ID, programa"})]}),e.jsxs("div",{className:"col-12 col-md-auto",children:[e.jsx("label",{htmlFor:"archivo_estudiantes",className:"form-label",children:"Archivo"}),e.jsx("input",{type:"file",id:"archivo_estudiantes",ref:s,accept:".csv,.xlsx,.xls",className:"form-control",onChange:c}),e.jsx("div",{className:"form-text",children:n||"Seleccionar"})]}),e.jsx("div",{className:"col-12 col-md-auto",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(se,{})," Importar"]})})]})})]})},me=({value:s,onChange:n,placeholder:c="Buscar..."})=>e.jsxs("div",{className:"position-relative",style:{minWidth:"220px"},children:[e.jsx("input",{type:"text",placeholder:c,className:"form-control pe-5",value:s,onChange:n}),e.jsx(ie,{className:"position-absolute text-secondary",style:{right:10,top:"50%",transform:"translateY(-50%)"}})]}),ue=({estudiantes:s})=>s.length===0?e.jsx("div",{className:"alert alert-warning mb-0",children:"Sin estudiantes registrados."}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Programa"})]})}),e.jsx("tbody",{children:s.map(n=>e.jsxs("tr",{children:[e.jsx("td",{children:n.nombre}),e.jsx("td",{children:n.email}),e.jsx("td",{children:n.identificacion}),e.jsx("td",{children:n.programa_nombre})]},n.id))})]})}),Ne=()=>{const{estudiantesFiltrados:s,programas:n,loading:c,error:h,busqueda:p,setBusqueda:o,selectedFileName:S,fileInputRef:F,agregarEstudiante:m,importarEstudiantes:C,handleFileChange:q}=oe();return c?e.jsx(k,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-primary mb-2",role:"status"}),e.jsx("p",{className:"text-muted mb-0",children:"Cargando..."})]})})}):h?e.jsx(k,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsx("div",{className:"alert alert-danger mb-0",role:"alert",children:h})})}):e.jsx(k,{children:e.jsx("div",{className:"container-fluid py-3 bg-light min-vh-100",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xxl-11",children:[e.jsx(le,{}),e.jsxs("div",{className:"row g-3 mt-1",children:[e.jsxs("div",{className:"col-12 col-lg-5 d-flex flex-column gap-3",children:[e.jsx(ce,{programas:n,onSubmit:(w,T)=>{m(w).then($=>{$&&T()})}}),e.jsx(de,{fileInputRef:F,selectedFileName:S,handleFileChange:q,onImportar:C})]}),e.jsxs("div",{className:"col-12 col-lg-7",children:[e.jsx("div",{className:"d-flex flex-wrap gap-2 justify-content-end align-items-center mb-3",children:e.jsx(me,{value:p,onChange:w=>o(w.target.value)})}),e.jsx("div",{className:"card border-0 shadow-sm rounded-4",children:e.jsx("div",{className:"card-body p-0",children:e.jsx(ue,{estudiantes:s})})})]})]})]})})})})};export{Ne as default};
