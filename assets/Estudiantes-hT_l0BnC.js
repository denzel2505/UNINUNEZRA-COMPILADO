import{r as x,b as S,A as C,S as g,_ as W,a as Y,j as e}from"./index-W0ZSjH-A.js";import{P as V}from"./PageTransition-DHV3GPNa.js";import{u as Q}from"./useAuthentication-MUtYQDm0.js";import{z as Z,m as ee,I as ae,J as te,K as re,L as se,M as ie}from"./index-DfAB-zHd.js";import{u as ne}from"./index.esm-iWwNpcbn.js";import"./iconBase-BFfBqceE.js";const oe=()=>{const{user:i}=Q(),[c,s]=x.useState([]),[u,y]=x.useState([]),[n,w]=x.useState(!0),[L,f]=x.useState(null),[I,T]=x.useState(""),[A,$]=x.useState("todos"),[q,R]=x.useState(""),O=x.useRef(null),U=x.useRef(!1),D=x.useRef({main:null}),F=x.useRef({}),_=async()=>{try{if(D.current.main){await D.current.main;return}F.current.estudiantes?.abort(),F.current.programas?.abort(),F.current.estudiantes=new AbortController,F.current.programas=new AbortController,w(!0),f(null),D.current.main=(async()=>{const[t,a]=await Promise.all([S.get(C.estudiante.base).catch(h=>{if(h?.response?.status===404)return{data:{estudiantes:[]}};throw h?.name==="CanceledError",h}),S.get(C.programas.base)]);let r=t?.data?.estudiantes??[];const o=a?.data?.data??a?.data;let j=[];if(Array.isArray(o?.programas)?j=o.programas:Array.isArray(o?.programa)?j=o.programa:o?.programa&&typeof o.programa=="object"?j=[o.programa]:Array.isArray(a?.data)&&(j=a?.data),!r.length)try{const h=i?.id||"",l=await S.get(`${C.estudiante.base}?usuario_id=${h}`);Array.isArray(l?.data?.data?.estudiantes)&&(r=l.data.data.estudiantes)}catch{}const B=r.map(h=>{const l={...h};let v=[];Array.isArray(l.programas)?v=l.programas:Array.isArray(l.programa)?v=l.programa:l.programa&&typeof l.programa=="object"?v=[l.programa]:Array.isArray(l.data?.programas)&&(v=l.data.programas);const N=[...v].sort((p,b)=>String(p?.nombre||"").localeCompare(String(b?.nombre||""),"es"));l.programas=N;const M=N.map(p=>p?.nombre).filter(Boolean).join(", ");return l.programa_nombre=String(l.programa_nombre||M||""),l});s(B),y(j)})(),await D.current.main}catch{f("Error al cargar los datos"),g.fire({icon:"error",title:"Error",text:"Error al cargar los datos"})}finally{w(!1),D.current.main=null}},J=async(t,a)=>{try{let r=await S.put(C.estudiante.habilitar,{id:t,identificacion:a});return r?.data?.success||(r=await S.post(C.estudiante.habilitar,{id:t,identificacion:a})),r?.data?.success?(g.fire({icon:"success",title:"¡Éxito!",text:r?.data?.mensaje||r?.data?.message||"Estudiante habilitado",timer:1500,showConfirmButton:!1}),_(),!0):(g.fire({icon:"warning",title:"Advertencia",text:r?.data?.message||"No se pudo habilitar al estudiante"}),!1)}catch(r){return g.fire({icon:"error",title:"Error",text:r?.response?.data?.message||"Error al procesar la solicitud"}),!1}};x.useEffect(()=>{if(!U.current)return U.current=!0,_(),()=>{F.current.estudiantes?.abort(),F.current.programas?.abort()}},[]);const X=async t=>{try{const a=await S.post(C.estudiante.agregar,{nombre:t.nombre,email:t.email,identificacion:t.identificacion,programa_id:Number(t.programaId)});return a?.data?.success?(g.fire({icon:"success",title:"¡Éxito!",text:a?.data?.mensaje||"Estudiante agregado",timer:1500,showConfirmButton:!1}),_(),!0):(g.fire({icon:"warning",title:"Advertencia",text:a?.data?.message||"Error al agregar estudiante"}),!1)}catch{return g.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},G=async()=>{if(c.length===0)return g.fire({icon:"info",title:"Información",text:"No hay estudiantes para eliminar"}),!1;if(!(await g.fire({title:"¿Eliminar TODOS los estudiantes?",html:`
        <p>Esta acción eliminará <strong>${c.length} estudiante(s)</strong>.</p>
        <p><strong>¡Esta acción no se puede deshacer!</strong></p>
        <p>¿Está absolutamente seguro?</p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar todos",cancelButtonText:"Cancelar",focusCancel:!0,input:"text",inputPlaceholder:'Escriba "ELIMINAR" para confirmar',inputValidator:a=>{if(a!=="ELIMINAR")return'Debe escribir "ELIMINAR" para confirmar'}})).isConfirmed)return!1;try{const a=i?.id||"",o=await(await S.get(`${C.estudiante.base}?eliminar_todos=true&usuario_id=${a}`)).data;return o.success?(g.fire({icon:"success",title:"¡Éxito!",text:o.mensaje||`${o.eliminados} estudiante(s) eliminado(s)`,timer:2e3,showConfirmButton:!1}),_(),!0):(g.fire({icon:"warning",title:"Advertencia",text:o.mensaje||"Error al eliminar estudiantes"}),!1)}catch{return g.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},H=t=>{const a=t,r=a?.estado??a?.habilitado??a?.activo??a?.is_active??a?.status;if(typeof r=="boolean")return r;if(typeof r=="number")return r===1;if(typeof r=="string"){const o=r.toLowerCase();return o==="1"||o==="activo"||o==="activa"||o==="habilitado"||o==="habilitada"||o==="true"}return!0},K=c.filter(t=>{const a=I.toLowerCase(),r=(t.programa_nombre||(t.programas||[]).map(h=>h.nombre).join(", ")).toLowerCase(),o=t.nombre.toLowerCase().includes(a)||t.email.toLowerCase().includes(a)||t.identificacion.toLowerCase().includes(a)||r.includes(a),j=H(t);return o&&(A==="todos"||A==="activos"&&j||A==="inactivos"&&!j)});return{estudiantes:c,programas:u,loading:n,error:L,busqueda:I,setBusqueda:T,estadoFiltro:A,setEstadoFiltro:$,selectedFileName:q,setSelectedFileName:R,fileInputRef:O,cargarDatos:_,agregarEstudiante:X,habilitarEstudiante:J,eliminarTodosEstudiantes:G,importarEstudiantes:async t=>{try{const a=t.name.split(".").pop()?.toLowerCase(),r=a==="xlsx"||a==="xls";if(!r&&!(a==="csv"))throw new Error("Formato no soportado. Use un archivo .xlsx, .xls o .csv");const j=document.getElementById("programaId"),B=j?Number(j.value):void 0,h=await new Promise((p,b)=>{const m=new FileReader;m.onerror=()=>b(new Error("No se pudo leer el archivo")),m.onload=()=>p(m.result),r?m.readAsArrayBuffer(t):m.readAsText(t)});let l=[];if(r){const p=await W(()=>import("./xlsx-DLvP5s0v.js"),[]),b=p.read(h,{type:"array"}),m=b.SheetNames[0],P=b.Sheets[m];l=p.utils.sheet_to_json(P,{defval:""}).map(d=>({nombre:String(d.nombre??d.Nombre??d.NOMBRE??"").trim(),email:String(d.email??d.Correo??d.EMAIL??"").trim(),identificacion:String(d.identificacion??d.ID??d.cedula??d.Cédula??"").trim()})).filter(d=>d.nombre&&d.email&&d.identificacion)}else{const b=new TextDecoder().decode(h).split(/\r?\n/).filter(E=>E.trim().length>0),m=(b.shift()||"").split(",").map(E=>E.trim().toLowerCase()),P=m.indexOf("nombre"),z=m.indexOf("email"),d=m.indexOf("identificacion");l=b.map(E=>{const k=E.split(",");return{nombre:String(k[P]||"").trim(),email:String(k[z]||"").trim(),identificacion:String(k[d]||"").trim()}}).filter(E=>E.nombre&&E.email&&E.identificacion)}if(!l.length)throw new Error("No se encontraron estudiantes válidos en el archivo");const v={estudiantes:l};B&&!isNaN(B)&&(v.programa_id=B);let N=await S.post(C.estudiante.agregarAll,v,{headers:{"Content-Type":"application/json"}}).catch(async p=>{const b=p?.response?.status;if(b===400||b===415){const m=new FormData;v.programa_id&&m.append("programa_id",String(v.programa_id)),m.append("estudiantes",JSON.stringify(v.estudiantes));try{return await S.post(C.estudiante.agregarAll,m)}catch(P){throw P}}throw p});const M=N&&N.status>=200&&N.status<300&&(N?.data?.error===void 0||N?.data?.error===!1);if(N?.data?.success||M)return g.fire({icon:"success",title:"¡Éxito!",text:N?.data?.message||"Estudiantes importados",timer:1500,showConfirmButton:!1}),_(),R(""),O.current&&(O.current.value=""),!0;throw new Error(N?.data?.message||"Error al importar estudiantes")}catch(a){const r=a?.response?.data?.message||a?.response?.data?.error;return g.fire({icon:"error",title:"Error",text:r||a.message||"Error al importar estudiantes"}),!1}},handleFileChange:t=>{t.target.files&&t.target.files.length>0?R(t.target.files[0].name):R("")},estudiantesFiltrados:K}},le=({titulo:i="Estudiantes",backUrl:c="/asignar",onBack:s})=>{const u=Y(),y=()=>{s?s():u(c)};return e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h2",{className:"h4 mb-0 d-flex align-items-center gap-2",children:[e.jsx(Z,{})," ",i]}),e.jsx("div",{children:e.jsxs("button",{className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:y,type:"button",children:[e.jsx(ee,{})," Volver"]})})]})},ce=({programas:i,onSubmit:c})=>{const{register:s,handleSubmit:u,reset:y,formState:{errors:n},setValue:w}=ne({defaultValues:{nombre:"",email:"",identificacion:"",programaId:""}});x.useEffect(()=>{i.length===1&&w("programaId",String(i[0].id))},[i,w]);const L=f=>{c(f,()=>y())};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(ae,{})," Agregar"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:u(L),autoComplete:"off",className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"nombre",className:"form-label",children:"Nombre:"}),e.jsx("input",{type:"text",id:"nombre",className:`form-control ${n.nombre?"is-invalid":""}`,placeholder:"Nombre completo",...s("nombre",{required:"El nombre es requerido",minLength:{value:2,message:"Mínimo 2 caracteres"}})}),n.nombre&&e.jsx("div",{className:"form-text text-danger",children:n.nombre.message})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"email",className:"form-label",children:"Email:"}),e.jsx("input",{type:"email",id:"email",className:`form-control ${n.email?"is-invalid":""}`,placeholder:"correo@dominio.com",...s("email",{required:"El email es requerido",pattern:{value:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"Email no válido"}})}),n.email&&e.jsx("div",{className:"form-text text-danger",children:n.email.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"identificacion",className:"form-label",children:"ID:"}),e.jsx("input",{type:"text",id:"identificacion",className:`form-control ${n.identificacion?"is-invalid":""}`,placeholder:"Documento de identidad",...s("identificacion",{required:"La identificación es requerida",minLength:{value:3,message:"Mínimo 3 caracteres"}})}),n.identificacion&&e.jsx("div",{className:"form-text text-danger",children:n.identificacion.message})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"programaId",className:"form-label",children:"Programa:"}),e.jsxs("select",{id:"programaId",className:`form-select ${n.programaId?"is-invalid":""}`,...s("programaId",{required:"El programa es requerido"}),disabled:i.length===1,children:[i.length!==1&&e.jsx("option",{value:"",children:"-- Seleccione --"}),i.map(f=>{const I=[f.nombre,f.nivel_nombre&&String(f.nivel_nombre).trim(),f.campus_nombre&&String(f.campus_nombre).trim()].filter(Boolean).join(" - ");return e.jsx("option",{value:f.id,children:I},f.id)})]}),n.programaId&&e.jsx("div",{className:"form-text text-danger",children:n.programaId.message})]}),e.jsx("div",{className:"col-12",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(te,{className:"me-2"})," Guardar"]})})]})})]})},de=({fileInputRef:i,selectedFileName:c,handleFileChange:s,onImportar:u})=>{const y=n=>{n.preventDefault(),i.current?.files&&i.current.files.length>0&&u(i.current.files[0])};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4 mt-3",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(re,{})," Importar Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:y,className:"row g-3 align-items-end",children:[e.jsxs("div",{className:"col-12 col-md",children:[e.jsx("label",{className:"form-label mb-1",children:"Formato"}),e.jsx("div",{className:"text-muted small",children:"nombre, email, ID, programa"})]}),e.jsxs("div",{className:"col-12 col-md-auto",children:[e.jsx("label",{htmlFor:"archivo_estudiantes",className:"form-label",children:"Archivo"}),e.jsx("input",{type:"file",id:"archivo_estudiantes",ref:i,accept:".csv,.xlsx,.xls",className:"form-control",onChange:s}),e.jsx("div",{className:"form-text",children:c||"Seleccionar"})]}),e.jsx("div",{className:"col-12 col-md-auto",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(se,{})," Importar"]})})]})})]})},me=({value:i,onChange:c,placeholder:s="Buscar..."})=>e.jsxs("div",{className:"position-relative",style:{minWidth:"220px"},children:[e.jsx("input",{type:"text",placeholder:s,className:"form-control pe-5",value:i,onChange:c}),e.jsx(ie,{className:"position-absolute text-secondary",style:{right:10,top:"50%",transform:"translateY(-50%)"}})]}),ue=({estudiantes:i})=>{if(i.length===0)return e.jsx("div",{className:"alert alert-warning mb-0",children:"Sin estudiantes registrados."});const c=s=>{const u=(s.programas||[]).slice();return u.length>0?(u.sort((n,w)=>String(n?.nombre||"").localeCompare(String(w?.nombre||""),"es")),e.jsx("div",{className:"d-flex flex-wrap gap-1",children:u.map(n=>e.jsx("span",{className:"badge text-bg-primary",children:n.nombre},`${s.id}-${n.id}`))})):(s.programa_nombre||"").trim()||"—"};return e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Programa"})]})}),e.jsx("tbody",{children:i.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.nombre}),e.jsx("td",{children:s.email}),e.jsx("td",{children:s.identificacion}),e.jsx("td",{children:c(s)})]},s.id))})]})})},Ne=()=>{const{estudiantesFiltrados:i,programas:c,loading:s,error:u,busqueda:y,setBusqueda:n,selectedFileName:w,fileInputRef:L,agregarEstudiante:f,importarEstudiantes:I,handleFileChange:T}=oe();return s?e.jsx(V,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-primary mb-2",role:"status"}),e.jsx("p",{className:"text-muted mb-0",children:"Cargando..."})]})})}):u?e.jsx(V,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsx("div",{className:"alert alert-danger mb-0",role:"alert",children:u})})}):e.jsx(V,{children:e.jsx("div",{className:"container-fluid py-3 bg-light min-vh-100",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xxl-11",children:[e.jsx(le,{}),e.jsxs("div",{className:"row g-3 mt-1",children:[e.jsxs("div",{className:"col-12 col-lg-5 d-flex flex-column gap-3",children:[e.jsx(ce,{programas:c,onSubmit:(A,$)=>{f(A).then(q=>{q&&$()})}}),e.jsx(de,{fileInputRef:L,selectedFileName:w,handleFileChange:T,onImportar:I})]}),e.jsxs("div",{className:"col-12 col-lg-7",children:[e.jsx("div",{className:"d-flex flex-wrap gap-2 justify-content-end align-items-center mb-3",children:e.jsx(me,{value:y,onChange:A=>n(A.target.value)})}),e.jsx("div",{className:"card border-0 shadow-sm rounded-4",children:e.jsx("div",{className:"card-body p-0",children:e.jsx(ue,{estudiantes:i})})})]})]})]})})})})};export{Ne as default};
