import{r as b,b as j,A as v,S as x,a as _,j as e}from"./index-DaOhVVWd.js";import{P as T}from"./PageTransition-Couod70-.js";import{u as k}from"./useAuthentication-Dn9EKM7N.js";import{A as q,m as R,J as O,K as M,L as H,M as U,N as V,O as z,I as G,H as J}from"./index-B8Flq_4W.js";import"./iconBase-Cr-ff6zs.js";const K=()=>{const{user:a}=k(),[d,l]=b.useState([]),[f,m]=b.useState([]),[n,h]=b.useState(!0),[c,u]=b.useState(null),[s,p]=b.useState(""),[g,y]=b.useState("todos"),[S,E]=b.useState(""),C=b.useRef(null),N=async()=>{try{h(!0),u(null);const[i,t]=await Promise.all([j.get(v.estudiante.base).catch(I=>{if(I?.response?.status===404)return{data:{estudiantes:[]}};throw I}),j.get(v.programas.base)]);let o=i?.data?.estudiantes??[];const r=t?.data?.data??t?.data;let w=[];if(Array.isArray(r?.programas)?w=r.programas:Array.isArray(r?.programa)?w=r.programa:r?.programa&&typeof r.programa=="object"?w=[r.programa]:Array.isArray(t?.data)&&(w=t?.data),!o.length)try{const I=a?.id||"",D=await j.get(`${v.estudiante.base}?usuario_id=${I}`);Array.isArray(D?.data?.data?.estudiantes)&&(o=D.data.data.estudiantes)}catch{}l(o),m(w)}catch{u("Error al cargar los datos"),x.fire({icon:"error",title:"Error",text:"Error al cargar los datos"})}finally{h(!1)}},F=async(i,t)=>{try{let o=await j.put(v.estudiante.habilitar,{id:i,identificacion:t});return o?.data?.success||(o=await j.post(v.estudiante.habilitar,{id:i,identificacion:t})),o?.data?.success?(x.fire({icon:"success",title:"¡Éxito!",text:o?.data?.mensaje||o?.data?.message||"Estudiante habilitado",timer:1500,showConfirmButton:!1}),N(),!0):(x.fire({icon:"warning",title:"Advertencia",text:o?.data?.message||"No se pudo habilitar al estudiante"}),!1)}catch(o){return x.fire({icon:"error",title:"Error",text:o?.response?.data?.message||"Error al procesar la solicitud"}),!1}};b.useEffect(()=>{N()},[]);const A=async i=>{try{const t=await j.post(v.estudiante.agregar,{nombre:i.nombre,email:i.email,identificacion:i.identificacion,programa_id:Number(i.programaId)});return t?.data?.success?(x.fire({icon:"success",title:"¡Éxito!",text:t?.data?.mensaje||"Estudiante agregado",timer:1500,showConfirmButton:!1}),N(),!0):(x.fire({icon:"warning",title:"Advertencia",text:t?.data?.message||"Error al agregar estudiante"}),!1)}catch{return x.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},B=async(i,t)=>{if(!(await x.fire({title:"¿Está seguro?",text:"¿Desea eliminar este estudiante?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)return!1;try{let r=await j.put(v.estudiante.deshabilitar,{id:i,identificacion:t});return r?.data?.success||(r=await j.post(v.estudiante.deshabilitar,{id:i,identificacion:t})),r?.data?.success?(x.fire({icon:"success",title:"¡Éxito!",text:r?.data?.mensaje||r?.data?.message||"Estudiante deshabilitado",timer:1500,showConfirmButton:!1}),N(),!0):(x.fire({icon:"warning",title:"Advertencia",text:r?.data?.message||"No se pudo deshabilitar al estudiante"}),!1)}catch(r){return x.fire({icon:"error",title:"Error",text:r?.response?.data?.message||"Error al procesar la solicitud"}),!1}},L=async()=>{if(d.length===0)return x.fire({icon:"info",title:"Información",text:"No hay estudiantes para eliminar"}),!1;if(!(await x.fire({title:"¿Eliminar TODOS los estudiantes?",html:`
        <p>Esta acción eliminará <strong>${d.length} estudiante(s)</strong>.</p>
        <p><strong>¡Esta acción no se puede deshacer!</strong></p>
        <p>¿Está absolutamente seguro?</p>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar todos",cancelButtonText:"Cancelar",focusCancel:!0,input:"text",inputPlaceholder:'Escriba "ELIMINAR" para confirmar',inputValidator:t=>{if(t!=="ELIMINAR")return'Debe escribir "ELIMINAR" para confirmar'}})).isConfirmed)return!1;try{const t=a?.id||"",r=await(await j.get(`${v.estudiante.base}?eliminar_todos=true&usuario_id=${t}`)).data;return r.success?(x.fire({icon:"success",title:"¡Éxito!",text:r.mensaje||`${r.eliminados} estudiante(s) eliminado(s)`,timer:2e3,showConfirmButton:!1}),N(),!0):(x.fire({icon:"warning",title:"Advertencia",text:r.mensaje||"Error al eliminar estudiantes"}),!1)}catch{return x.fire({icon:"error",title:"Error",text:"Error al procesar la solicitud"}),!1}},P=i=>{const t=i,o=t?.estado??t?.habilitado??t?.activo??t?.is_active??t?.status;if(typeof o=="boolean")return o;if(typeof o=="number")return o===1;if(typeof o=="string"){const r=o.toLowerCase();return r==="1"||r==="activo"||r==="activa"||r==="habilitado"||r==="habilitada"||r==="true"}return!0},$=d.filter(i=>{const t=s.toLowerCase(),o=i.nombre.toLowerCase().includes(t)||i.email.toLowerCase().includes(t)||i.identificacion.toLowerCase().includes(t)||i.programa_nombre.toLowerCase().includes(t),r=P(i);return o&&(g==="todos"||g==="activos"&&r||g==="inactivos"&&!r)});return{estudiantes:d,programas:f,loading:n,error:c,busqueda:s,setBusqueda:p,estadoFiltro:g,setEstadoFiltro:y,selectedFileName:S,setSelectedFileName:E,fileInputRef:C,cargarDatos:N,agregarEstudiante:A,eliminarEstudiante:B,habilitarEstudiante:F,eliminarTodosEstudiantes:L,importarEstudiantes:async i=>{try{const t=new FormData;t.append("archivo_estudiantes",i);const o=await j.post(v.estudiante.agregar,t,{headers:{"Content-Type":"multipart/form-data"}});if(o?.data?.success)return x.fire({icon:"success",title:"¡Éxito!",text:o?.data?.message||"Estudiantes importados",timer:1500,showConfirmButton:!1}),N(),E(""),C.current&&(C.current.value=""),!0;throw new Error(o?.data?.message||"Error al importar estudiantes")}catch(t){return x.fire({icon:"error",title:"Error",text:t.message||"Error al importar estudiantes"}),!1}},handleFileChange:i=>{i.target.files&&i.target.files.length>0?E(i.target.files[0].name):E("")},estudiantesFiltrados:$}},W=({titulo:a="Estudiantes",backUrl:d="/asignar",onBack:l})=>{const f=_(),m=()=>{l?l():f(d)};return e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-3",children:[e.jsxs("h2",{className:"h4 mb-0 d-flex align-items-center gap-2",children:[e.jsx(q,{})," ",a]}),e.jsx("div",{children:e.jsxs("button",{className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",onClick:m,type:"button",children:[e.jsx(R,{})," Volver"]})})]})},Y=(a={nombre:"",email:"",identificacion:"",programaId:""})=>{const[d,l]=b.useState(a),[f,m]=b.useState({});return{form:d,setForm:l,errors:f,setErrors:m,handleChange:s=>{const{name:p,value:g}=s.target;l(y=>({...y,[p]:g})),m(y=>({...y,[p]:""}))},validate:()=>{const s={};return d.nombre.trim()||(s.nombre="El nombre es requerido"),d.email.trim()||(s.email="El email es requerido"),d.identificacion.trim()||(s.identificacion="La identificación es requerida"),d.programaId||(s.programaId="El programa es requerido"),m(s),Object.keys(s).length===0},resetForm:()=>{l(a),m({})},updateProgramaIfSingle:s=>{s.length===1&&!d.programaId&&l(p=>({...p,programaId:s[0].id.toString()}))}}},Q=({programas:a,onSubmit:d})=>{const{form:l,errors:f,handleChange:m,validate:n,resetForm:h,updateProgramaIfSingle:c}=Y();b.useEffect(()=>{c(a)},[a,c]);const u=s=>{s.preventDefault(),n()&&d(l,h)};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(O,{})," Agregar"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:u,autoComplete:"off",className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"nombre",className:"form-label",children:"Nombre:"}),e.jsx("input",{type:"text",id:"nombre",name:"nombre",className:"form-control",value:l.nombre,onChange:m,required:!0}),f.nombre&&e.jsx("div",{className:"form-text text-danger",children:f.nombre})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{htmlFor:"email",className:"form-label",children:"Email:"}),e.jsx("input",{type:"email",id:"email",name:"email",className:"form-control",value:l.email,onChange:m,required:!0}),f.email&&e.jsx("div",{className:"form-text text-danger",children:f.email})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"identificacion",className:"form-label",children:"ID:"}),e.jsx("input",{type:"text",id:"identificacion",name:"identificacion",className:"form-control",value:l.identificacion,onChange:m,required:!0}),f.identificacion&&e.jsx("div",{className:"form-text text-danger",children:f.identificacion})]}),e.jsxs("div",{className:"col-12 col-md-6",children:[e.jsx("label",{htmlFor:"programaId",className:"form-label",children:"Programa:"}),e.jsxs("select",{id:"programaId",name:"programaId",className:"form-select",value:l.programaId,onChange:m,required:!0,disabled:a.length===1,children:[a.length!==1&&e.jsx("option",{value:"",children:"-- Seleccione --"}),a.map(s=>e.jsx("option",{value:s.id,children:s.nombre},s.id))]}),f.programaId&&e.jsx("div",{className:"form-text text-danger",children:f.programaId})]}),e.jsx("div",{className:"col-12",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(M,{className:"me-2"})," Guardar"]})})]})})]})},X=({fileInputRef:a,selectedFileName:d,handleFileChange:l,onImportar:f})=>{const m=n=>{n.preventDefault(),a.current?.files&&a.current.files.length>0&&f(a.current.files[0])};return e.jsxs("div",{className:"card border-0 shadow-sm rounded-4 mt-3",children:[e.jsx("div",{className:"card-header text-white",style:{backgroundColor:"#00a19B"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center gap-2",children:[e.jsx(H,{})," Importar CSV"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("form",{onSubmit:m,className:"row g-3 align-items-end",children:[e.jsxs("div",{className:"col-12 col-md",children:[e.jsx("label",{className:"form-label mb-1",children:"Formato"}),e.jsx("div",{className:"text-muted small",children:"nombre, email, ID, programa"})]}),e.jsxs("div",{className:"col-12 col-md-auto",children:[e.jsx("label",{htmlFor:"archivo_estudiantes",className:"form-label",children:"Archivo"}),e.jsx("input",{type:"file",id:"archivo_estudiantes",ref:a,accept:".csv",className:"form-control",onChange:l}),e.jsx("div",{className:"form-text",children:d||"Seleccionar"})]}),e.jsx("div",{className:"col-12 col-md-auto",children:e.jsxs("button",{type:"submit",className:"btn btn-outline-orange w-100 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold py-2",children:[e.jsx(U,{})," Importar"]})})]})})]})},Z=({value:a,onChange:d,placeholder:l="Buscar..."})=>e.jsxs("div",{className:"position-relative",style:{minWidth:"220px"},children:[e.jsx("input",{type:"text",placeholder:l,className:"form-control pe-5",value:a,onChange:d}),e.jsx(V,{className:"position-absolute text-secondary",style:{right:10,top:"50%",transform:"translateY(-50%)"}})]}),ee=({estudiantes:a,onEliminar:d,onHabilitar:l})=>{if(a.length===0)return e.jsx("div",{className:"alert alert-warning mb-0",children:"Sin estudiantes registrados."});const f=n=>{const h=n,c=h?.estado??h?.habilitado??h?.activo??h?.is_active??h?.status;let u;if(typeof c=="boolean")u=c;else if(typeof c=="number")u=c===1;else if(typeof c=="string"){const s=c.toLowerCase();u=s==="1"||s==="activo"||s==="activa"||s==="habilitado"||s==="habilitada"||s==="true"}else u=!0;return e.jsx("span",{className:`badge rounded-pill ${u?"text-bg-success":"text-bg-secondary"}`,children:u?"Activo":"Inactivo"})},m=n=>{const h=n,c=h?.estado??h?.habilitado??h?.activo??h?.is_active??h?.status;if(typeof c=="boolean")return c;if(typeof c=="number")return c===1;if(typeof c=="string"){const u=c.toLowerCase();return u==="1"||u==="activo"||u==="activa"||u==="habilitado"||u==="habilitada"||u==="true"}return!0};return e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Programa"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{className:"text-end",children:"Acciones"})]})}),e.jsx("tbody",{children:a.map(n=>e.jsxs("tr",{children:[e.jsx("td",{children:n.nombre}),e.jsx("td",{children:n.email}),e.jsx("td",{children:n.identificacion}),e.jsx("td",{children:n.programa_nombre}),e.jsx("td",{children:f(n)}),e.jsx("td",{className:"text-end",children:m(n)?e.jsx("button",{className:"btn btn-outline-danger w-80 d-inline-flex align-items-center justify-content-center gap-2 fw-semibolr",onClick:()=>d(n.id,n.identificacion),title:"Deshabilitar",type:"button",children:e.jsx(z,{size:12})}):e.jsx("button",{className:"btn btn-outline-success w-80 d-inline-flex align-items-center justify-content-center gap-2 fw-semibolr",onClick:()=>l(n.id,n.identificacion),title:"Activar",type:"button",children:e.jsx(G,{size:12})})})]},n.id))})]})})},te=({totalEstudiantes:a,onEliminarTodos:d,disabled:l=!1,className:f=""})=>{const[m,n]=b.useState(!1),h=async()=>{if(!(m||l||a===0)){n(!0);try{await d()}catch(g){console.error("Error al eliminar todos los estudiantes:",g)}finally{n(!1)}}},c=m||l||a===0,u=()=>{const g=`btn btn-outline-danger w-30 d-inline-flex align-items-center justify-content-center gap-2 fw-semibol ${f}`;return c?`${g} disabled`:g},s=()=>m?"Eliminando...":a===0?"Sin estudiantes":`Eliminar Todos (${a})`,p=()=>e.jsx(J,{});return e.jsxs("button",{type:"button",className:u(),onClick:h,disabled:c,title:a===0?"No hay estudiantes para eliminar":`Eliminar todos los ${a} estudiantes`,children:[m&&e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),p()," ",s()]})},ce=()=>{const{estudiantes:a,estudiantesFiltrados:d,programas:l,loading:f,error:m,busqueda:n,setBusqueda:h,estadoFiltro:c,setEstadoFiltro:u,selectedFileName:s,fileInputRef:p,agregarEstudiante:g,eliminarEstudiante:y,habilitarEstudiante:S,eliminarTodosEstudiantes:E,importarEstudiantes:C,handleFileChange:N}=K();return f?e.jsx(T,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-primary mb-2",role:"status"}),e.jsx("p",{className:"text-muted mb-0",children:"Cargando..."})]})})}):m?e.jsx(T,{children:e.jsx("div",{className:"container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light",children:e.jsx("div",{className:"alert alert-danger mb-0",role:"alert",children:m})})}):e.jsx(T,{children:e.jsx("div",{className:"container-fluid py-3 bg-light min-vh-100",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xxl-11",children:[e.jsx(W,{}),e.jsxs("div",{className:"row g-3 mt-1",children:[e.jsxs("div",{className:"col-12 col-lg-5 d-flex flex-column gap-3",children:[e.jsx(Q,{programas:l,onSubmit:(F,A)=>{g(F).then(B=>{B&&A()})}}),e.jsx(X,{fileInputRef:p,selectedFileName:s,handleFileChange:N,onImportar:C})]}),e.jsxs("div",{className:"col-12 col-lg-7",children:[e.jsxs("div",{className:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3",children:[e.jsx(Z,{value:n,onChange:F=>h(F.target.value)}),e.jsxs("div",{className:"btn-group",role:"group","aria-label":"Filtro estado",children:[e.jsx("button",{type:"button",className:`btn btn-sm ${c==="todos"?"btn-primary":"btn-outline-primary"}`,onClick:()=>u("todos"),children:"Todos"}),e.jsx("button",{type:"button",className:`btn btn-sm ${c==="activos"?"btn-success":"btn-outline-success"}`,onClick:()=>u("activos"),children:"Activos"}),e.jsx("button",{type:"button",className:`btn btn-sm ${c==="inactivos"?"btn-secondary":"btn-outline-secondary"}`,onClick:()=>u("inactivos"),children:"Inactivos"})]}),e.jsx(te,{totalEstudiantes:a.length,onEliminarTodos:E})]}),e.jsx("div",{className:"card border-0 shadow-sm rounded-4",children:e.jsx("div",{className:"card-body p-0",children:e.jsx(ee,{estudiantes:d,onEliminar:y,onHabilitar:S})})})]})]})]})})})})};export{ce as default};
