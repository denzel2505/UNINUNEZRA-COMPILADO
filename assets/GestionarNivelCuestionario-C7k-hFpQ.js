import{j as e,r,A as F,b as w,a as R,c as _,u as M,e as B,S as H}from"./index-BTkTQ1Fh.js";import{P as G}from"./PageTransition-Dz2EIat_.js";import{m as V,b as y}from"./index-DLtsYAVg.js";import"./iconBase-QLClNUbn.js";const q=({title:a,onBack:c})=>e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h2",{className:"m-0",children:a}),e.jsxs("button",{className:"btn btn-secondary",onClick:c,children:[e.jsx(V,{className:"me-2"})," Regresar"]})]}),z=({descripcion:a,abreviatura:c,cuestionarioId:o,programaId:m,programaNombre:d,onDescripcionChange:u,onAbreviaturaChange:i,readOnly:s=!1,showIds:t=!1})=>e.jsxs("div",{className:"row border-bottom mb-4 p-4",children:[e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"descripcion",className:"form-label",children:["Descripcion* ",s&&e.jsx(y,{className:"ms-1"})]}),e.jsx("textarea",{id:"descripcion",className:`form-control${s?" bg-light":""}`,value:a,onChange:n=>u(n.target.value),rows:4,placeholder:"Describe el nivel...",disabled:s})]}),e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"abreviatura",className:"form-label",children:["Abreviatura* ",s&&e.jsx(y,{className:"ms-1"})]}),e.jsx("input",{type:"text",id:"abreviatura",className:`form-control${s?" bg-light":""}`,value:c,maxLength:3,onChange:n=>i(n.target.value.toUpperCase().slice(0,3)),placeholder:"Ej: RA1, RA2...",disabled:s})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"cuestionarioId",className:"form-label",children:["Cuestionario ID ",e.jsx(y,{})]}),e.jsx("div",{className:"input-group",children:e.jsx("input",{type:"text",id:"cuestionarioId",className:"form-control bg-light",value:o,disabled:!0,"aria-label":"Cuestionario Id"})})]}),e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"programaId",className:"form-label",children:["Programa ID: ",e.jsx("b",{children:d||"No especificado"})," ",e.jsx(y,{})]}),e.jsx("div",{className:"input-group",children:e.jsx("input",{type:"text",id:"programaId",className:"form-control bg-light",value:m,disabled:!0,"aria-label":"Programa"})})]})]})]}),U=({levels:a,onChange:c,maxScore:o=100,readOnly:m=!1})=>{const d=(i,s)=>{const t=a.map((n,l)=>l===i?{...n,...s}:n);c(t)},u=i=>{const{min:s,max:t}=i;return s==null||t==null?"Completa puntaje mínimo y máximo":s<0||t<0?"Valores >= 0":s>o||t>o?`El valor debe estar entre 0 y ${o}`:s>t?"Mínimo no puede ser mayor que máximo":null};return e.jsxs("div",{className:"row",children:[e.jsxs("h3",{className:"mb-4",children:["Indicadores ",e.jsxs("small",{className:"text-muted",children:["(Puntaje máximo: ",o,")"]})]}),m&&e.jsx("div",{className:"alert alert-info mt-2",children:"Este cuestionario ya tiene niveles registrados. Los campos se muestran en solo lectura."}),e.jsx("div",{className:"col-12",children:a.map((i,s)=>e.jsx("div",{className:"mb-3 pb-3 border-bottom",children:e.jsxs("div",{className:"row align-items-stretch g-3",children:[e.jsx("div",{className:"col-12 mb-1",children:e.jsxs("label",{className:"form-label",style:{fontSize:"23px"},children:[i.name," ",m&&e.jsx(y,{className:"ms-1"})]})}),e.jsxs("div",{className:"col-12 col-md-5 d-flex flex-column gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:`min-${s}`,children:"Mínimo"}),e.jsx("input",{id:`min-${s}`,className:`form-control${m?" bg-light":""}`,type:"number",min:0,max:o,step:1,value:typeof i.min=="number"?String(i.min):"",onChange:t=>d(s,{min:t.target.value===""?void 0:Number(t.target.value)}),disabled:m})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:`max-${s}`,children:"Máximo"}),e.jsx("input",{id:`max-${s}`,className:`form-control${m?" bg-light":""}`,type:"number",min:0,max:o,step:1,value:typeof i.max=="number"?String(i.max):"",onChange:t=>d(s,{max:t.target.value===""?void 0:Number(t.target.value)}),disabled:m})]})]}),e.jsxs("div",{className:"col-12 col-md-7 d-flex flex-column",children:[e.jsx("label",{className:"form-label",htmlFor:`indicadores-${s}`,children:"Indicadores"}),e.jsx("textarea",{id:`indicadores-${s}`,className:`form-control h-100${m?" bg-light":""}`,placeholder:"Ingrese informacion del indicador...",style:{minHeight:"100%"},value:i.indicadores??"",onChange:t=>d(s,{indicadores:t.target.value}),disabled:m})]}),u(i)&&e.jsx("div",{className:"col-12",children:e.jsx("small",{className:"text-danger",children:u(i)})})]})},s))})]})},J=({onSave:a,saving:c=!1,disabled:o=!1})=>e.jsx("div",{className:"row mt-4 mb-2 justify-content-end w-100",children:e.jsx("div",{className:"col-auto",children:e.jsx("button",{style:{width:"150px"},className:"btn btn-secondary p-2",onClick:a,disabled:c||o,children:c?"Guardando...":"Guardar"})})});function K(a){const[c,o]=r.useState(100),[m,d]=r.useState(!1),[u,i]=r.useState(null),s=r.useRef(void 0),t=r.useRef(!1),n=r.useCallback(async()=>{if(a)try{d(!0),i(null);const l=F.programas.byId(a),v=(await w.get(l)).data?.data?.programa,j=Array.isArray(v)?v?.[0]?.nivel_puntaje_maximo:v?.nivel_puntaje_maximo,N=Number(j);!Number.isNaN(N)&&typeof N=="number"&&N>0?o(N):o(100)}catch(l){i(l?.message||(l?.response?.status?`HTTP ${l.response.status}`:"Error desconocido")),o(100)}finally{d(!1)}},[a]);return r.useEffect(()=>{a&&(s.current===a&&t.current||(s.current=a,t.current=!0,n()))},[n,a]),{maxScore:c,loading:m,error:u,refresh:n}}function Q(){const[a,c]=r.useState(!1),[o,m]=r.useState(null),[d,u]=r.useState(null),i=r.useCallback(()=>{c(!1),m(null),u(null)},[]),s=r.useCallback(async t=>{try{c(!0),m(null),u(null);const n=F.cuestionario.createNivel,x=(await w.post(n,t))?.data;return u(x),x}catch(n){const l=n?.response?.data?.message||n?.message||(n?.response?.status?`HTTP ${n.response.status}`:"Error desconocido");return m(l),null}finally{c(!1)}},[]);return{loading:a,error:o,data:d,createNivel:s,reset:i}}function W(a){const[c,o]=r.useState(!1),[m,d]=r.useState(null),[u,i]=r.useState(null),s=r.useRef(void 0),t=r.useRef(!1),n=r.useCallback(async()=>{if(a)try{o(!0),d(null);const l=F.cuestionario.mostrarNivel(a),g=(await w.get(l))?.data;i(g)}catch(l){const x=l?.response?.data?.message||l?.message||(l?.response?.status?`HTTP ${l.response.status}`:"Error desconocido");d(x)}finally{o(!1)}},[a]);return r.useEffect(()=>{a&&(s.current===a&&t.current||(s.current=a,t.current=!0,n()))},[n,a]),{loading:c,error:m,data:u,refresh:n}}const ee=()=>{const a=R(),c=_(),[o]=M(),m=B(),d=c.state?.cuestionarioId??o.get("cuestionarioId")??m.id??"",u=c.state?.programaId??o.get("programaId")??"",i=c.state?.programaNombre,s=c.state?.cuestionarioTitulo??o.get("titulo")??void 0,[t,n]=r.useState(""),[l,x]=r.useState(""),[g,v]=r.useState([{name:"Nivel 1"},{name:"Nivel 2"},{name:"Nivel 3"},{name:"Nivel 4"}]),{maxScore:j}=K(u),{createNivel:N,loading:P,error:E}=Q(),{data:b}=W(d),[S,$]=r.useState(!1);r.useEffect(()=>{const h=b?.data?.niveles||b?.data?.ra||b?.niveles||b?.ra,f=Array.isArray(h)?h[0]:void 0,p=b?.data?.descripcion||b?.descripcion||f&&f.descripcion,I=b?.data?.abreviatura||b?.abreviatura||f&&f.abreviatura;if(Array.isArray(h)&&h.length>0){const k=h.map((C,D)=>({name:`Nivel ${D+1}`,min:Number(C.puntaje_min??0),max:Number(C.puntaje_max??0),indicadores:String(C.indicadores??"")}));v(k),typeof p=="string"&&n(p),typeof I=="string"&&x(I),$(!0)}else $(!1)},[b]);const L=async()=>{const h={cuestionario_id:d,abreviatura:l.trim(),descripcion:t.trim(),niveles:g.map(p=>({puntaje_min:Number(p.min??0),puntaje_max:Number(p.max??0),indicadores:String(p.indicadores??"")}))};await N(h)&&(await H.fire({title:"Operación exitosa",text:"Los niveles se han guardado correctamente.",icon:"success",confirmButtonText:"Aceptar",confirmButtonColor:"#0d6efd"}),a("/dashboard"))},A=r.useMemo(()=>g.length?g.every(h=>{const{min:f,max:p}=h;return!(f==null||p==null||f<0||p<0||f>j||p>j||f>p)}):!1,[g,j]),T=r.useMemo(()=>{const h=t.trim().length>0,f=l.trim().length>0;return h&&f&&A},[t,l,A]);return e.jsx(G,{children:e.jsxs("div",{children:[e.jsx(q,{title:"Gestionar Nivel Cuestionario",onBack:()=>a("/dashboard")}),e.jsx("div",{className:"card shadow-sm mt-4",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("h3",{children:["Cuestionario: ",e.jsx("span",{children:s||(d?`ID ${d}`:"Sin título")})]}),e.jsx(z,{descripcion:t,abreviatura:l,cuestionarioId:d,programaId:u,programaNombre:i,onDescripcionChange:n,onAbreviaturaChange:x,readOnly:S}),e.jsx(U,{levels:g,onChange:v,maxScore:j,readOnly:S}),E&&e.jsx("div",{className:"alert alert-danger mt-3",children:E}),!S&&e.jsx(J,{onSave:L,disabled:!T||P})]})})]})})};export{ee as default};
