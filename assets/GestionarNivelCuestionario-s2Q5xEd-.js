import{j as e,r as n,A as T,b as I,a as ee,c as se,u as ae,e as te,S as P}from"./index-DAGB5OzC.js";import{P as re}from"./PageTransition-DfyYbGk4.js";import{m as ne,b as $}from"./index-7f3zIO5d.js";import{u as ie}from"./useAuthentication-Ky9h1RTe.js";import"./iconBase-CYzjdnYU.js";const oe=({title:r,onBack:o})=>e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h2",{className:"m-0",children:r}),e.jsxs("button",{className:"btn btn-secondary",onClick:o,children:[e.jsx(ne,{className:"me-2"})," Regresar"]})]}),le=({descripcion:r,abreviatura:o,cuestionarioId:l,programaId:c,programaNombre:m,onDescripcionChange:f,onAbreviaturaChange:u,readOnly:a=!1,showIds:i=!1})=>e.jsxs("div",{className:"row border-bottom mb-4 p-4",children:[e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"descripcion",className:"form-label",children:["Descripcion* ",a&&e.jsx($,{className:"ms-1"})]}),e.jsx("textarea",{id:"descripcion",className:`form-control${a?" bg-light":""}`,value:r,onChange:s=>f(s.target.value),rows:4,placeholder:"Describe el nivel...",disabled:a})]}),e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"abreviatura",className:"form-label",children:["Abreviatura* ",a&&e.jsx($,{className:"ms-1"})]}),e.jsx("input",{type:"text",id:"abreviatura",className:`form-control${a?" bg-light":""}`,value:o,maxLength:3,onChange:s=>u(s.target.value.toUpperCase().slice(0,3)),placeholder:"Ej: RA1, RA2...",disabled:a})]}),i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"cuestionarioId",className:"form-label",children:["Cuestionario ID ",e.jsx($,{})]}),e.jsx("div",{className:"input-group",children:e.jsx("input",{type:"text",id:"cuestionarioId",className:"form-control bg-light",value:l,disabled:!0,"aria-label":"Cuestionario Id"})})]}),e.jsxs("div",{className:"col-12 col-md-6 mt-3",children:[e.jsxs("label",{htmlFor:"programaId",className:"form-label",children:["Programa ID: ",e.jsx("b",{children:m||"No especificado"})," ",e.jsx($,{})]}),e.jsx("div",{className:"input-group",children:e.jsx("input",{type:"text",id:"programaId",className:"form-control bg-light",value:c,disabled:!0,"aria-label":"Programa"})})]})]})]}),ce=({levels:r,onChange:o,maxScore:l=100,readOnly:c=!1})=>{const m=(u,a)=>{const i=r.map((s,t)=>t===u?{...s,...a}:s);o(i)},f=(u,a)=>{const{min:i,max:s}=u;if(i==null||s==null)return"Completa puntaje mínimo y máximo";if(i<0||s<0)return"Valores >= 0";if(i>l||s>l)return`El valor debe estar entre 0 y ${l}`;if(i>s)return"El mínimo no puede ser mayor que el máximo";if(a>0){const t=r[a-1];if(t&&typeof t.max=="number"&&typeof i=="number"&&i<=t.max)return`El mínimo de este nivel debe ser mayor que el máximo del nivel anterior (${t.max}).`}return""};return e.jsxs("div",{className:"row",children:[e.jsxs("h3",{className:"mb-4",children:["Indicadores ",e.jsxs("small",{className:"text-dark",children:["(Puntaje máximo: ",l,")"]})]}),c&&e.jsx("div",{className:"alert alert-info mt-2",children:"Este cuestionario ya tiene niveles registrados. Los campos se muestran en solo lectura."}),e.jsx("div",{className:"col-12",children:r.map((u,a)=>{const i=f(u,a),s=!!i;return e.jsx("div",{className:"mb-3 pb-3 border-bottom",children:e.jsxs("div",{className:"row align-items-stretch g-3",children:[e.jsx("div",{className:"col-12 mb-1",children:e.jsxs("label",{className:"form-label",style:{fontSize:"23px"},children:[u.name," ",c&&e.jsx($,{className:"ms-1"})]})}),e.jsxs("div",{className:"col-12 col-md-5 d-flex flex-column gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:`min-${a}`,children:"Mínimo"}),e.jsx("input",{id:`min-${a}`,className:`form-control${c?" bg-light":""}${s?" is-invalid":""}`,type:"number",min:typeof r[a-1]?.max=="number"?Number(r[a-1].max)+1:0,max:l,step:1,value:typeof u.min=="number"?String(u.min):"",onChange:t=>m(a,{min:t.target.value===""?void 0:Number(t.target.value)}),disabled:c,"aria-invalid":s,"aria-describedby":`level-${a}-error`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:`max-${a}`,children:"Máximo"}),e.jsx("input",{id:`max-${a}`,className:`form-control${c?" bg-light":""}${s?" is-invalid":""}`,type:"number",min:0,max:l,step:1,value:typeof u.max=="number"?String(u.max):"",onChange:t=>m(a,{max:t.target.value===""?void 0:Number(t.target.value)}),disabled:c,"aria-invalid":s,"aria-describedby":`level-${a}-error`})]})]}),e.jsxs("div",{className:"col-12 col-md-7 d-flex flex-column",children:[e.jsx("label",{className:"form-label",htmlFor:`indicadores-${a}`,children:"Indicadores"}),e.jsx("textarea",{id:`indicadores-${a}`,className:`form-control h-100${c?" bg-light":""}`,placeholder:"Ingrese informacion del indicador...",style:{minHeight:"100%"},value:u.indicadores??"",onChange:t=>m(a,{indicadores:t.target.value}),disabled:c})]}),e.jsx("div",{className:"col-12",children:s&&e.jsx("div",{id:`level-${a}-error`,className:"invalid-feedback d-block text-danger",role:"alert",children:i})})]})},a)})})]})},ue=({onSave:r,saving:o=!1,disabled:l=!1})=>e.jsx("div",{className:"row mt-4 mb-2 justify-content-end w-100",children:e.jsx("div",{className:"col-auto",children:e.jsx("button",{style:{width:"150px"},className:"btn btn-secondary p-2",onClick:r,disabled:o||l,children:o?"Guardando...":"Guardar"})})});function me(r){const[o,l]=n.useState(100),[c,m]=n.useState(!1),[f,u]=n.useState(null),a=n.useRef(void 0),i=n.useRef(!1),s=n.useCallback(async()=>{if(r)try{m(!0),u(null);const t=T.programas.byId(r),y=(await I.get(t)).data?.data?.programa,C=Array.isArray(y)?y?.[0]?.nivel_puntaje_maximo:y?.nivel_puntaje_maximo,S=Number(C);!Number.isNaN(S)&&typeof S=="number"&&S>0?l(S):l(100)}catch(t){u(t?.message||(t?.response?.status?`HTTP ${t.response.status}`:"Error desconocido")),l(100)}finally{m(!1)}},[r]);return n.useEffect(()=>{r&&(a.current===r&&i.current||(a.current=r,i.current=!0,s()))},[s,r]),{maxScore:o,loading:c,error:f,refresh:s}}function de(){const[r,o]=n.useState(!1),[l,c]=n.useState(null),[m,f]=n.useState(null),u=n.useCallback(()=>{o(!1),c(null),f(null)},[]),a=n.useCallback(async i=>{try{o(!0),c(null),f(null);const s=T.cuestionario.createNivel,v=(await I.post(s,i))?.data;return f(v),v}catch(s){const t=s?.response?.data?.message||s?.message||(s?.response?.status?`HTTP ${s.response.status}`:"Error desconocido");return c(t),null}finally{o(!1)}},[]);return{loading:r,error:l,data:m,createNivel:a,reset:u}}function fe(r){const[o,l]=n.useState(!1),[c,m]=n.useState(null),[f,u]=n.useState(null),a=n.useRef(void 0),i=n.useRef(!1),s=n.useCallback(async()=>{if(r)try{l(!0),m(null);const t=T.cuestionario.mostrarNivel(r),b=(await I.get(t))?.data;u(b)}catch(t){const v=t?.response?.data?.message||t?.message||(t?.response?.status?`HTTP ${t.response.status}`:"Error desconocido");m(v)}finally{l(!1)}},[r]);return n.useEffect(()=>{r&&(a.current===r&&i.current||(a.current=r,i.current=!0,s()))},[s,r]),{loading:o,error:c,data:f,refresh:s}}function pe(){const[r,o]=n.useState(!1),[l,c]=n.useState(null),[m,f]=n.useState(null),u=n.useCallback(()=>{o(!1),c(null),f(null)},[]),a=n.useCallback(async i=>{try{o(!0),c(null),f(null);const s=T.cuestionario.actualizarNivel,v=(await I.put(s,i))?.data;return f(v),v}catch(s){const t=s?.response?.data?.message||s?.message||(s?.response?.status?`HTTP ${s.response.status}`:"Error desconocido");return c(t),null}finally{o(!1)}},[]);return{loading:r,error:l,data:m,updateNivel:a,reset:u}}const Ne=()=>{const r=ee(),o=se(),[l]=ae(),c=te(),m=o.state?.cuestionarioId??l.get("cuestionarioId")??c.id??"",f=o.state?.programaId??l.get("programaId")??"",u=o.state?.programaNombre,a=o.state?.cuestionarioTitulo??l.get("titulo")??void 0,[i,s]=n.useState(""),[t,v]=n.useState(""),[b,y]=n.useState([{name:"Nivel 1"},{name:"Nivel 2"},{name:"Nivel 3"},{name:"Nivel 4"}]),{maxScore:C}=me(f),{createNivel:S,loading:V,error:D}=de(),{updateNivel:J,loading:K,error:_}=pe(),{data:g,refresh:R}=fe(m),{user:B}=ie(),A=B?.rol??B?.rol_user??void 0,F=A===0||A==="0"||A==="admin"||A==="ADMIN",[E,w]=n.useState(!1),[k,M]=n.useState(!1);n.useEffect(()=>{const p=g?.data?.niveles||g?.data?.ra||g?.niveles||g?.ra,d=Array.isArray(p)?p[0]:void 0,h=g?.data?.descripcion||g?.descripcion||d&&d.descripcion,N=g?.data?.abreviatura||g?.abreviatura||d&&d.abreviatura;if(Array.isArray(p)&&p.length>0){M(!0);const Y=[...p].sort((x,j)=>{const q=typeof x?.nivel<"u"&&x?.nivel!==null?Number(x.nivel):null,G=typeof j?.nivel<"u"&&j?.nivel!==null?Number(j.nivel):null;if(q!==null&&G!==null)return q-G;const Z=Number(x?.puntaje_min??0),O=Number(j?.puntaje_min??0);return Z-O}).map((x,j)=>({name:`Nivel ${j+1}`,min:Number(x.puntaje_min??0),max:Number(x.puntaje_max??0),indicadores:String(x.indicadores??""),nivel:typeof x.nivel<"u"&&x.nivel!==null?Number(x.nivel):j}));y(Y),typeof h=="string"&&s(h),typeof N=="string"&&v(N),w(!0)}else M(!1),w(!1)},[g]);const Q=async()=>{const p={cuestionario_id:m,abreviatura:t.trim(),descripcion:i.trim(),niveles:b.map((N,L)=>({nivel:typeof N.nivel=="number"?N.nivel:k?L+1:L,puntaje_min:Number(N.min??0),puntaje_max:Number(N.max??0),indicadores:String(N.indicadores??"")}))};if(!U){await P.fire({title:"Revisa los campos",text:"Hay errores de validación en los niveles. Corrige los puntajes antes de guardar.",icon:"warning",confirmButtonText:"Entendido",confirmButtonColor:"#0d6efd"});return}const d=F&&k;if(d&&!(await P.fire({title:"Confirmar actualización",text:"¿Deseas actualizar los niveles de este cuestionario? Esta acción sobrescribirá la configuración anterior.",icon:"question",showCancelButton:!0,confirmButtonText:"Actualizar",cancelButtonText:"Cancelar",confirmButtonColor:"#0d6efd"})).isConfirmed)return;(d?await J(p):await S(p))&&(await P.fire({title:"Operación exitosa",text:d?"Los niveles se han actualizado correctamente.":"Los niveles se han guardado correctamente.",icon:"success",confirmButtonText:"Aceptar",confirmButtonColor:"#0d6efd"}),d?(w(!0),await R()):r("/dashboard"))},W=()=>{F&&w(!1)},X=async()=>{await R(),w(!0)},H=n.useMemo(()=>b.length?b.every(p=>{const{min:d,max:h}=p;return!(d==null||h==null||d<0||h<0||d>C||h>C||d>h)}):!1,[b,C]),z=n.useMemo(()=>{if(!b.length)return!1;for(let p=0;p<b.length;p++){const d=b[p];if(d.min==null||d.max==null)return!1;if(p>0){const h=b[p-1];if(typeof h.max=="number"&&typeof d.min=="number"){if(d.min<=h.max)return!1}else return!1}}return!0},[b]),U=n.useMemo(()=>{const p=i.trim().length>0,d=t.trim().length>0;return p&&d&&H&&z},[i,t,H,z]);return e.jsx(re,{children:e.jsxs("div",{children:[e.jsx(oe,{title:"Gestionar Nivel Cuestionario",onBack:()=>r("/dashboard")}),e.jsx("div",{className:"card shadow-sm mt-4",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between flex-wrap gap-2",children:[e.jsxs("h3",{className:"mb-0",children:["Cuestionario: ",e.jsx("span",{children:a||(m?`ID ${m}`:"Sin título")})]}),E&&F&&k&&e.jsxs("button",{className:"btn btn-sm d-inline-flex align-items-center gap-2",style:{backgroundColor:"rgb(0, 161, 155)",borderColor:"rgb(0, 161, 155)",color:"white",boxShadow:"rgba(0, 161, 155, 0.2) 0px 4px 10px"},onClick:W,children:[e.jsx("i",{className:"fas fa-edit me-1"})," Editar niveles"]}),!E&&F&&k&&e.jsx("div",{className:"d-flex align-items-center gap-2",children:e.jsx("button",{className:"btn btn-secondary btn-sm",onClick:X,children:"Cancelar"})})]}),e.jsx(le,{descripcion:i,abreviatura:t,cuestionarioId:m,programaId:f,programaNombre:u,onDescripcionChange:s,onAbreviaturaChange:v,readOnly:E}),e.jsx(ce,{levels:b,onChange:y,maxScore:C,readOnly:E}),(D||_)&&e.jsx("div",{className:"alert alert-danger mt-3",children:D||_}),!E&&e.jsx(ue,{onSave:Q,disabled:!U||V||K})]})})]})})};export{Ne as default};
