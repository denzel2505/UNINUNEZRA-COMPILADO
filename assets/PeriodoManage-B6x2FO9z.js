import{r as i,c as P,A as k,S as g,j as e,f as T}from"./index-bvBplxLg.js";import{j as B,y as D}from"./index-CU0cwZ_L.js";import{u as L}from"./index.esm-C1a3o1sh.js";import"./iconBase-BtrJDtBd.js";const y={},R=()=>{const[n,a]=i.useState([]),[c,N]=i.useState([]),[v,E]=i.useState(!1),u=()=>{try{const t=localStorage.getItem("user")||localStorage.getItem("usuario");if(!t)return;const s=JSON.parse(t),o=s?.id??s?.user?.id;return typeof o=="number"||typeof o=="string"?String(o):void 0}catch{return}},m=i.useRef(!1),j=i.useCallback(async(t=!1)=>{if(!(m.current&&!t)){m.current=!0;try{E(!0);const s=u(),o=s?{usuario_id:s}:void 0;y.activos||(y.activos=P.get(k.periodo.base,{params:o})),y.inactivos||(y.inactivos=P.get(k.periodo.inactive,{params:o}));const[b,S]=await Promise.all([y.activos,y.inactivos]);console.debug("[usePeriodos] activosResp.data =",b?.data),console.debug("[usePeriodos] inactivosResp.data =",S?.data);const I=r=>{if(!r)return[];if(Array.isArray(r))return r;if(Array.isArray(r?.periodos))return r.periodos;if(Array.isArray(r?.data))return r.data;if(Array.isArray(r?.data?.data))return r.data.data;if(Array.isArray(r?.data?.items))return r.data.items;if(Array.isArray(r?.result))return r.result;if(Array.isArray(r?.items))return r.items;for(const d of Object.keys(r)){const l=r[d];if(Array.isArray(l)&&l.length>0&&typeof l[0]=="object"&&"nombre"in l[0]&&("fecha_inicio"in l[0]||"fechaFin"in l[0]))return l;if(l&&typeof l=="object")for(const F of Object.keys(l)){const h=l[F];if(Array.isArray(h)&&h.length>0&&typeof h[0]=="object"&&"nombre"in h[0]&&("fecha_inicio"in h[0]||"fechaFin"in h[0]))return h}}return[]},p=I(b?.data),f=I(S?.data);a(Array.isArray(p)?p:[]),N(Array.isArray(f)?f:[])}catch(s){console.error("Error cargarPeriodos:",s),await g.fire({icon:"error",title:"Error",text:s?.message||"Error al cargar los periodos"})}finally{E(!1),y.activos=null,y.inactivos=null}}},[]),x=i.useCallback(async t=>{const s=u(),o=s?{...t,usuario_id:s}:{...t};return(await P.post(k.periodo.create,o))?.data},[]),C=i.useCallback(async(t,s)=>{const o=u(),b=o?{...s,usuario_id:o}:{...s};return(await P.put(k.periodo.byId(t),b))?.data},[]),w=i.useCallback(async t=>{const s=u(),o=s?{usuario_id:s}:void 0;return(await P.delete(k.periodo.byId(t),{params:o}))?.data},[]),_=i.useCallback(async t=>{const s=u(),o=s?{usuario_id:s}:{};return(await P.delete(k.periodo.deactivate(t),{params:o}))?.data},[]),A=i.useCallback(async t=>{const s=u(),o=s?{usuario_id:s}:{};return(await P.post(k.periodo.activate(t),{params:o}))?.data},[]);return{periodos:n,periodosInactivos:c,loading:v,setPeriodos:a,setPeriodosInactivos:N,cargarPeriodos:j,crearPeriodo:x,actualizarPeriodo:C,eliminarPeriodo:w,desactivarPeriodo:_,activarPeriodo:A}},M=({onCreate:n})=>e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsxs("h2",{className:"mb-0 d-flex align-items-center",style:{color:"#1e293b"},children:[e.jsx(B,{className:"me-2",style:{color:"#3b82f6"}}),"Períodos"]}),e.jsxs("button",{onClick:n,className:"btn btn-outline-secondary d-inline-flex align-items-center gap-2 fw-semibold",style:{borderColor:"#00a19B",color:"#00a19B"},children:[e.jsx(D,{}),e.jsx("span",{children:"Crear Período"})]})]}),O=({periodos:n,onDeactivate:a})=>e.jsxs("div",{className:"card shadow-sm border mb-4",style:{backgroundColor:"#ffffff",border:"1px solid rgba(59, 130, 246, 0.1)",marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",style:{background:"linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",color:"white"},children:[e.jsx("h5",{className:"mb-0",children:"Períodos Existentes"}),e.jsx("span",{className:"badge bg-light text-dark",children:n.length})]}),e.jsx("div",{className:"card-body p-0",children:n.length===0?e.jsx("div",{className:"text-center py-5",children:e.jsx("p",{className:"text-muted mb-0",children:"No hay períodos registrados."})}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-borderless mb-0 align-middle",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Nombre"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Inicio"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Fin"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Aperturas"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Acciones"})]})}),e.jsx("tbody",{children:n.map(c=>e.jsxs("tr",{className:"border-bottom",style:{backgroundColor:"#ffffff"},children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"fw-bold",style:{color:"#1e293b"},children:c.nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:c.fecha_inicio})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:c.fecha_fin})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"badge bg-light text-dark",children:c.total_aperturas})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("button",{className:"btn btn-outline-danger w-30 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>a(c.id,c.nombre,c.aperturas_activas),children:"Desactivar"})})]},c.id))})]})})})]}),q=({periodos:n})=>e.jsxs("div",{className:"card shadow-sm border",style:{backgroundColor:"#ffffff",border:"1px solid rgba(108, 117, 125, 0.1)",marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",style:{background:"linear-gradient(135deg, #6c757d 0%, #495057 100%)",color:"white"},children:[e.jsx("h5",{className:"mb-0",children:"Períodos Inactivos"}),e.jsx("span",{className:"badge bg-light text-dark",children:n.length})]}),e.jsx("div",{className:"card-body p-0",children:n.length===0?e.jsx("div",{className:"text-center py-5",children:e.jsx("p",{className:"text-muted mb-0",children:"No hay períodos inactivos."})}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-borderless mb-0 align-middle",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Nombre"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Inicio"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Fin"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Aperturas"})]})}),e.jsx("tbody",{children:n.map(a=>e.jsxs("tr",{className:"border-bottom",style:{backgroundColor:"#ffffff"},children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"fw-bold",style:{color:"#1e293b"},children:a.nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:a.fecha_inicio})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:a.fecha_fin})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"badge bg-light text-dark",children:a.total_aperturas})})]},a.id))})]})})})]}),$=({open:n,inicial:a,title:c,isLoading:N,onClose:v,onSubmit:E})=>{const u=i.useRef(null),[m,j]=i.useState(null),{register:x,handleSubmit:C,formState:{errors:w},reset:_}=L({defaultValues:{nombre:a?.nombre||"",fecha_inicio:a?.fecha_inicio||"",fecha_fin:a?.fecha_fin||""}});T.useEffect(()=>{_({nombre:a?.nombre||"",fecha_inicio:a?.fecha_inicio||"",fecha_fin:a?.fecha_fin||""}),j(null)},[a,_]);const A=t=>{const s=t.fecha_inicio?new Date(t.fecha_inicio):null,o=t.fecha_fin?new Date(t.fecha_fin):null;if(s&&o&&s.getTime()>o.getTime()){j("La fecha de inicio no puede ser mayor a la fecha de fin");return}j(null),u.current&&E(u.current)};return n?e.jsx("div",{className:"modal d-block",tabIndex:-1,role:"dialog",onClick:t=>{t.target===t.currentTarget&&v()},style:{backgroundColor:"rgba(0, 0, 0, 0.6)"},children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",role:"document",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header periodo-modal-header text-white",children:[e.jsxs("h5",{className:"modal-title d-inline-flex align-items-center gap-2 mb-0",children:[e.jsx(B,{}),c]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white","aria-label":"Close",onClick:v})]}),e.jsxs("div",{className:"modal-body",children:[m&&e.jsx("div",{className:"alert alert-warning",role:"alert",children:m}),e.jsxs("form",{ref:u,onSubmit:C(A),children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"nombre",className:"form-label fw-bold",children:"Nombre del Período *"}),e.jsx("input",{placeholder:"Ejemplo: 2025-G",maxLength:6,type:"text",id:"nombre",...x("nombre",{required:!0,maxLength:6}),className:"form-control"}),w.nombre&&e.jsx("div",{className:"form-text text-danger",children:"El nombre es requerido (máx. 6 caracteres)"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"fecha_inicio",className:"form-label fw-bold",children:"Fecha de Inicio *"}),e.jsx("input",{type:"date",id:"fecha_inicio",...x("fecha_inicio",{required:!0}),className:"form-control"}),w.fecha_inicio&&e.jsx("div",{className:"form-text text-danger",children:"La fecha de inicio es obligatoria"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"fecha_fin",className:"form-label fw-bold",children:"Fecha de Fin *"}),e.jsx("input",{type:"date",id:"fecha_fin",...x("fecha_fin",{required:!0}),className:"form-control"}),w.fecha_fin&&e.jsx("div",{className:"form-text text-danger",children:"La fecha de fin es obligatoria"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-sbtn btn-outline-danger w-45 d-inline-flex align-items-center justify-content-center gap-2 fw-semiboldecondary",onClick:v,children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn btn-outline-secondary d-inline-flex align-items-center gap-2 fw-semibold",style:{borderColor:"#00a19B",color:"#00a19B"},disabled:N,children:N?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin"})," ","Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{})," ","Guardar"]})})]})]})]})]})})}):null},W=()=>{const{periodos:n,periodosInactivos:a,cargarPeriodos:c,crearPeriodo:N,actualizarPeriodo:v,desactivarPeriodo:E,activarPeriodo:u}=R(),[m,j]=i.useState(null),[x,C]=i.useState(null),[w,_]=i.useState(!1),[A,t]=i.useState(!1);i.useEffect(()=>{c(!0)},[]),i.useEffect(()=>{console.debug("[PeriodoManage] periodos.length =",n.length,n)},[n]),i.useEffect(()=>{console.debug("[PeriodoManage] periodosInactivos.length =",a.length,a)},[a]);const s=()=>{j(null),t(!0)},o=()=>{t(!1),j(null)},b=async p=>{_(!0);const f=new FormData(p);try{const r={nombre:String(f.get("nombre")||""),fecha_inicio:String(f.get("fecha_inicio")||""),fecha_fin:String(f.get("fecha_fin")||"")},d=m?await v(m.id,r):await N(r);if(await new Promise(l=>setTimeout(l,500)),d.success)g.fire({icon:"success",title:"¡Éxito!",text:d.message,timer:1500,showConfirmButton:!1}),j(null),t(!1),c(!0);else throw new Error(d.error||"Error al procesar la solicitud")}catch(r){console.error("Error:",r),g.fire({icon:"error",title:"Error",text:r instanceof Error?r.message:"Error al procesar la solicitud"})}finally{_(!1)}},S=async(p,f,r)=>{try{let d='No puede desactivar el periodo <strong> "'+f+'"</strong>',l="";if(r>0){l=`<div style="background: #fff3cd; border: 1px solid #ffecb5; padding: 10px; border-radius: 4px; margin: 10px 0;">
          <strong>Advertencia:</strong> Este periodo tiene ${r} aperturas activas. 
          Debe desactivar todas las aperturas primero antes de poder desactivar este periodo.
        </div>`,await g.fire({title:"No se puede desactivar",html:`${d}<br>${l}`,icon:"warning",showCancelButton:!1,confirmButtonText:"Ok"});return}if((await g.fire({title:"¿Desactivar Periodo?",html:`¿Está seguro que desea desactivar el periodo <strong>${f}</strong>?`,icon:"warning",showCancelButton:!0,cancelButtonText:"Cancelar",confirmButtonText:"Desactivar"})).isConfirmed){const h=await E(p);if(h.success)g.fire({icon:"success",title:"¡Desactivado!",text:h.message,timer:1500,showConfirmButton:!1}),c(!0);else throw new Error(h.error||"Error al desactivar el periodo")}}catch(d){console.error("Error:",d),g.fire({icon:"error",title:"Error",text:d instanceof Error?d.message:"Error al desactivar el periodo"})}},I=async(p,f)=>{try{if((await g.fire({title:"¿Activar Periodo?",html:`¿Está seguro que desea activar el periodo <strong>${f}</strong>?`,icon:"question",showCancelButton:!0,cancelButtonText:"Cancelar",confirmButtonText:"Ok"})).isConfirmed){const d=await u(p);if(d.success)g.fire({icon:"success",title:"¡Activado!",text:d.message,timer:1500,showConfirmButton:!1}),c(!0);else throw new Error(d.error||"Error al activar el periodo")}}catch(r){console.error("Error:",r),g.fire({icon:"error",title:"Error",text:r instanceof Error?r.message:"Error al activar el periodo"})}};return e.jsxs("div",{className:"container-fluid py-4 bg-white min-vh-100",children:[e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-12",children:[e.jsx(M,{onCreate:s}),x&&e.jsxs("div",{className:`alert alert-${x.tipo==="success"?"success":x.tipo==="danger"?"danger":"warning"} alert-dismissible fade show`,role:"alert",children:[x.texto,e.jsx("button",{type:"button",className:"btn-close",onClick:()=>C(null)})]}),e.jsx(O,{periodos:n,onDeactivate:S}),e.jsx(q,{periodos:a,onActivate:I})]})}),e.jsx($,{open:A,title:m?"Editar Período":"Crear Nuevo Período",inicial:m?{nombre:m.nombre,fecha_inicio:m.fecha_inicio,fecha_fin:m.fecha_fin}:void 0,isLoading:w,onClose:o,onSubmit:p=>b(p)})]})};export{W as default};
