import{r as n,b as y,A as N,S as p,j as e}from"./index-DMCNFzKN.js";import{j as B,w as F}from"./index-3Pp9WEVo.js";import"./iconBase-D9d8KM2X.js";const D=()=>{const[i,l]=n.useState([]),[s,g]=n.useState([]),[j,v]=n.useState(!1),u=()=>{try{const a=localStorage.getItem("user")||localStorage.getItem("usuario");if(!a)return;const t=JSON.parse(a),o=t?.id??t?.user?.id;return typeof o=="number"||typeof o=="string"?String(o):void 0}catch{return}},d=n.useRef(!1),P=n.useCallback(async(a=!1)=>{if(!(d.current&&!a)){d.current=!0;try{v(!0);const t=u(),o=t?{usuario_id:t}:void 0,[h,k]=await Promise.all([y.get(N.periodo.base,{params:o}),y.get(N.periodo.inactive,{params:o})]);console.debug("[usePeriodos] activosResp.data =",h?.data),console.debug("[usePeriodos] inactivosResp.data =",k?.data);const A=r=>{if(!r)return[];if(Array.isArray(r))return r;if(Array.isArray(r?.periodos))return r.periodos;if(Array.isArray(r?.data))return r.data;if(Array.isArray(r?.data?.data))return r.data.data;if(Array.isArray(r?.data?.items))return r.data.items;if(Array.isArray(r?.result))return r.result;if(Array.isArray(r?.items))return r.items;for(const m of Object.keys(r)){const c=r[m];if(Array.isArray(c)&&c.length>0&&typeof c[0]=="object"&&"nombre"in c[0]&&("fecha_inicio"in c[0]||"fechaFin"in c[0]))return c;if(c&&typeof c=="object")for(const S of Object.keys(c)){const x=c[S];if(Array.isArray(x)&&x.length>0&&typeof x[0]=="object"&&"nombre"in x[0]&&("fecha_inicio"in x[0]||"fechaFin"in x[0]))return x}}return[]},b=A(h?.data),f=A(k?.data);l(Array.isArray(b)?b:[]),g(Array.isArray(f)?f:[])}catch(t){console.error("Error cargarPeriodos:",t),await p.fire({icon:"error",title:"Error",text:t?.message||"Error al cargar los periodos"})}finally{v(!1)}}},[]),w=n.useCallback(async a=>{const t=u(),o=t?{...a,usuario_id:t}:{...a};return(await y.post(N.periodo.create,o))?.data},[]),E=n.useCallback(async(a,t)=>{const o=u(),h=o?{...t,usuario_id:o}:{...t};return(await y.put(N.periodo.byId(a),h))?.data},[]),_=n.useCallback(async a=>{const t=u(),o=t?{usuario_id:t}:void 0;return(await y.delete(N.periodo.byId(a),{params:o}))?.data},[]),C=n.useCallback(async a=>{const t=u(),o=t?{usuario_id:t}:{};return(await y.delete(N.periodo.deactivate(a),{params:o}))?.data},[]),I=n.useCallback(async a=>{const t=u(),o=t?{usuario_id:t}:{};return(await y.post(N.periodo.activate(a),{params:o}))?.data},[]);return{periodos:i,periodosInactivos:s,loading:j,setPeriodos:l,setPeriodosInactivos:g,cargarPeriodos:P,crearPeriodo:w,actualizarPeriodo:E,eliminarPeriodo:_,desactivarPeriodo:C,activarPeriodo:I}},T=({onCreate:i})=>e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsxs("h2",{className:"mb-0 d-flex align-items-center",style:{color:"#1e293b"},children:[e.jsx(B,{className:"me-2",style:{color:"#3b82f6"}}),"Períodos"]}),e.jsxs("button",{onClick:i,className:"btn btn-outline-secondary d-inline-flex align-items-center gap-2 fw-semibold",style:{borderColor:"#00a19B",color:"#00a19B"},children:[e.jsx(F,{}),e.jsx("span",{children:"Crear Período"})]})]}),M=({periodos:i,onDeactivate:l})=>e.jsxs("div",{className:"card shadow-sm border mb-4",style:{backgroundColor:"#ffffff",border:"1px solid rgba(59, 130, 246, 0.1)",marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",style:{background:"linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",color:"white"},children:[e.jsx("h5",{className:"mb-0",children:"Períodos Existentes"}),e.jsx("span",{className:"badge bg-light text-dark",children:i.length})]}),e.jsx("div",{className:"card-body p-0",children:i.length===0?e.jsx("div",{className:"text-center py-5",children:e.jsx("p",{className:"text-muted mb-0",children:"No hay períodos registrados."})}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-borderless mb-0 align-middle",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Nombre"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Inicio"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Fin"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Aperturas"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Acciones"})]})}),e.jsx("tbody",{children:i.map(s=>e.jsxs("tr",{className:"border-bottom",style:{backgroundColor:"#ffffff"},children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"fw-bold",style:{color:"#1e293b"},children:s.nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:s.fecha_inicio})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:s.fecha_fin})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"badge bg-light text-dark",children:s.total_aperturas})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("button",{className:"btn btn-outline-danger w-30 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",onClick:()=>l(s.id,s.nombre,s.aperturas_activas),children:"Desactivar"})})]},s.id))})]})})})]}),R=({periodos:i,onActivate:l})=>e.jsxs("div",{className:"card shadow-sm border",style:{backgroundColor:"#ffffff",border:"1px solid rgba(108, 117, 125, 0.1)",marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"card-header d-flex align-items-center justify-content-between",style:{background:"linear-gradient(135deg, #6c757d 0%, #495057 100%)",color:"white"},children:[e.jsx("h5",{className:"mb-0",children:"Períodos Inactivos"}),e.jsx("span",{className:"badge bg-light text-dark",children:i.length})]}),e.jsx("div",{className:"card-body p-0",children:i.length===0?e.jsx("div",{className:"text-center py-5",children:e.jsx("p",{className:"text-muted mb-0",children:"No hay períodos inactivos."})}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-borderless mb-0 align-middle",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Nombre"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Inicio"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Fin"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Aperturas"}),e.jsx("th",{className:"border-0 px-3 py-3 text-center",children:"Acciones"})]})}),e.jsx("tbody",{children:i.map(s=>e.jsxs("tr",{className:"border-bottom",style:{backgroundColor:"#ffffff"},children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"fw-bold",style:{color:"#1e293b"},children:s.nombre})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:s.fecha_inicio})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"text-muted",children:s.fecha_fin})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("span",{className:"badge bg-light text-dark",children:s.total_aperturas})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("button",{onClick:()=>l(s.id,s.nombre),className:"btn btn-outline-success w-30 d-inline-flex align-items-center justify-content-center gap-2 fw-semibold",children:"Activar"})})]},s.id))})]})})})]}),L=({open:i,inicial:l,title:s,isLoading:g,onClose:j,onSubmit:v})=>{const u=n.useRef(null);return i?e.jsx("div",{className:"modal d-block",tabIndex:-1,role:"dialog",onClick:d=>{d.target===d.currentTarget&&j()},style:{backgroundColor:"rgba(0, 0, 0, 0.6)"},children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",role:"document",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header periodo-modal-header text-white",children:[e.jsxs("h5",{className:"modal-title d-inline-flex align-items-center gap-2 mb-0",children:[e.jsx(B,{}),s]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white","aria-label":"Close",onClick:j})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("form",{ref:u,onSubmit:d=>{d.preventDefault(),u.current&&v(u.current)},children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"nombre",className:"form-label fw-bold",children:"Nombre del Período *"}),e.jsx("input",{placeholder:"Ejemplo: 2025-G",maxLength:6,type:"text",id:"nombre",name:"nombre",defaultValue:l?.nombre||"",required:!0,className:"form-control"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"fecha_inicio",className:"form-label fw-bold",children:"Fecha de Inicio *"}),e.jsx("input",{type:"date",id:"fecha_inicio",name:"fecha_inicio",defaultValue:l?.fecha_inicio||"",required:!0,className:"form-control"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"fecha_fin",className:"form-label fw-bold",children:"Fecha de Fin *"}),e.jsx("input",{type:"date",id:"fecha_fin",name:"fecha_fin",defaultValue:l?.fecha_fin||"",required:!0,className:"form-control"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-sbtn btn-outline-danger w-45 d-inline-flex align-items-center justify-content-center gap-2 fw-semiboldecondary",onClick:j,children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn btn-outline-secondary d-inline-flex align-items-center gap-2 fw-semibold",style:{borderColor:"#00a19B",color:"#00a19B"},disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin"})," ","Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{})," ","Guardar"]})})]})]})})]})})}):null},G=()=>{const{periodos:i,periodosInactivos:l,cargarPeriodos:s,crearPeriodo:g,actualizarPeriodo:j,desactivarPeriodo:v,activarPeriodo:u}=D(),[d,P]=n.useState(null),[w,E]=n.useState(null),[_,C]=n.useState(!1),[I,a]=n.useState(!1);n.useEffect(()=>{s(!0)},[]),n.useEffect(()=>{console.debug("[PeriodoManage] periodos.length =",i.length,i)},[i]),n.useEffect(()=>{console.debug("[PeriodoManage] periodosInactivos.length =",l.length,l)},[l]);const t=()=>{P(null),a(!0)},o=()=>{a(!1),P(null)},h=async b=>{C(!0);const f=new FormData(b);try{const r={nombre:String(f.get("nombre")||""),fecha_inicio:String(f.get("fecha_inicio")||""),fecha_fin:String(f.get("fecha_fin")||"")},m=d?await j(d.id,r):await g(r);if(await new Promise(c=>setTimeout(c,500)),m.success)p.fire({icon:"success",title:"¡Éxito!",text:m.message,timer:1500,showConfirmButton:!1}),P(null),a(!1),s(!0);else throw new Error(m.error||"Error al procesar la solicitud")}catch(r){console.error("Error:",r),p.fire({icon:"error",title:"Error",text:r instanceof Error?r.message:"Error al procesar la solicitud"})}finally{C(!1)}},k=async(b,f,r)=>{try{let m='No puede desactivar el periodo <strong> "'+f+'"</strong>',c="";if(r>0){c=`<div style="background: #fff3cd; border: 1px solid #ffecb5; padding: 10px; border-radius: 4px; margin: 10px 0;">
          <strong>Advertencia:</strong> Este periodo tiene ${r} aperturas activas. 
          Debe desactivar todas las aperturas primero antes de poder desactivar este periodo.
        </div>`,await p.fire({title:"No se puede desactivar",html:`${m}<br>${c}`,icon:"warning",showCancelButton:!1,confirmButtonText:"Ok"});return}if((await p.fire({title:"¿Desactivar Periodo?",html:`¿Está seguro que desea desactivar el periodo <strong>${f}</strong>?`,icon:"warning",showCancelButton:!0,cancelButtonText:"Cancelar",confirmButtonText:"Desactivar"})).isConfirmed){const x=await v(b);if(x.success)p.fire({icon:"success",title:"¡Desactivado!",text:x.message,timer:1500,showConfirmButton:!1}),s(!0);else throw new Error(x.error||"Error al desactivar el periodo")}}catch(m){console.error("Error:",m),p.fire({icon:"error",title:"Error",text:m instanceof Error?m.message:"Error al desactivar el periodo"})}},A=async(b,f)=>{try{if((await p.fire({title:"¿Activar Periodo?",html:`¿Está seguro que desea activar el periodo <strong>${f}</strong>?`,icon:"question",showCancelButton:!0,cancelButtonText:"Cancelar",confirmButtonText:"Ok"})).isConfirmed){const m=await u(b);if(m.success)p.fire({icon:"success",title:"¡Activado!",text:m.message,timer:1500,showConfirmButton:!1}),s(!0);else throw new Error(m.error||"Error al activar el periodo")}}catch(r){console.error("Error:",r),p.fire({icon:"error",title:"Error",text:r instanceof Error?r.message:"Error al activar el periodo"})}};return e.jsxs("div",{className:"container-fluid py-4 bg-white min-vh-100",children:[e.jsx("div",{className:"row",children:e.jsxs("div",{className:"col-12",children:[e.jsx(T,{onCreate:t}),w&&e.jsxs("div",{className:`alert alert-${w.tipo==="success"?"success":w.tipo==="danger"?"danger":"warning"} alert-dismissible fade show`,role:"alert",children:[w.texto,e.jsx("button",{type:"button",className:"btn-close",onClick:()=>E(null)})]}),e.jsx(M,{periodos:i,onDeactivate:k}),e.jsx(R,{periodos:l,onActivate:A})]})}),e.jsx(L,{open:I,title:d?"Editar Período":"Crear Nuevo Período",inicial:d?{nombre:d.nombre,fecha_inicio:d.fecha_inicio,fecha_fin:d.fecha_fin}:void 0,isLoading:_,onClose:o,onSubmit:b=>h(b)})]})};export{G as default};
