import{a as ee,r as g,b as k,A as F,j as t,c as le}from"./index-DMCNFzKN.js";import{u as ce}from"./useAuthentication-BPIDln6A.js";import{i as de,z as ue,C as fe,l as me}from"./index-3Pp9WEVo.js";import"./iconBase-D9d8KM2X.js";function he(){const m=ee(),{user:s}=ce(),[w,i]=g.useState([]),[p,y]=g.useState({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0}),[n,b]=g.useState(null),[S,A]=g.useState(!0),j=g.useCallback(async()=>{A(!0),b(null);try{if(!s?.id)throw new Error("Usuario no autenticado");let a=await k.get(F.seguimiento.detalle,{params:{usuario_id:s.id,_ts:Date.now()}});const d=a?.data?.data??a?.data,x=Array.isArray(d)||Array.isArray(d?.cuestionarios)||Array.isArray(a?.data?.cuestionarios),T=Array.isArray(d)?d.length>0:Array.isArray(d?.cuestionarios)?d.cuestionarios.length>0:Array.isArray(a?.data?.cuestionarios)?a.data.cuestionarios.length>0:!1;if(!x||!T)try{a=await k.get(F.seguimiento.allquiz,{params:{usuario_id:s.id,_ts:Date.now()}})}catch{}if(!a.data)throw new Error("Respuesta vacía del servidor");{const h=a.data?.data??a.data;let u=[];if(Array.isArray(h)&&(u=h),Array.isArray(h?.cuestionarios)&&(u=h.cuestionarios),Array.isArray(a.data?.cuestionarios)&&(u=a.data.cuestionarios),!u.length&&Array.isArray(h?.lista)&&(u=h.lista),!u.length&&a?.data?.success===!1)throw new Error(a.data.error||"Sin datos para mostrar");console.debug("[Seguimiento] payload keys:",Object.keys(h||{})),console.debug("[Seguimiento] cuestionariosData length:",u.length);let N=new Map,P=new Map;try{const e=await k.get(F.asignacion.aperturas,{params:{_ts:Date.now()}}),r=e?.data?.data??e?.data;(Array.isArray(r?.aperturas)?r.aperturas:Array.isArray(e?.data?.aperturas)?e.data.aperturas:[]).forEach(o=>{const c=o?.fecha_inicio??o?.inicio??o?.apertura_inicio??o?.periodo_inicio??o?.start??"",_=o?.fecha_fin??o?.fin??o?.apertura_fin??o?.periodo_fin??o?.end??"";o?.titulo&&N.set(String(o.titulo),{id:Number(o.id),fecha_inicio:c,fecha_fin:_}),o?.id&&P.set(Number(o.id),{id:Number(o.id),fecha_inicio:c,fecha_fin:_,titulo:o.titulo})})}catch{N=new Map}const M=e=>{if(!e||typeof e!="string")return null;const r=e.split(" ")[0]||e,l=/T|\d{2}:\d{2}/.test(e)?e:`${r}T00:00:00`,o=new Date(l);return isNaN(o.getTime())?null:o},O=u.map(e=>{const r=e.apertura_id?parseInt(e.apertura_id,10):0,l=e.cuestionario_id?parseInt(e.cuestionario_id,10):0,o=e.total_estudiantes_asignados?parseInt(e.total_estudiantes_asignados,10):0,c=e.total_estudiantes_completados?parseInt(e.total_estudiantes_completados,10):0;let _;if(typeof e.activo<"u")_=Number(e.activo);else if(e.estado==="abierto"||e.estado==="activo"||e.abierto===1)_=1;else{const v=new Date,E=r?P.get(r):void 0,D=!E&&typeof e.titulo=="string"?N.get(e.titulo):void 0,z=E?.fecha_inicio?M(E.fecha_inicio):D?.fecha_inicio?M(D.fecha_inicio):M(e.fecha_inicio),X=E?.fecha_fin?M(E.fecha_fin):D?.fecha_fin?M(D.fecha_fin):M(e.fecha_fin),Z=z&&X?v>=z&&v<=X:void 0;_=typeof Z=="boolean"&&Z?1:0}const f=r?P.get(r):typeof e.titulo=="string"?N.get(e.titulo):void 0;return{...e,apertura_id:r,cuestionario_id:l,total_estudiantes_asignados:o,total_estudiantes_completados:c,activo:_,fecha_inicio:f?.fecha_inicio??e.fecha_inicio??e.inicio??"",fecha_fin:f?.fecha_fin??e.fecha_fin??e.fin??"",apertura_id_resuelto:r||f?.id||0}}),se=Array.from(new Set(O.filter(e=>!(Number(e.total_estudiantes_asignados)>0)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),W=new Map;await Promise.all(se.map(async e=>{try{const r=await ae(e);W.set(e,r)}catch{}}));const H=O.map(e=>{if(Number(e.total_estudiantes_asignados)>0)return e;const r=Number(e.apertura_id||e.apertura_id_resuelto);if(!r)return e;const l=W.get(r);if(!l)return e;let o=[];Array.isArray(l)?o=l:Array.isArray(l?.estudiantes)&&(o=l.estudiantes);const c=Array.isArray(o)?o.length:Number(l?.total)||0;return{...e,total_estudiantes_asignados:c}});console.debug("[Seguimiento] formateados:",O.length);const re=Array.from(new Set(H.filter(e=>!(Number(e.total_estudiantes_completados)>0)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),G=new Map;await Promise.all(re.map(async e=>{try{const r=await te(e);G.set(e,r)}catch{}}));const K=H.map(e=>{const r=Number(e.total_estudiantes_asignados)||0,l=Number(e.total_estudiantes_completados)||0,o=Number(e.apertura_id||e.apertura_id_resuelto);if(!o||l>0)return e;const c=G.get(o);if(!c&&r>0)return e;let _=Number(c?.total_estudiantes_completados)||Number(c?.total_completados)||Number(c?.completados_total)||Number(c?.estudiantes_completados)||Number(c?.total_estudiantes_finalizados)||Number(c?.completados)||Number(c?.resumen?.completados)||Number(c?.resumen?.total_completados)||(Array.isArray(c?.estudiantes)?c.estudiantes.filter(f=>f?.estado==="completado"||f?.completado===1||f?.intento_id||f?.ha_intentado===1).length:0);if(_===0||r===0){const f=W.get(o);if(f){let v=[];Array.isArray(f)?v=f:Array.isArray(f?.estudiantes)&&(v=f.estudiantes);const E=Array.isArray(v)?v.length:Number(f?.total)||r,D=Array.isArray(v)?v.filter(z=>z?.estado==="completado"||z?.completado===1||z?.intento_id||z?.ha_intentado===1).length:Number(f?.completados)||_;e.total_estudiantes_asignados=E,_=D}}return{...e,total_estudiantes_completados:_}}),oe=Array.from(new Set(K.filter(e=>!(e.fecha_inicio&&e.fecha_fin)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),J=new Map;await Promise.all(oe.map(async e=>{try{const r=await k.get(F.seguimiento.info(e)),l=r?.data?.data??r?.data??{},o=l?.fecha_inicio??l?.inicio??"",c=l?.fecha_fin??l?.fin??"";(o||c)&&J.set(e,{fi:o,ff:c})}catch{}}));const ie=K.map(e=>{if(e.fecha_inicio&&e.fecha_fin)return e;const r=Number(e.apertura_id||e.apertura_id_resuelto),l=J.get(r);return l?{...e,fecha_inicio:e.fecha_inicio||l.fi||"",fecha_fin:e.fecha_fin||l.ff||""}:e}),L=new Map;ie.forEach(e=>{const r=Number(e.apertura_id||e.apertura_id_resuelto)||e.titulo;L.has(r)||L.set(r,e)});const R=Array.from(L.values()).filter(e=>Number(e.total_estudiantes_asignados)>0);i(R);const $=R.reduce((e,r)=>e+(Number(r.total_estudiantes_asignados)||0),0),Q=R.reduce((e,r)=>e+(Number(r.total_estudiantes_completados)||0),0),ne=$>0?Math.round(Q/$*100):0;y({total_cuestionarios:R.length,total_estudiantes_asignados:$,total_estudiantes_completados:Q,porcentaje_global:ne})}}catch(a){console.error("Error al cargar seguimiento:",a);let d="Error desconocido al cargar los datos";a instanceof Error&&(a.message.includes("ERR_NETWORK")||a.message.includes("ECONNREFUSED")?d="No se puede conectar al servidor. Verifique que el servidor esté en ejecución.":a.message.includes("404")?d="Endpoint no encontrado. Verifique la configuración de la API.":d=a.message),b(d),i([]),y({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0})}finally{A(!1)}},[s?.id]),C=g.useRef(!1);globalThis.__seguimientoCaches||(globalThis.__seguimientoCaches={infoCache:new Map,estudiantesCache:new Map,inFlightInfo:new Map,inFlightEst:new Map});const{infoCache:q,estudiantesCache:U,inFlightInfo:V,inFlightEst:I}=globalThis.__seguimientoCaches,B=g.useRef(!1),te=g.useCallback(async a=>{const d=q;if(d.has(a))return d.get(a);const x=V,T=x.get(a);if(T)return await T;const h=k.get(F.seguimiento.info(a),{params:{_ts:Date.now()}}).then(u=>{const N=u?.data?.data??u?.data;return d.set(a,N),x.delete(a),N}).catch(u=>{throw x.delete(a),u});return x.set(a,h),await h},[]),ae=g.useCallback(async a=>{const d=U;if(d.has(a))return d.get(a);const x=I,T=x.get(a);if(T)return await T;const h=k.get(F.seguimiento.estudiantes(a),{params:{_ts:Date.now()}}).then(u=>{const N=u?.data?.data??u?.data;return d.set(a,N),x.delete(a),N}).catch(u=>{throw x.delete(a),u});return x.set(a,h),await h},[]);return g.useEffect(()=>{!s?.id||C.current||(C.current=!0,!B.current&&(B.current=!0,j().finally(()=>{B.current=!1})))},[s?.id,j]),{cuestionarios:w,estadisticas:p,error:n,loading:S,goToDetalle:a=>{m(`/seguimiento/detalle/${a}`)},refetch:async()=>{A(!0),b(null),C.current=!1,await j()},invalidateCaches:()=>{try{q.clear(),U.clear(),V.clear(),I.clear()}catch{}C.current=!1}}}const ge=()=>{const m=ee();return t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[t.jsx("h2",{className:"mb-0 text-dark",children:"Seguimiento de Cuestionarios"}),t.jsxs("button",{className:"btn btn-outline-secondary",onClick:()=>m("/dashboard"),style:{borderColor:"#00a19B",color:"#00a19B"},onMouseOver:s=>{s.currentTarget.style.backgroundColor="#00a19B",s.currentTarget.style.color="white"},onMouseOut:s=>{s.currentTarget.style.backgroundColor="transparent",s.currentTarget.style.color="#00a19B"},children:[t.jsx("i",{className:"fas fa-arrow-left me-2"}),"Volver"]})]})},pe=({estadisticas:m})=>t.jsxs("div",{className:"row g-3 mb-4",children:[t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Cuestionarios"}),t.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:m.total_cuestionarios})]}),t.jsx(de,{size:18,style:{color:"#00a19B"}})]})})}),t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Asignados"}),t.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:m.total_estudiantes_asignados})]}),t.jsx(ue,{size:18,style:{color:"#3498db"}})]})})}),t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Completados"}),t.jsxs("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:[m.total_estudiantes_completados," (",m.porcentaje_global,"%)"]})]}),t.jsx(fe,{size:18,style:{color:"#2ecc71"}})]})})})]}),_e=({cuestionarios:m,onDetalle:s})=>{const w=i=>{if(!i)return"";const p=i.split("T")[0].split("-");return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:i};return t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table table-hover mb-0",children:[t.jsx("thead",{className:"table-light",children:t.jsxs("tr",{children:[t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Título"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Programa"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Periodo"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Fechas"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Progreso"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"}})]})}),t.jsx("tbody",{children:m.map(i=>{const p=i.total_estudiantes_asignados>0?Math.round(i.total_estudiantes_completados/i.total_estudiantes_asignados*100):0,y=Number(i.apertura_id||i.apertura_id_resuelto);return t.jsxs("tr",{children:[t.jsxs("td",{style:{fontSize:"0.8rem"},children:[t.jsx("strong",{className:"text-dark",children:i.titulo}),i.descripcion&&t.jsx("div",{className:"text-muted",style:{fontSize:"0.75rem",marginTop:"0.15rem"},children:i.descripcion.length>30?`${i.descripcion.substring(0,30)}...`:i.descripcion})]}),t.jsx("td",{style:{fontSize:"0.8rem"},children:i.programa_nombre}),t.jsx("td",{style:{fontSize:"0.8rem"},children:i.periodo_nombre}),t.jsx("td",{style:{fontSize:"0.8rem"},children:(()=>{const n=i,b=n.fecha_inicio??n.inicio??n.apertura_inicio??n.periodo_inicio??n.start??"",S=n.fecha_fin??n.fin??n.apertura_fin??n.periodo_fin??n.end??"",A=b?w(String(b)):"-",j=S?w(String(S)):"-";return t.jsxs("div",{className:"d-flex flex-column gap-1",children:[t.jsxs("div",{className:"text-dark",style:{fontSize:"0.75rem"},children:[t.jsx("i",{className:"fas fa-calendar me-1",style:{color:"#00a19B",width:"0.8rem"}}),A]}),t.jsxs("div",{className:"text-muted",style:{fontSize:"0.75rem"},children:[t.jsx("i",{className:"fas fa-calendar-check me-1",style:{color:"#00a19B",width:"0.8rem"}}),j]})]})})()}),t.jsxs("td",{style:{fontSize:"0.8rem"},children:[t.jsxs("div",{className:"text-muted text-center mb-2",style:{fontSize:"0.75rem"},children:[t.jsx("span",{style:{color:"#2ecc71",fontWeight:"600"},children:i.total_estudiantes_completados})," / ",i.total_estudiantes_asignados," Estudiantes"]}),t.jsx("div",{style:{maxWidth:"150px",marginBottom:"1rem"},children:t.jsx("div",{className:"progress mb-2",style:{height:".9rem"},children:t.jsxs("div",{className:"progress-bar",role:"progressbar",style:{width:`${p}%`,backgroundColor:"#2ecc71",fontSize:"0.75rem",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600"},"aria-valuenow":p,"aria-valuemin":0,"aria-valuemax":100,children:[p,"%"]})})})]}),t.jsx("td",{children:t.jsxs("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>s(y),title:"Ver detalles",style:{borderColor:"#00a19B",color:"#00a19B",fontSize:"0.8rem",padding:"0.4rem 0.8rem",transition:"all 0.2s ease"},onMouseOver:n=>{n.currentTarget.style.backgroundColor="#00a19B",n.currentTarget.style.color="white",n.currentTarget.style.transform="translateY(-1px)"},onMouseOut:n=>{n.currentTarget.style.backgroundColor="transparent",n.currentTarget.style.color="#00a19B",n.currentTarget.style.transform="translateY(0)"},children:[t.jsx(me,{size:12,className:"me-1"})," Detalles"]})})]},y||i.titulo)})})]})})},Y=({message:m,type:s="info"})=>{const w=s==="error"?"alert-danger":"alert-info",i=s==="error"?"fas fa-exclamation-triangle":"fas fa-info-circle";return t.jsxs("div",{className:`alert ${w} d-flex align-items-center`,role:"alert",children:[t.jsx("i",{className:`${i} me-2`}),m]})},Se=()=>{const{cuestionarios:m,estadisticas:s,error:w,loading:i,goToDetalle:p,refetch:y,invalidateCaches:n}=he(),b=le();g.useEffect(()=>{n(),y()},[]),g.useEffect(()=>{const j=()=>{y()},C=()=>{document.visibilityState==="visible"&&y()};return window.addEventListener("focus",j),document.addEventListener("visibilitychange",C),()=>{window.removeEventListener("focus",j),document.removeEventListener("visibilitychange",C)}},[y]),g.useEffect(()=>{b?.pathname&&b.pathname.toLowerCase().includes("seguimiento")&&(n(),y())},[b?.pathname]);const S=m.filter(j=>Number(j.activo)===1),A=S.length>0?S:m;return t.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:t.jsx("div",{className:"row justify-content-center",children:t.jsxs("div",{className:"col-12 col-xl-10",children:[t.jsx(ge,{}),t.jsx(pe,{estadisticas:s}),t.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[t.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:t.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[t.jsx("i",{className:"fas fa-list me-2"}),"Cuestionarios"]})}),t.jsx("div",{className:"card-body",children:i?t.jsx(Y,{message:"Cargando...",type:"info"}):w?t.jsx(Y,{message:w,type:"error"}):A.length===0?t.jsx(Y,{message:"Sin cuestionarios abiertos.",type:"info"}):t.jsx(_e,{cuestionarios:A,onDetalle:p})})]})]})})})};export{Se as default};
