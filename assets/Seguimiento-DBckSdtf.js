import{a as q,r as y,c as Y,A as U,j as e}from"./index-4_f5pIIv.js";import{u as L}from"./useAuthentication-OwBKS9a4.js";import{j as K,A as J,G as Q,l as X}from"./index-O__zhACk.js";import"./iconBase-BPqFUofc.js";function Z(){const d=q(),{user:s}=L(),[x,r]=y.useState([]),[u,_]=y.useState({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0}),[n,b]=y.useState(null),[C,w]=y.useState(!0),A=y.useRef(null),M=y.useCallback(async()=>{if(A.current){await A.current;return}w(!0),b(null);try{if(!s?.id)throw new Error("Usuario no autenticado");const h=Number(s?.rol??s?.rol_user??s?.role??s?.tipo??s?.tipo_usuario)===0,m=await Y.get(U.seguimiento.detalle,h?void 0:{params:{usuario_id:s.id}});if(!m.data)throw new Error("Respuesta vacía del servidor");{const o=m.data?.data??m.data;let l=[];if(Array.isArray(o)&&(l=o),Array.isArray(o?.cuestionarios)&&(l=o.cuestionarios),Array.isArray(o?.cuestionarios_seguimiento)&&(l=o.cuestionarios_seguimiento),Array.isArray(o?.["cuestionarios-seguimiento"])&&(l=o["cuestionarios-seguimiento"]),Array.isArray(o?.cta?.cuestionarios_seguimiento)&&(l=o.cta.cuestionarios_seguimiento),Array.isArray(o?.cta?.["cuestionarios-seguimiento"])&&(l=o.cta["cuestionarios-seguimiento"]),Array.isArray(m.data?.cuestionarios)&&(l=m.data.cuestionarios),!l.length&&Array.isArray(o?.lista)&&(l=o.lista),!l.length&&o&&typeof o=="object"){const t=Object.values(o).filter(a=>Array.isArray(a));for(const a of t)if(Array.isArray(a)&&a.length&&typeof a[0]=="object"&&("apertura_id"in a[0]||"cuestionario_id"in a[0]||"titulo"in a[0])){l=a;break}if(!l.length&&o.cta&&typeof o.cta=="object"){const a=Object.values(o.cta).filter(i=>Array.isArray(i));for(const i of a)if(Array.isArray(i)&&i.length&&typeof i[0]=="object"&&("apertura_id"in i[0]||"cuestionario_id"in i[0]||"titulo"in i[0])){l=i;break}}}if(!l.length&&m?.data?.success===!1)throw new Error(m.data.error||"Sin datos para mostrar");console.debug("[Seguimiento] payload keys:",Object.keys(o||{})),console.debug("[Seguimiento] cuestionariosData length:",l.length);const N=t=>{if(!t||typeof t!="string")return null;const a=t.split(" ")[0]||t,i=/T|\d{2}:\d{2}/.test(t)?t:`${a}T00:00:00`,f=new Date(i);return isNaN(f.getTime())?null:f},S=l.map(t=>{const a=t.apertura_id?parseInt(t.apertura_id,10):0,i=t.cuestionario_id?parseInt(t.cuestionario_id,10):0,f=t.total_estudiantes_asignados?parseInt(t.total_estudiantes_asignados,10):0,j=t.total_estudiantes_completados?parseInt(t.total_estudiantes_completados,10):0;let g;if(typeof t.activo<"u")g=Number(t.activo);else if(t.estado==="abierto"||t.estado==="activo"||t.abierto===1)g=1;else{const p=new Date,E=N(t.fecha_inicio??t.inicio),k=N(t.fecha_fin??t.fin),v=E&&k?p>=E&&p<=k:void 0;g=typeof v=="boolean"&&v?1:0}return{...t,apertura_id:a,cuestionario_id:i,total_estudiantes_asignados:f,total_estudiantes_completados:j,activo:g,fecha_inicio:t.fecha_inicio??t.inicio??"",fecha_fin:t.fecha_fin??t.fin??"",apertura_id_resuelto:a}}),V=Array.from(new Set(S.filter(t=>!(Number(t.total_estudiantes_asignados)>0)).map(t=>Number(t.apertura_id||t.apertura_id_resuelto)).filter(t=>!!t))),O=new Map;await Promise.all(V.map(async t=>{try{const a=await I(t);O.set(t,a)}catch{}}));const G=S.map(t=>{if(Number(t.total_estudiantes_asignados)>0)return t;const a=Number(t.apertura_id||t.apertura_id_resuelto);if(!a)return t;const i=O.get(a);if(!i)return t;let f=[];Array.isArray(i)?f=i:Array.isArray(i?.estudiantes)&&(f=i.estudiantes);const j=Array.isArray(f)?f.length:Number(i?.total)||0;return{...t,total_estudiantes_asignados:j}}).map(t=>{const a=Number(t.total_estudiantes_asignados)||0,i=Number(t.total_estudiantes_completados)||0,f=Number(t.apertura_id||t.apertura_id_resuelto);if(!f||i>0)return t;let j=i;if(j===0||a===0){const g=O.get(f);if(g){let p=[];Array.isArray(g)?p=g:Array.isArray(g?.estudiantes)&&(p=g.estudiantes);const E=Array.isArray(p)?p.length:Number(g?.total)||a,k=Array.isArray(p)?p.filter(v=>v?.estado==="completado"||v?.completado===1||v?.intento_id||v?.ha_intentado===1).length:Number(g?.completados)||j;t.total_estudiantes_asignados=E,j=k}}return{...t,total_estudiantes_completados:j}}),D=new Map;G.forEach(t=>{const a=Number(t.apertura_id||t.apertura_id_resuelto)||t.titulo;D.has(a)||D.set(a,t)});const z=Array.from(D.values()).filter(t=>Number(t.total_estudiantes_asignados)>0);r(z);const B=z.reduce((t,a)=>t+(Number(a.total_estudiantes_asignados)||0),0),$=z.reduce((t,a)=>t+(Number(a.total_estudiantes_completados)||0),0),H=B>0?Math.round($/B*100):0;_({total_cuestionarios:z.length,total_estudiantes_asignados:B,total_estudiantes_completados:$,porcentaje_global:H})}}catch(c){console.error("Error al cargar seguimiento:",c);let h="Error desconocido al cargar los datos";c instanceof Error&&(c.message.includes("ERR_NETWORK")||c.message.includes("ECONNREFUSED")?h="No se puede conectar al servidor. Verifique que el servidor esté en ejecución.":c.message.includes("404")?h="Endpoint no encontrado. Verifique la configuración de la API.":h=c.message),b(h),r([]),_({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0})}finally{w(!1)}},[s?.id]),T=y.useRef(!1);globalThis.__seguimientoEstudiantesCache||(globalThis.__seguimientoEstudiantesCache={estudiantesCache:new Map,inFlightEst:new Map});const{estudiantesCache:W,inFlightEst:P}=globalThis.__seguimientoEstudiantesCache,R=y.useRef(!1),I=y.useCallback(async c=>{const h=W;if(h.has(c))return h.get(c);const m=P,o=m.get(c);if(o)return await o;const l=Y.get(U.seguimiento.estudiantes(c)).then(N=>{const S=N?.data?.data??N?.data;return h.set(c,S),m.delete(c),S}).catch(N=>{throw m.delete(c),N});return m.set(c,l),await l},[]);return y.useEffect(()=>{!s?.id||T.current||(T.current=!0,!R.current&&(R.current=!0,A.current=M().finally(()=>{R.current=!1,A.current=null})))},[s?.id,M]),{cuestionarios:x,estadisticas:u,error:n,loading:C,goToDetalle:c=>{d(`/seguimiento/detalle/${c}`)},refetch:async()=>{w(!0),b(null),T.current=!1,await M()},invalidateCaches:()=>{try{W.clear(),P.clear()}catch{}T.current=!1}}}const ee=()=>{const d=q();return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h2",{className:"mb-0 text-dark",children:"Seguimiento de Cuestionarios"}),e.jsxs("button",{className:"btn btn-outline-secondary",onClick:()=>d("/dashboard"),style:{borderColor:"#00a19B",color:"#00a19B"},onMouseOver:s=>{s.currentTarget.style.backgroundColor="#00a19B",s.currentTarget.style.color="white"},onMouseOut:s=>{s.currentTarget.style.backgroundColor="transparent",s.currentTarget.style.color="#00a19B"},children:[e.jsx("i",{className:"fas fa-arrow-left me-2"}),"Volver"]})]})},te=({estadisticas:d})=>e.jsxs("div",{className:"row g-3 mb-4",children:[e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Cuestionarios"}),e.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:d.total_cuestionarios})]}),e.jsx(K,{size:18,style:{color:"#00a19B"}})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Asignados"}),e.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:d.total_estudiantes_asignados})]}),e.jsx(J,{size:18,style:{color:"#3498db"}})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Completados"}),e.jsxs("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:[d.total_estudiantes_completados," (",d.porcentaje_global,"%)"]})]}),e.jsx(Q,{size:18,style:{color:"#2ecc71"}})]})})})]}),se=({cuestionarios:d,onDetalle:s})=>{const x=r=>{if(!r)return"";const u=r.split("T")[0].split("-");return u.length===3?`${u[2]}/${u[1]}/${u[0]}`:r};return e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Título"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Programa"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Periodo"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Fechas"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Progreso"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"}})]})}),e.jsx("tbody",{children:d.map(r=>{const u=r.total_estudiantes_asignados>0?Math.round(r.total_estudiantes_completados/r.total_estudiantes_asignados*100):0,_=Number(r.apertura_id||r.apertura_id_resuelto);return e.jsxs("tr",{children:[e.jsxs("td",{style:{fontSize:"0.8rem"},children:[e.jsx("strong",{className:"text-dark",children:r.titulo}),r.descripcion&&e.jsx("div",{className:"text-muted",style:{fontSize:"0.75rem",marginTop:"0.15rem"},children:r.descripcion.length>30?`${r.descripcion.substring(0,30)}...`:r.descripcion})]}),e.jsx("td",{style:{fontSize:"0.8rem"},children:r.programa_nombre}),e.jsx("td",{style:{fontSize:"0.8rem"},children:r.periodo_nombre}),e.jsx("td",{style:{fontSize:"0.8rem"},children:(()=>{const n=r,b=n.fecha_inicio??n.inicio??n.apertura_inicio??n.periodo_inicio??n.start??"",C=n.fecha_fin??n.fin??n.apertura_fin??n.periodo_fin??n.end??"",w=b?x(String(b)):"-",A=C?x(String(C)):"-";return e.jsxs("div",{className:"d-flex flex-column gap-1",children:[e.jsxs("div",{className:"text-dark",style:{fontSize:"0.75rem"},children:[e.jsx("i",{className:"fas fa-calendar me-1",style:{color:"#00a19B",width:"0.8rem"}}),w]}),e.jsxs("div",{className:"text-muted",style:{fontSize:"0.75rem"},children:[e.jsx("i",{className:"fas fa-calendar-check me-1",style:{color:"#00a19B",width:"0.8rem"}}),A]})]})})()}),e.jsxs("td",{style:{fontSize:"0.8rem"},children:[e.jsxs("div",{className:"text-muted text-center mb-2",style:{fontSize:"0.75rem"},children:[e.jsx("span",{style:{color:"#2ecc71",fontWeight:"600"},children:r.total_estudiantes_completados})," / ",r.total_estudiantes_asignados," Estudiantes"]}),e.jsx("div",{style:{maxWidth:"150px",marginBottom:"1rem"},children:e.jsx("div",{className:"progress mb-2",style:{height:".9rem"},children:e.jsxs("div",{className:"progress-bar",role:"progressbar",style:{width:`${u}%`,backgroundColor:"#2ecc71",fontSize:"0.75rem",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600"},"aria-valuenow":u,"aria-valuemin":0,"aria-valuemax":100,children:[u,"%"]})})})]}),e.jsx("td",{children:e.jsxs("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>s(_),title:"Ver detalles",style:{borderColor:"#00a19B",color:"#00a19B",fontSize:"0.8rem",padding:"0.4rem 0.8rem",transition:"all 0.2s ease"},onMouseOver:n=>{n.currentTarget.style.backgroundColor="#00a19B",n.currentTarget.style.color="white",n.currentTarget.style.transform="translateY(-1px)"},onMouseOut:n=>{n.currentTarget.style.backgroundColor="transparent",n.currentTarget.style.color="#00a19B",n.currentTarget.style.transform="translateY(0)"},children:[e.jsx(X,{size:12,className:"me-1"})," Detalles"]})})]},_||r.titulo)})})]})})},F=({message:d,type:s="info"})=>{const x=s==="error"?"alert-danger":"alert-info",r=s==="error"?"fas fa-exclamation-triangle":"fas fa-info-circle";return e.jsxs("div",{className:`alert ${x} d-flex align-items-center`,role:"alert",children:[e.jsx("i",{className:`${r} me-2`}),d]})},me=()=>{const{cuestionarios:d,estadisticas:s,error:x,loading:r,goToDetalle:u}=Z(),_=d.filter(b=>Number(b.activo)===1),n=_.length>0?_:d;return e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(ee,{}),e.jsx(te,{estadisticas:s}),e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx("i",{className:"fas fa-list me-2"}),"Cuestionarios"]})}),e.jsx("div",{className:"card-body",children:r?e.jsx(F,{message:"Cargando...",type:"info"}):x?e.jsx(F,{message:x,type:"error"}):n.length===0?e.jsx(F,{message:"Sin cuestionarios abiertos.",type:"info"}):e.jsx(se,{cuestionarios:n,onDetalle:u})})]})]})})})};export{me as default};
