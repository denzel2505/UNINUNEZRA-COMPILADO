import{a as Q,r as _,b as C,A as z,j as t}from"./index-DaOhVVWd.js";import{u as ue}from"./useAuthentication-Dn9EKM7N.js";import{i as me,A as fe,E as he,l as ge}from"./index-B8Flq_4W.js";import"./iconBase-Cr-ff6zs.js";function ye(){const m=Q(),{user:s}=ue(),[x,o]=_.useState([]),[h,N]=_.useState({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0}),[g,M]=_.useState(null),[X,$]=_.useState(!0),Y=_.useCallback(async()=>{$(!0),M(null);try{if(!s?.id)throw new Error("Usuario no autenticado");let a=await C.get(z.seguimiento.detalle,{params:{usuario_id:s.id}});const l=a?.data?.data??a?.data,y=Array.isArray(l)||Array.isArray(l?.cuestionarios)||Array.isArray(a?.data?.cuestionarios),w=Array.isArray(l)?l.length>0:Array.isArray(l?.cuestionarios)?l.cuestionarios.length>0:Array.isArray(a?.data?.cuestionarios)?a.data.cuestionarios.length>0:!1;if(!y||!w)try{a=await C.get(z.seguimiento.allquiz,{params:{usuario_id:s.id}})}catch{}if(!a.data)throw new Error("Respuesta vacía del servidor");{const f=a.data?.data??a.data;let c=[];if(Array.isArray(f)&&(c=f),Array.isArray(f?.cuestionarios)&&(c=f.cuestionarios),Array.isArray(a.data?.cuestionarios)&&(c=a.data.cuestionarios),!c.length&&Array.isArray(f?.lista)&&(c=f.lista),!c.length&&a?.data?.success===!1)throw new Error(a.data.error||"Sin datos para mostrar");console.debug("[Seguimiento] payload keys:",Object.keys(f||{})),console.debug("[Seguimiento] cuestionariosData length:",c.length);let p=new Map,D=new Map,F=[];try{const e=await C.get(z.asignacion.aperturas),r=e?.data?.data??e?.data,i=Array.isArray(r?.aperturas)?r.aperturas:Array.isArray(e?.data?.aperturas)?e.data.aperturas:[];F=i,i.forEach(n=>{n?.titulo&&p.set(String(n.titulo),{id:Number(n.id),fecha_inicio:n.fecha_inicio,fecha_fin:n.fecha_fin}),n?.id&&D.set(Number(n.id),{id:Number(n.id),fecha_inicio:n.fecha_inicio,fecha_fin:n.fecha_fin,titulo:n.titulo})})}catch{F=[],p=new Map}const S=e=>{if(!e||typeof e!="string")return null;const r=e.split(" ")[0]||e,i=/T|\d{2}:\d{2}/.test(e)?e:`${r}T00:00:00`,n=new Date(i);return isNaN(n.getTime())?null:n},B=c.map(e=>{const r=e.apertura_id?parseInt(e.apertura_id,10):0,i=e.cuestionario_id?parseInt(e.cuestionario_id,10):0,n=e.total_estudiantes_asignados?parseInt(e.total_estudiantes_asignados,10):0,d=e.total_estudiantes_completados?parseInt(e.total_estudiantes_completados,10):0;let b;if(typeof e.activo<"u")b=Number(e.activo);else if(e.estado==="abierto"||e.estado==="activo"||e.abierto===1)b=1;else{const j=new Date,v=r?D.get(r):void 0,T=!v&&typeof e.titulo=="string"?p.get(e.titulo):void 0,A=v?.fecha_inicio?S(v.fecha_inicio):T?.fecha_inicio?S(T.fecha_inicio):S(e.fecha_inicio),K=v?.fecha_fin?S(v.fecha_fin):T?.fecha_fin?S(T.fecha_fin):S(e.fecha_fin),J=A&&K?j>=A&&j<=K:void 0;b=typeof J=="boolean"&&J?1:0}const u=r?D.get(r):typeof e.titulo=="string"?p.get(e.titulo):void 0;return{...e,apertura_id:r,cuestionario_id:i,total_estudiantes_asignados:n,total_estudiantes_completados:d,activo:b,fecha_inicio:u?.fecha_inicio??e.fecha_inicio??"",fecha_fin:u?.fecha_fin??e.fecha_fin??"",apertura_id_resuelto:r||u?.id||0}}),oe=Array.from(new Set(B.filter(e=>!(Number(e.total_estudiantes_asignados)>0)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),O=new Map;await Promise.all(oe.map(async e=>{try{const r=await re(e);O.set(e,r)}catch{}}));const I=B.map(e=>{if(Number(e.total_estudiantes_asignados)>0)return e;const r=Number(e.apertura_id||e.apertura_id_resuelto);if(!r)return e;const i=O.get(r);if(!i)return e;let n=[];Array.isArray(i)?n=i:Array.isArray(i?.estudiantes)&&(n=i.estudiantes);const d=Array.isArray(n)?n.length:Number(i?.total)||0;return{...e,total_estudiantes_asignados:d}});console.debug("[Seguimiento] formateados:",B.length);const ne=Array.from(new Set(I.filter(e=>!(Number(e.total_estudiantes_completados)>0)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),L=new Map;await Promise.all(ne.map(async e=>{try{const r=await se(e);L.set(e,r)}catch{}}));const ie=I.map(e=>{const r=Number(e.total_estudiantes_asignados)||0,i=Number(e.total_estudiantes_completados)||0,n=Number(e.apertura_id||e.apertura_id_resuelto);if(!n||i>0)return e;const d=L.get(n);if(!d&&r>0)return e;let b=Number(d?.total_estudiantes_completados)||Number(d?.total_completados)||Number(d?.completados_total)||Number(d?.estudiantes_completados)||Number(d?.total_estudiantes_finalizados)||Number(d?.completados)||Number(d?.resumen?.completados)||Number(d?.resumen?.total_completados)||(Array.isArray(d?.estudiantes)?d.estudiantes.filter(u=>u?.estado==="completado"||u?.completado===1||u?.intento_id||u?.ha_intentado===1).length:0);if(b===0||r===0){const u=O.get(n);if(u){let j=[];Array.isArray(u)?j=u:Array.isArray(u?.estudiantes)&&(j=u.estudiantes);const v=Array.isArray(j)?j.length:Number(u?.total)||r,T=Array.isArray(j)?j.filter(A=>A?.estado==="completado"||A?.completado===1||A?.intento_id||A?.ha_intentado===1).length:Number(u?.completados)||b;e.total_estudiantes_asignados=v,b=T}}return{...e,total_estudiantes_completados:b}}),le=new Set,U=new Date,V=e=>{if(!e)return null;const r=String(e),i=r.split(" ")[0]||r,n=/(T|\d{2}:\d{2})/.test(r)?r:`${i}T00:00:00`,d=new Date(n);return isNaN(d.getTime())?null:d};(F||[]).forEach(e=>{const r=V(e?.fecha_inicio),i=V(e?.fecha_fin);e?.id&&r&&i&&U>=r&&U<=i&&le.add(Number(e.id))});const ce=ie,P=new Map;ce.forEach(e=>{const r=Number(e.apertura_id||e.apertura_id_resuelto)||e.titulo;P.has(r)||P.set(r,e)});const H=Array.from(P.values());console.debug("[Seguimiento] final size:",H.length);const E=H.filter(e=>Number(e.total_estudiantes_asignados)>0);o(E);const R=E.reduce((e,r)=>e+(Number(r.total_estudiantes_asignados)||0),0),G=E.reduce((e,r)=>e+(Number(r.total_estudiantes_completados)||0),0),de=R>0?Math.round(G/R*100):0;N({total_cuestionarios:E.length,total_estudiantes_asignados:R,total_estudiantes_completados:G,porcentaje_global:de})}}catch(a){console.error("Error al cargar seguimiento:",a);let l="Error desconocido al cargar los datos";a instanceof Error&&(a.message.includes("ERR_NETWORK")||a.message.includes("ECONNREFUSED")?l="No se puede conectar al servidor. Verifique que el servidor esté en ejecución.":a.message.includes("404")?l="Endpoint no encontrado. Verifique la configuración de la API.":l=a.message),M(l),o([]),N({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0})}finally{$(!1)}},[s?.id]),q=_.useRef(!1);globalThis.__seguimientoCaches||(globalThis.__seguimientoCaches={infoCache:new Map,estudiantesCache:new Map,inFlightInfo:new Map,inFlightEst:new Map});const{infoCache:Z,estudiantesCache:ee,inFlightInfo:te,inFlightEst:ae}=globalThis.__seguimientoCaches,k=_.useRef(!1),se=_.useCallback(async a=>{const l=Z;if(l.has(a))return l.get(a);const y=te,w=y.get(a);if(w)return await w;const f=C.get(z.seguimiento.info(a)).then(c=>{const p=c?.data?.data??c?.data;return l.set(a,p),y.delete(a),p}).catch(c=>{throw y.delete(a),c});return y.set(a,f),await f},[]),re=_.useCallback(async a=>{const l=ee;if(l.has(a))return l.get(a);const y=ae,w=y.get(a);if(w)return await w;const f=C.get(z.seguimiento.estudiantes(a)).then(c=>{const p=c?.data?.data??c?.data;return l.set(a,p),y.delete(a),p}).catch(c=>{throw y.delete(a),c});return y.set(a,f),await f},[]);return _.useEffect(()=>{!s?.id||q.current||(q.current=!0,!k.current&&(k.current=!0,Y().finally(()=>{k.current=!1})))},[s?.id,Y]),{cuestionarios:x,estadisticas:h,error:g,loading:X,goToDetalle:a=>{m(`/seguimiento/detalle/${a}`)}}}const pe=()=>{const m=Q();return t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[t.jsx("h2",{className:"mb-0 text-dark",children:"Seguimiento de Cuestionarios"}),t.jsxs("button",{className:"btn btn-outline-secondary",onClick:()=>m("/dashboard"),style:{borderColor:"#00a19B",color:"#00a19B"},onMouseOver:s=>{s.currentTarget.style.backgroundColor="#00a19B",s.currentTarget.style.color="white"},onMouseOut:s=>{s.currentTarget.style.backgroundColor="transparent",s.currentTarget.style.color="#00a19B"},children:[t.jsx("i",{className:"fas fa-arrow-left me-2"}),"Volver"]})]})},_e=({estadisticas:m})=>t.jsxs("div",{className:"row g-3 mb-4",children:[t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Cuestionarios"}),t.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:m.total_cuestionarios})]}),t.jsx(me,{size:18,style:{color:"#00a19B"}})]})})}),t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Asignados"}),t.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:m.total_estudiantes_asignados})]}),t.jsx(fe,{size:18,style:{color:"#3498db"}})]})})}),t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Completados"}),t.jsxs("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:[m.total_estudiantes_completados," (",m.porcentaje_global,"%)"]})]}),t.jsx(he,{size:18,style:{color:"#2ecc71"}})]})})})]}),xe=({cuestionarios:m,onDetalle:s})=>{const x=o=>{if(!o)return"";const h=o.split("T")[0].split("-");return h.length===3?`${h[2]}/${h[1]}/${h[0]}`:o};return t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table table-hover mb-0",children:[t.jsx("thead",{className:"table-light",children:t.jsxs("tr",{children:[t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Título"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Programa"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Periodo"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Fechas"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Progreso"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"}})]})}),t.jsx("tbody",{children:m.map(o=>{const h=o.total_estudiantes_asignados>0?Math.round(o.total_estudiantes_completados/o.total_estudiantes_asignados*100):0,N=Number(o.apertura_id||o.apertura_id_resuelto);return t.jsxs("tr",{children:[t.jsxs("td",{style:{fontSize:"0.8rem"},children:[t.jsx("strong",{className:"text-dark",children:o.titulo}),o.descripcion&&t.jsx("div",{className:"text-muted",style:{fontSize:"0.75rem",marginTop:"0.15rem"},children:o.descripcion.length>30?`${o.descripcion.substring(0,30)}...`:o.descripcion})]}),t.jsx("td",{style:{fontSize:"0.8rem"},children:o.programa_nombre}),t.jsx("td",{style:{fontSize:"0.8rem"},children:o.periodo_nombre}),t.jsx("td",{style:{fontSize:"0.8rem"},children:t.jsxs("div",{className:"d-flex flex-column gap-1",children:[t.jsxs("div",{className:"text-muted",style:{fontSize:"0.75rem"},children:[t.jsx("i",{className:"fas fa-calendar me-1",style:{color:"#00a19B",width:"0.8rem"}}),x(o.fecha_inicio)]}),t.jsxs("div",{className:"text-muted",style:{fontSize:"0.75rem"},children:[t.jsx("i",{className:"fas fa-calendar-check me-1",style:{color:"#00a19B",width:"0.8rem"}}),x(o.fecha_fin)]})]})}),t.jsx("td",{style:{fontSize:"0.8rem"},children:t.jsxs("div",{style:{maxWidth:"150px"},children:[t.jsx("div",{className:"progress mb-2",style:{height:"0.5rem"},children:t.jsxs("div",{className:"progress-bar",role:"progressbar",style:{width:`${h}%`,backgroundColor:"#2ecc71",fontSize:"0.65rem",display:"flex",alignItems:"center",justifyContent:"center",color:"white"},"aria-valuenow":h,"aria-valuemin":0,"aria-valuemax":100,children:[h,"%"]})}),t.jsxs("div",{className:"text-muted",style:{fontSize:"0.75rem"},children:[t.jsx("span",{style:{color:"#2ecc71",fontWeight:"600"},children:o.total_estudiantes_completados})," / ",o.total_estudiantes_asignados]})]})}),t.jsx("td",{children:t.jsxs("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>s(N),title:"Ver detalles",style:{borderColor:"#00a19B",color:"#00a19B",fontSize:"0.8rem",padding:"0.4rem 0.8rem",transition:"all 0.2s ease"},onMouseOver:g=>{g.currentTarget.style.backgroundColor="#00a19B",g.currentTarget.style.color="white",g.currentTarget.style.transform="translateY(-1px)"},onMouseOut:g=>{g.currentTarget.style.backgroundColor="transparent",g.currentTarget.style.color="#00a19B",g.currentTarget.style.transform="translateY(0)"},children:[t.jsx(ge,{size:12,className:"me-1"})," Detalles"]})})]},N||o.titulo)})})]})})},W=({message:m,type:s="info"})=>{const x=s==="error"?"alert-danger":"alert-info",o=s==="error"?"fas fa-exclamation-triangle":"fas fa-info-circle";return t.jsxs("div",{className:`alert ${x} d-flex align-items-center`,role:"alert",children:[t.jsx("i",{className:`${o} me-2`}),m]})},Ae=()=>{const{cuestionarios:m,estadisticas:s,error:x,loading:o,goToDetalle:h}=ye(),N=m.filter(M=>Number(M.activo)===1),g=N.length>0?N:m;return t.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:t.jsx("div",{className:"row justify-content-center",children:t.jsxs("div",{className:"col-12 col-xl-10",children:[t.jsx(pe,{}),t.jsx(_e,{estadisticas:s}),t.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[t.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:t.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[t.jsx("i",{className:"fas fa-list me-2"}),"Cuestionarios"]})}),t.jsx("div",{className:"card-body",children:o?t.jsx(W,{message:"Cargando...",type:"info"}):x?t.jsx(W,{message:x,type:"error"}):g.length===0?t.jsx(W,{message:"Sin cuestionarios abiertos.",type:"info"}):t.jsx(xe,{cuestionarios:g,onDetalle:h})})]})]})})})};export{Ae as default};
