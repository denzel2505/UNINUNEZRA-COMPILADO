import{a as te,r as h,b as F,A as R,j as t,c as ce}from"./index-CkH1TajL.js";import{u as de}from"./useAuthentication-weheBjpg.js";import{i as ue,z as fe,C as me,l as he}from"./index-DTaE7NR5.js";import"./iconBase-DH91qiyX.js";function ge(){const m=te(),{user:s}=de(),[v,i]=h.useState([]),[p,y]=h.useState({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0}),[n,j]=h.useState(null),[S,A]=h.useState(!0),x=h.useRef(null),M=h.useCallback(async()=>{if(x.current){await x.current;return}A(!0),j(null);try{if(!s?.id)throw new Error("Usuario no autenticado");let a=await F.get(R.seguimiento.detalle,{params:{usuario_id:s.id}});const d=a?.data?.data??a?.data,b=Array.isArray(d)||Array.isArray(d?.cuestionarios)||Array.isArray(a?.data?.cuestionarios),C=Array.isArray(d)?d.length>0:Array.isArray(d?.cuestionarios)?d.cuestionarios.length>0:Array.isArray(a?.data?.cuestionarios)?a.data.cuestionarios.length>0:!1;if(!b||!C)try{a=await F.get(R.seguimiento.allquiz,{params:{usuario_id:s.id}})}catch{}if(!a.data)throw new Error("Respuesta vacía del servidor");{const g=a.data?.data??a.data;let u=[];if(Array.isArray(g)&&(u=g),Array.isArray(g?.cuestionarios)&&(u=g.cuestionarios),Array.isArray(a.data?.cuestionarios)&&(u=a.data.cuestionarios),!u.length&&Array.isArray(g?.lista)&&(u=g.lista),!u.length&&a?.data?.success===!1)throw new Error(a.data.error||"Sin datos para mostrar");console.debug("[Seguimiento] payload keys:",Object.keys(g||{})),console.debug("[Seguimiento] cuestionariosData length:",u.length);let N=new Map,O=new Map;try{const e=await F.get(R.asignacion.aperturas),r=e?.data?.data??e?.data;(Array.isArray(r?.aperturas)?r.aperturas:Array.isArray(e?.data?.aperturas)?e.data.aperturas:[]).forEach(o=>{const c=o?.fecha_inicio??o?.inicio??o?.apertura_inicio??o?.periodo_inicio??o?.start??"",_=o?.fecha_fin??o?.fin??o?.apertura_fin??o?.periodo_fin??o?.end??"";o?.titulo&&N.set(String(o.titulo),{id:Number(o.id),fecha_inicio:c,fecha_fin:_}),o?.id&&O.set(Number(o.id),{id:Number(o.id),fecha_inicio:c,fecha_fin:_,titulo:o.titulo})})}catch{N=new Map}const z=e=>{if(!e||typeof e!="string")return null;const r=e.split(" ")[0]||e,l=/T|\d{2}:\d{2}/.test(e)?e:`${r}T00:00:00`,o=new Date(l);return isNaN(o.getTime())?null:o},W=u.map(e=>{const r=e.apertura_id?parseInt(e.apertura_id,10):0,l=e.cuestionario_id?parseInt(e.cuestionario_id,10):0,o=e.total_estudiantes_asignados?parseInt(e.total_estudiantes_asignados,10):0,c=e.total_estudiantes_completados?parseInt(e.total_estudiantes_completados,10):0;let _;if(typeof e.activo<"u")_=Number(e.activo);else if(e.estado==="abierto"||e.estado==="activo"||e.abierto===1)_=1;else{const w=new Date,T=r?O.get(r):void 0,k=!T&&typeof e.titulo=="string"?N.get(e.titulo):void 0,E=T?.fecha_inicio?z(T.fecha_inicio):k?.fecha_inicio?z(k.fecha_inicio):z(e.fecha_inicio),Z=T?.fecha_fin?z(T.fecha_fin):k?.fecha_fin?z(k.fecha_fin):z(e.fecha_fin),ee=E&&Z?w>=E&&w<=Z:void 0;_=typeof ee=="boolean"&&ee?1:0}const f=r?O.get(r):typeof e.titulo=="string"?N.get(e.titulo):void 0;return{...e,apertura_id:r,cuestionario_id:l,total_estudiantes_asignados:o,total_estudiantes_completados:c,activo:_,fecha_inicio:f?.fecha_inicio??e.fecha_inicio??e.inicio??"",fecha_fin:f?.fecha_fin??e.fecha_fin??e.fin??"",apertura_id_resuelto:r||f?.id||0}}),re=Array.from(new Set(W.filter(e=>!(Number(e.total_estudiantes_asignados)>0)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),L=new Map;await Promise.all(re.map(async e=>{try{const r=await se(e);L.set(e,r)}catch{}}));const G=W.map(e=>{if(Number(e.total_estudiantes_asignados)>0)return e;const r=Number(e.apertura_id||e.apertura_id_resuelto);if(!r)return e;const l=L.get(r);if(!l)return e;let o=[];Array.isArray(l)?o=l:Array.isArray(l?.estudiantes)&&(o=l.estudiantes);const c=Array.isArray(o)?o.length:Number(l?.total)||0;return{...e,total_estudiantes_asignados:c}});console.debug("[Seguimiento] formateados:",W.length);const oe=Array.from(new Set(G.filter(e=>!(Number(e.total_estudiantes_completados)>0)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),K=new Map;await Promise.all(oe.map(async e=>{try{const r=await ae(e);K.set(e,r)}catch{}}));const J=G.map(e=>{const r=Number(e.total_estudiantes_asignados)||0,l=Number(e.total_estudiantes_completados)||0,o=Number(e.apertura_id||e.apertura_id_resuelto);if(!o||l>0)return e;const c=K.get(o);if(!c&&r>0)return e;let _=Number(c?.total_estudiantes_completados)||Number(c?.total_completados)||Number(c?.completados_total)||Number(c?.estudiantes_completados)||Number(c?.total_estudiantes_finalizados)||Number(c?.completados)||Number(c?.resumen?.completados)||Number(c?.resumen?.total_completados)||(Array.isArray(c?.estudiantes)?c.estudiantes.filter(f=>f?.estado==="completado"||f?.completado===1||f?.intento_id||f?.ha_intentado===1).length:0);if(_===0||r===0){const f=L.get(o);if(f){let w=[];Array.isArray(f)?w=f:Array.isArray(f?.estudiantes)&&(w=f.estudiantes);const T=Array.isArray(w)?w.length:Number(f?.total)||r,k=Array.isArray(w)?w.filter(E=>E?.estado==="completado"||E?.completado===1||E?.intento_id||E?.ha_intentado===1).length:Number(f?.completados)||_;e.total_estudiantes_asignados=T,_=k}}return{...e,total_estudiantes_completados:_}}),ie=Array.from(new Set(J.filter(e=>!(e.fecha_inicio&&e.fecha_fin)).map(e=>Number(e.apertura_id||e.apertura_id_resuelto)).filter(e=>!!e))),Q=new Map;await Promise.all(ie.map(async e=>{try{const r=await F.get(R.seguimiento.info(e)),l=r?.data?.data??r?.data??{},o=l?.fecha_inicio??l?.inicio??"",c=l?.fecha_fin??l?.fin??"";(o||c)&&Q.set(e,{fi:o,ff:c})}catch{}}));const ne=J.map(e=>{if(e.fecha_inicio&&e.fecha_fin)return e;const r=Number(e.apertura_id||e.apertura_id_resuelto),l=Q.get(r);return l?{...e,fecha_inicio:e.fecha_inicio||l.fi||"",fecha_fin:e.fecha_fin||l.ff||""}:e}),$=new Map;ne.forEach(e=>{const r=Number(e.apertura_id||e.apertura_id_resuelto)||e.titulo;$.has(r)||$.set(r,e)});const B=Array.from($.values()).filter(e=>Number(e.total_estudiantes_asignados)>0);i(B);const Y=B.reduce((e,r)=>e+(Number(r.total_estudiantes_asignados)||0),0),X=B.reduce((e,r)=>e+(Number(r.total_estudiantes_completados)||0),0),le=Y>0?Math.round(X/Y*100):0;y({total_cuestionarios:B.length,total_estudiantes_asignados:Y,total_estudiantes_completados:X,porcentaje_global:le})}}catch(a){console.error("Error al cargar seguimiento:",a);let d="Error desconocido al cargar los datos";a instanceof Error&&(a.message.includes("ERR_NETWORK")||a.message.includes("ECONNREFUSED")?d="No se puede conectar al servidor. Verifique que el servidor esté en ejecución.":a.message.includes("404")?d="Endpoint no encontrado. Verifique la configuración de la API.":d=a.message),j(d),i([]),y({total_cuestionarios:0,total_estudiantes_asignados:0,total_estudiantes_completados:0,porcentaje_global:0})}finally{A(!1)}},[s?.id]),D=h.useRef(!1);globalThis.__seguimientoCaches||(globalThis.__seguimientoCaches={infoCache:new Map,estudiantesCache:new Map,inFlightInfo:new Map,inFlightEst:new Map});const{infoCache:U,estudiantesCache:V,inFlightInfo:I,inFlightEst:H}=globalThis.__seguimientoCaches,P=h.useRef(!1),ae=h.useCallback(async a=>{const d=U;if(d.has(a))return d.get(a);const b=I,C=b.get(a);if(C)return await C;const g=F.get(R.seguimiento.info(a),{params:{_ts:Date.now()}}).then(u=>{const N=u?.data?.data??u?.data;return d.set(a,N),b.delete(a),N}).catch(u=>{throw b.delete(a),u});return b.set(a,g),await g},[]),se=h.useCallback(async a=>{const d=V;if(d.has(a))return d.get(a);const b=H,C=b.get(a);if(C)return await C;const g=F.get(R.seguimiento.estudiantes(a),{params:{_ts:Date.now()}}).then(u=>{const N=u?.data?.data??u?.data;return d.set(a,N),b.delete(a),N}).catch(u=>{throw b.delete(a),u});return b.set(a,g),await g},[]);return h.useEffect(()=>{!s?.id||D.current||(D.current=!0,!P.current&&(P.current=!0,x.current=M().finally(()=>{P.current=!1,x.current=null})))},[s?.id,M]),{cuestionarios:v,estadisticas:p,error:n,loading:S,goToDetalle:a=>{m(`/seguimiento/detalle/${a}`)},refetch:async()=>{A(!0),j(null),D.current=!1,await M()},invalidateCaches:()=>{try{U.clear(),V.clear(),I.clear(),H.clear()}catch{}D.current=!1}}}const pe=()=>{const m=te();return t.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[t.jsx("h2",{className:"mb-0 text-dark",children:"Seguimiento de Cuestionarios"}),t.jsxs("button",{className:"btn btn-outline-secondary",onClick:()=>m("/dashboard"),style:{borderColor:"#00a19B",color:"#00a19B"},onMouseOver:s=>{s.currentTarget.style.backgroundColor="#00a19B",s.currentTarget.style.color="white"},onMouseOut:s=>{s.currentTarget.style.backgroundColor="transparent",s.currentTarget.style.color="#00a19B"},children:[t.jsx("i",{className:"fas fa-arrow-left me-2"}),"Volver"]})]})},_e=({estadisticas:m})=>t.jsxs("div",{className:"row g-3 mb-4",children:[t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Cuestionarios"}),t.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:m.total_cuestionarios})]}),t.jsx(ue,{size:18,style:{color:"#00a19B"}})]})})}),t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Asignados"}),t.jsx("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:m.total_estudiantes_asignados})]}),t.jsx(fe,{size:18,style:{color:"#3498db"}})]})})}),t.jsx("div",{className:"col-12 col-md-4",children:t.jsx("div",{className:"card shadow-sm border-0 h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:t.jsxs("div",{className:"card-body d-flex justify-content-between align-items-center",children:[t.jsxs("div",{children:[t.jsx("h6",{className:"text-muted mb-1",style:{fontSize:"0.8rem"},children:"Completados"}),t.jsxs("h2",{className:"mb-0",style:{fontSize:"1.2rem",fontWeight:"500",color:"#2c3e50"},children:[m.total_estudiantes_completados," (",m.porcentaje_global,"%)"]})]}),t.jsx(me,{size:18,style:{color:"#2ecc71"}})]})})})]}),ye=({cuestionarios:m,onDetalle:s})=>{const v=i=>{if(!i)return"";const p=i.split("T")[0].split("-");return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:i};return t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table table-hover mb-0",children:[t.jsx("thead",{className:"table-light",children:t.jsxs("tr",{children:[t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Título"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Programa"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Periodo"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Fechas"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Progreso"}),t.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"}})]})}),t.jsx("tbody",{children:m.map(i=>{const p=i.total_estudiantes_asignados>0?Math.round(i.total_estudiantes_completados/i.total_estudiantes_asignados*100):0,y=Number(i.apertura_id||i.apertura_id_resuelto);return t.jsxs("tr",{children:[t.jsxs("td",{style:{fontSize:"0.8rem"},children:[t.jsx("strong",{className:"text-dark",children:i.titulo}),i.descripcion&&t.jsx("div",{className:"text-muted",style:{fontSize:"0.75rem",marginTop:"0.15rem"},children:i.descripcion.length>30?`${i.descripcion.substring(0,30)}...`:i.descripcion})]}),t.jsx("td",{style:{fontSize:"0.8rem"},children:i.programa_nombre}),t.jsx("td",{style:{fontSize:"0.8rem"},children:i.periodo_nombre}),t.jsx("td",{style:{fontSize:"0.8rem"},children:(()=>{const n=i,j=n.fecha_inicio??n.inicio??n.apertura_inicio??n.periodo_inicio??n.start??"",S=n.fecha_fin??n.fin??n.apertura_fin??n.periodo_fin??n.end??"",A=j?v(String(j)):"-",x=S?v(String(S)):"-";return t.jsxs("div",{className:"d-flex flex-column gap-1",children:[t.jsxs("div",{className:"text-dark",style:{fontSize:"0.75rem"},children:[t.jsx("i",{className:"fas fa-calendar me-1",style:{color:"#00a19B",width:"0.8rem"}}),A]}),t.jsxs("div",{className:"text-muted",style:{fontSize:"0.75rem"},children:[t.jsx("i",{className:"fas fa-calendar-check me-1",style:{color:"#00a19B",width:"0.8rem"}}),x]})]})})()}),t.jsxs("td",{style:{fontSize:"0.8rem"},children:[t.jsxs("div",{className:"text-muted text-center mb-2",style:{fontSize:"0.75rem"},children:[t.jsx("span",{style:{color:"#2ecc71",fontWeight:"600"},children:i.total_estudiantes_completados})," / ",i.total_estudiantes_asignados," Estudiantes"]}),t.jsx("div",{style:{maxWidth:"150px",marginBottom:"1rem"},children:t.jsx("div",{className:"progress mb-2",style:{height:".9rem"},children:t.jsxs("div",{className:"progress-bar",role:"progressbar",style:{width:`${p}%`,backgroundColor:"#2ecc71",fontSize:"0.75rem",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600"},"aria-valuenow":p,"aria-valuemin":0,"aria-valuemax":100,children:[p,"%"]})})})]}),t.jsx("td",{children:t.jsxs("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>s(y),title:"Ver detalles",style:{borderColor:"#00a19B",color:"#00a19B",fontSize:"0.8rem",padding:"0.4rem 0.8rem",transition:"all 0.2s ease"},onMouseOver:n=>{n.currentTarget.style.backgroundColor="#00a19B",n.currentTarget.style.color="white",n.currentTarget.style.transform="translateY(-1px)"},onMouseOut:n=>{n.currentTarget.style.backgroundColor="transparent",n.currentTarget.style.color="#00a19B",n.currentTarget.style.transform="translateY(0)"},children:[t.jsx(he,{size:12,className:"me-1"})," Detalles"]})})]},y||i.titulo)})})]})})},q=({message:m,type:s="info"})=>{const v=s==="error"?"alert-danger":"alert-info",i=s==="error"?"fas fa-exclamation-triangle":"fas fa-info-circle";return t.jsxs("div",{className:`alert ${v} d-flex align-items-center`,role:"alert",children:[t.jsx("i",{className:`${i} me-2`}),m]})},Ce=()=>{const{cuestionarios:m,estadisticas:s,error:v,loading:i,goToDetalle:p,refetch:y,invalidateCaches:n}=ge(),j=ce();h.useEffect(()=>{n(),y()},[]),h.useEffect(()=>{const x=()=>{y()},M=()=>{document.visibilityState==="visible"&&y()};return window.addEventListener("focus",x),document.addEventListener("visibilitychange",M),()=>{window.removeEventListener("focus",x),document.removeEventListener("visibilitychange",M)}},[y]),h.useEffect(()=>{j?.pathname&&j.pathname.toLowerCase().includes("seguimiento")&&(n(),y())},[j?.pathname]);const S=m.filter(x=>Number(x.activo)===1),A=S.length>0?S:m;return t.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:t.jsx("div",{className:"row justify-content-center",children:t.jsxs("div",{className:"col-12 col-xl-10",children:[t.jsx(pe,{}),t.jsx(_e,{estadisticas:s}),t.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[t.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:t.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[t.jsx("i",{className:"fas fa-list me-2"}),"Cuestionarios"]})}),t.jsx("div",{className:"card-body",children:i?t.jsx(q,{message:"Cargando...",type:"info"}):v?t.jsx(q,{message:v,type:"error"}):A.length===0?t.jsx(q,{message:"Sin cuestionarios abiertos.",type:"info"}):t.jsx(ye,{cuestionarios:A,onDetalle:p})})]})]})})})};export{Ce as default};
