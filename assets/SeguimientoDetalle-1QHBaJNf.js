import{r as h,d as Z,b as D,A as P,a as J,j as e,e as ee}from"./index-BTkTQ1Fh.js";import{m as te,N as re,z as G,d as se,c as ae}from"./index-DLtsYAVg.js";import"./iconBase-QLClNUbn.js";const oe=s=>{const[n,d]=h.useState(null),[i,m]=h.useState([]),[f,v]=h.useState(!0),[k,a]=h.useState(null),u=h.useContext(Z),b=h.useRef(null),y=h.useRef(!1),N=async()=>{if(!s){v(!1);return}try{const g=u?.user?.id,t=`${s}:${g??"no-user"}`;if(b.current===t||y.current)return;b.current=t,y.current=!0,v(!0),a(null);const o=g;if(!o){try{u?.checkSession?.()}catch{}v(!1);return}const[r,x]=await Promise.all([D.get(P.aperturas.base),D.get(P.asignacion.obtener(o))]),j=r?.data?.data||r?.data;let z=[];Array.isArray(j)?z=j:j?.aperturas&&Array.isArray(j.aperturas)?z=j.aperturas:j?.apertura&&Array.isArray(j.apertura)&&(z=j.apertura);const p=z.find(C=>C.id===Number(s));if(!p)throw new Error("No se encontró la apertura especificada");const w=x?.data?.data||x?.data;let F=[];Array.isArray(w)?F=w:w?.asignaciones&&Array.isArray(w.asignaciones)?F=w.asignaciones:w?.asignacion&&Array.isArray(w.asignacion)&&(F=w.asignacion);const V=F.filter(C=>C.id_apertura===Number(s));let q=null;try{const C=await D.get(P.seguimiento.info(Number(s))),S=C?.data?.data||C?.data||{},_=S?.id_cuestionario??S?.cuestionario_id??S?.cuestionario?.id;_&&(q=Number(_))}catch{}const K=q??p?.id_cuestionario??p?.cuestionario_id??p?.cuestionario?.id??null,B={apertura_id:Number(s),id:K||p.id,cuestionario_id:K||null,titulo:p.titulo||"Sin título",descripcion:p.descripcion||"Sin descripción",periodo_nombre:p.periodo_nombre||"Sin periodo",fecha_inicio:p.fecha_inicio||"",fecha_fin:p.fecha_fin||"",programa_nombre:p.programa_nombre||"Sin programa"};try{console.debug("[SeguimientoDetalle] IDs -> apertura_id:",Number(s),"cuestionario_id:",B.cuestionario_id,"id(usado):",B.id)}catch{}if(d(B),V.length>0){const C=await D.get(P.estudiante.base);let S=[];const _=C?.data?.data||C?.data;Array.isArray(_)?S=_:Array.isArray(_?.estudiantes)?S=_.estudiantes:Array.isArray(_?.estudiante)&&(S=_.estudiante);let M=null;try{const c=await D.get(P.seguimiento.estudiantes(Number(s)));M=c?.data?.data||c?.data}catch{}let W=[];Array.isArray(M)?W=M:Array.isArray(M?.estudiantes)&&(W=M.estudiantes);const U=new Map;W.forEach(c=>{const E=Number(c?.id_estudiante||c?.estudiante_id||c?.id);E&&U.set(E,c)});const Q=await Promise.all(V.map(async c=>{const E=Number(c.id_estudiante),$=Array.isArray(S)?S.find(O=>Number(O.id)===E):null,l=U.get(E)||{},X=c?.completado===1||c?.completado===!0||c?.completado==="1"||l?.completado===1||l?.completado===!0||l?.completado==="1"||!!l?.intento_id||l?.ha_intentado===1||l?.estado==="completado";let I=l?.nombre||l?.estudiante_nombre||$?.nombre||"",R=l?.identificacion||l?.estudiante_identificacion||$?.identificacion||"",L=l?.email||l?.estudiante_email||$?.email||"";if((!I||!R)&&E)try{const O=await D.get(P.estudiante.byId(E)),H=O?.data?.data||O?.data||{};I=I||H?.nombre||"",R=R||H?.identificacion||"",L=L||H?.email||""}catch{}return{id:E,nombre:I||"Estudiante desconocido",identificacion:R,email:L,completado:X,fecha_respuesta:c?.fecha_respuesta||l?.fecha_respuesta||l?.fecha||null,puntaje_obtenido:c?.puntaje_obtenido??l?.puntaje_obtenido??l?.puntaje??0,puntaje_total:c?.puntaje_total??l?.puntaje_total??0,porcentaje:c?.porcentaje??l?.porcentaje??0,total_preguntas:c?.total_preguntas??l?.total_preguntas??0,respuestas_correctas:c?.respuestas_correctas??l?.respuestas_correctas??0}}));m(Q)}else m([])}catch(g){console.error("Error al cargar detalles:",g),a(g instanceof Error?g.message:"Error desconocido")}finally{y.current=!1,v(!1)}},T=()=>{N()},A=(g,t)=>{m(o=>o.map(r=>r.id===g?{...r,...t}:r))};return h.useEffect(()=>{N()},[s,u?.user?.id]),{cuestionario:n,estudiantes:i,loading:f,error:k,recargarDetalles:T,actualizarEstudianteLocal:A,totalEstudiantes:i.length,hayDatos:n!==null,hayEstudiantes:i.length>0}},ne=s=>{const n=h.useMemo(()=>{const a=s.length,u=s.filter(N=>N.completado===1||N.completado===!0||N.completado==="1").length,b=a-u;return{porcentajeCompletado:a>0?Math.round(u/a*100):0,estudiantesCompletados:u,estudiantesPendientes:b,totalEstudiantes:a}},[s]),d=h.useMemo(()=>({porcentaje:n.porcentajeCompletado,completados:n.estudiantesCompletados,pendientes:n.estudiantesPendientes,total:n.totalEstudiantes}),[n]),i=h.useMemo(()=>{const a=s.filter(r=>r.completado===1||r.completado===!0||r.completado==="1"),u=a.length>0?Math.round(a.reduce((r,x)=>r+x.porcentaje,0)/a.length):0,b=a.map(r=>r.porcentaje),y=b.length>0?Math.max(...b):0,N=b.length>0?Math.min(...b):0,T=a.filter(r=>r.porcentaje===100).length,A=a.filter(r=>r.porcentaje>=90).length,g=a.filter(r=>r.porcentaje>=70&&r.porcentaje<90).length,t=a.filter(r=>r.porcentaje>=50&&r.porcentaje<70).length,o=a.filter(r=>r.porcentaje<50).length;return{promedioPuntaje:u,mejorPuntaje:y,peorPuntaje:N,puntajePerfecto:T,distribucion:{excelente:A,bueno:g,regular:t,deficiente:o}}},[s]);return{...n,progressInfo:d,metricas:i,getEstadoColor:a=>a>=80?"success":a>=50?"warning":"danger",getDescripcionEstado:a=>a===100?"Completado perfectamente":a>=80?"Excelente progreso":a>=50?"Progreso moderado":a>0?"Progreso lento":"Sin progreso",formatearPorcentaje:a=>`${a}%`,formatearFecha:a=>a?new Date(a).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",hayCompletados:n.estudiantesCompletados>0,hayPendientes:n.estudiantesPendientes>0,estaCompleto:n.porcentajeCompletado===100,necesitaAtencion:n.porcentajeCompletado<50}},Y=({titulo:s="Detalles",backUrl:n="/seguimiento",onBack:d})=>{const i=J(),m=()=>{d?d():i(n)};return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4 p-3",style:{backgroundColor:"#00a19B",borderRadius:"0.375rem",color:"white"},children:[e.jsxs("button",{className:"btn btn-outline-light btn-sm d-flex align-items-center",onClick:m,type:"button","aria-label":"Volver atrás",style:{borderColor:"rgba(255, 255, 255, 0.3)",color:"white",transition:"all 0.2s ease"},onMouseOver:f=>{f.currentTarget.style.backgroundColor="rgba(255, 255, 255, 0.2)",f.currentTarget.style.borderColor="rgba(255, 255, 255, 0.5)"},onMouseOut:f=>{f.currentTarget.style.backgroundColor="transparent",f.currentTarget.style.borderColor="rgba(255, 255, 255, 0.3)"},children:[e.jsx(te,{size:12,className:"me-2"})," Atrás"]}),e.jsx("h1",{className:"mb-0 text-white",style:{fontSize:"1rem",fontWeight:"500"},children:s})]})},ie=s=>{if(!s)return"";const n=s.split("T")[0].split("-");return n.length===3?`${n[2]}/${n[1]}/${n[0]}`:s},le=({cuestionario:s,formatearFecha:n})=>{const d=n||ie;return e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx(re,{size:14,className:"me-2"}),"Información"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("h4",{className:"mb-3",style:{color:"#2c3e50"},children:s.titulo}),e.jsx("p",{className:"text-muted mb-4",style:{fontSize:"0.9rem",lineHeight:"1.5"},children:s.descripcion}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:i=>{i.currentTarget.style.transform="translateY(-2px)",i.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:i=>{i.currentTarget.style.transform="translateY(0)",i.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-graduation-cap me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Programa:"})]}),e.jsx("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:s.programa_nombre})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:i=>{i.currentTarget.style.transform="translateY(-2px)",i.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:i=>{i.currentTarget.style.transform="translateY(0)",i.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-calendar me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Periodo:"})]}),e.jsx("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:s.periodo_nombre})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:i=>{i.currentTarget.style.transform="translateY(-2px)",i.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:i=>{i.currentTarget.style.transform="translateY(0)",i.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-calendar-alt me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Fechas:"})]}),e.jsxs("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:[d(s.fecha_inicio)," - ",d(s.fecha_fin)]})]})})})]})]})]})},ce=({estudiantes:s,cuestionarioId:n,programaNombre:d,formatearFecha:i=m=>m?new Date(m).toLocaleDateString():"-"})=>{const m=J(),f=(t,o)=>{if(n){const r={...o,programa_nombre:o.programa_nombre||d||""};m(`/ver-respuesta/${t}/${n}`,{state:{estudiante:r}})}},v=t=>{if(!t.completado)return"-";const o=t.puntaje_obtenido==null?0:t.puntaje_obtenido,r=t.puntaje_total==null?0:t.puntaje_total,x=t.porcentaje==null?0:t.porcentaje;return`${o}/${r} (${x}%)`},k=t=>t===1||t===!0||t==="1"?"badge bg-success":"badge bg-warning text-dark",a=t=>t===1||t===!0||t==="1"?"Completado":"Pendiente",[u,b]=h.useState("todos"),[y,N]=h.useState(""),T=h.useMemo(()=>{const t=(o,r)=>o.toLowerCase().includes(r.toLowerCase());return s.filter(o=>{const r=o.completado===1||o.completado===!0||o.completado==="1";if(u==="completado"&&!r||u==="pendiente"&&r)return!1;if(y.trim()){const x=y.trim(),j=(o.nombre||"").toString(),z=(o.email||"").toString(),p=(o.identificacion||"").toString();if(!(t(j,x)||t(z,x)||t(p,x)))return!1}return!0})},[s,u,y]),A=t=>t===1||t===!0||t==="1"?1:0,g=[...T].sort((t,o)=>{const r=A(o.completado)-A(t.completado);if(r!==0)return r;const x=(t.nombre||"").toString(),j=(o.nombre||"").toString();return x.localeCompare(j,void 0,{sensitivity:"base"})});return s.length===0?e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx(G,{size:14,className:"me-2"}),"Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"text-center text-muted py-4",children:"Sin estudiantes asignados."})})]}):e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2",children:[e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx(G,{size:14,className:"me-2"}),"Estudiantes"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Buscar...",value:y,onChange:t=>N(t.target.value),style:{width:"200px",height:"38px"}}),e.jsxs("select",{className:"form-select form-select-sm",value:u,onChange:t=>b(t.target.value),style:{width:"200px",height:"38px"},children:[e.jsx("option",{value:"todos",children:"Todos"}),e.jsx("option",{value:"completado",children:"Completado"}),e.jsx("option",{value:"pendiente",children:"Pendiente"})]})]})]})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Nombre"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"ID"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Email"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Estado"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Fecha"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Puntaje"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"}})]})}),e.jsx("tbody",{children:g.map(t=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontSize:"0.8rem"},children:t.nombre}),e.jsx("td",{style:{fontSize:"0.8rem"},children:t.identificacion}),e.jsx("td",{style:{fontSize:"0.8rem"},children:t.email}),e.jsx("td",{children:e.jsx("span",{className:k(t.completado),style:{fontSize:"0.7rem"},children:a(t.completado)})}),e.jsx("td",{style:{fontSize:"0.8rem"},children:i(t.fecha_respuesta)}),e.jsx("td",{style:{fontSize:"0.8rem"},children:v(t)}),e.jsx("td",{children:t.completado===1||t.completado===!0||t.completado==="1"?e.jsxs("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>f(t.id,t),title:"Ver respuestas",type:"button",style:{borderColor:"#00a19B",color:"#00a19B",fontSize:"0.8rem",padding:"0.4rem 0.8rem",transition:"all 0.2s ease"},onMouseOver:o=>{o.currentTarget.style.backgroundColor="#00a19B",o.currentTarget.style.color="white"},onMouseOut:o=>{o.currentTarget.style.backgroundColor="transparent",o.currentTarget.style.color="#00a19B"},children:[e.jsx(se,{size:12,className:"me-1"})," Ver"]}):e.jsxs("button",{className:"btn btn-outline-secondary btn-sm",disabled:!0,title:"Sin respuestas",type:"button",style:{borderColor:"#6c757d",color:"#6c757d",fontSize:"0.8rem",padding:"0.4rem 0.8rem",opacity:"0.6"},children:[e.jsx(ae,{size:12,className:"me-1"})," N/A"]})})]},t.id))})]})})})]})},he=()=>{const{id:s}=ee(),{cuestionario:n,estudiantes:d,loading:i,error:m,hayDatos:f}=oe(s),{formatearFecha:v}=ne(d);return i?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsx("div",{className:"col-12 col-xl-10",children:e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"Cargando detalles..."})})})})}):m?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(Y,{titulo:"Detalles"}),e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsxs("p",{children:["Error: ",m]})})]})})}):!f||!n?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(Y,{titulo:"Detalles"}),e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"No se encontraron detalles del cuestionario."})})]})})}):e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(Y,{titulo:"Detalles"}),e.jsx(le,{cuestionario:n}),e.jsx(ce,{estudiantes:d,cuestionarioId:n.cuestionario_id,programaNombre:n.programa_nombre,formatearFecha:v})]})})})};export{he as default};
