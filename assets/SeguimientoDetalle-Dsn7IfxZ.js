import{r as b,d as V,b as E,A as z,a as $,j as e,e as U}from"./index-DaOhVVWd.js";import{m as q,P as G,A as B,d as J,c as K}from"./index-B8Flq_4W.js";import"./iconBase-Cr-ff6zs.js";const Q=r=>{const[o,l]=b.useState(null),[s,m]=b.useState([]),[u,g]=b.useState(!0),[D,t]=b.useState(null),n=b.useContext(V),h=async()=>{if(!r){g(!1);return}try{g(!0),t(null);const p=n?.user?.id;if(!p){try{n?.checkSession?.()}catch{}g(!1);return}const[C,S]=await Promise.all([E.get(z.aperturas.base),E.get(z.asignacion.obtener(p))]),c=C?.data?.data||C?.data;let _=[];Array.isArray(c)?_=c:c?.aperturas&&Array.isArray(c.aperturas)?_=c.aperturas:c?.apertura&&Array.isArray(c.apertura)&&(_=c.apertura);const a=_.find(x=>x.id===Number(r));if(!a)throw new Error("No se encontró la apertura especificada");const f=S?.data?.data||S?.data;let P=[];Array.isArray(f)?P=f:f?.asignaciones&&Array.isArray(f.asignaciones)?P=f.asignaciones:f?.asignacion&&Array.isArray(f.asignacion)&&(P=f.asignacion);const F=P.filter(x=>x.id_apertura===Number(r));let O=null;try{const x=await E.get(z.seguimiento.info(Number(r))),j=x?.data?.data||x?.data||{},y=j?.id_cuestionario??j?.cuestionario_id??j?.cuestionario?.id;y&&(O=Number(y))}catch{}const R=O??a?.id_cuestionario??a?.cuestionario_id??a?.cuestionario?.id??null,T={apertura_id:Number(r),id:R||a.id,cuestionario_id:R||null,titulo:a.titulo||"Sin título",descripcion:a.descripcion||"Sin descripción",periodo_nombre:a.periodo_nombre||"Sin periodo",fecha_inicio:a.fecha_inicio||"",fecha_fin:a.fecha_fin||"",programa_nombre:a.programa_nombre||"Sin programa"};try{console.debug("[SeguimientoDetalle] IDs -> apertura_id:",Number(r),"cuestionario_id:",T.cuestionario_id,"id(usado):",T.id)}catch{}if(l(T),F.length>0){const x=await E.get(z.estudiante.base);let j=[];const y=x?.data?.data||x?.data;Array.isArray(y)?j=y:Array.isArray(y?.estudiantes)?j=y.estudiantes:Array.isArray(y?.estudiante)&&(j=y.estudiante);let A=null;try{const i=await E.get(z.seguimiento.estudiantes(Number(r)));A=i?.data?.data||i?.data}catch{}let M=[];Array.isArray(A)?M=A:Array.isArray(A?.estudiantes)&&(M=A.estudiantes);const W=new Map;M.forEach(i=>{const w=Number(i?.id_estudiante||i?.estudiante_id||i?.id);w&&W.set(w,i)});const H=F.map(i=>{const w=Number(i.id_estudiante),k=Array.isArray(j)?j.find(Y=>Number(Y.id)===w):null,d=W.get(w),L=i?.completado===1||i?.completado===!0||i?.completado==="1"||d?.completado===1||d?.completado===!0||d?.completado==="1"||!!d?.intento_id||d?.ha_intentado===1||d?.estado==="completado";return{id:w,nombre:k?.nombre||"Estudiante desconocido",identificacion:k?.identificacion||"",email:k?.email||"",completado:L,fecha_respuesta:i?.fecha_respuesta||d?.fecha_respuesta||d?.fecha||null,puntaje_obtenido:i?.puntaje_obtenido??d?.puntaje_obtenido??d?.puntaje??0,puntaje_total:i?.puntaje_total??d?.puntaje_total??0,porcentaje:i?.porcentaje??d?.porcentaje??0,total_preguntas:i?.total_preguntas??d?.total_preguntas??0,respuestas_correctas:i?.respuestas_correctas??d?.respuestas_correctas??0}});m(H)}else m([])}catch(p){console.error("Error al cargar detalles:",p),t(p instanceof Error?p.message:"Error desconocido")}finally{g(!1)}},v=()=>{h()},N=(p,C)=>{m(S=>S.map(c=>c.id===p?{...c,...C}:c))};return b.useEffect(()=>{h()},[r,n?.user,n?.isAuthenticated]),{cuestionario:o,estudiantes:s,loading:u,error:D,recargarDetalles:v,actualizarEstudianteLocal:N,totalEstudiantes:s.length,hayDatos:o!==null,hayEstudiantes:s.length>0}},X=r=>{const o=b.useMemo(()=>{const t=r.length,n=r.filter(N=>N.completado===1||N.completado===!0||N.completado==="1").length,h=t-n;return{porcentajeCompletado:t>0?Math.round(n/t*100):0,estudiantesCompletados:n,estudiantesPendientes:h,totalEstudiantes:t}},[r]),l=b.useMemo(()=>({porcentaje:o.porcentajeCompletado,completados:o.estudiantesCompletados,pendientes:o.estudiantesPendientes,total:o.totalEstudiantes}),[o]),s=b.useMemo(()=>{const t=r.filter(a=>a.completado===1||a.completado===!0||a.completado==="1"),n=t.length>0?Math.round(t.reduce((a,f)=>a+f.porcentaje,0)/t.length):0,h=t.map(a=>a.porcentaje),v=h.length>0?Math.max(...h):0,N=h.length>0?Math.min(...h):0,p=t.filter(a=>a.porcentaje===100).length,C=t.filter(a=>a.porcentaje>=90).length,S=t.filter(a=>a.porcentaje>=70&&a.porcentaje<90).length,c=t.filter(a=>a.porcentaje>=50&&a.porcentaje<70).length,_=t.filter(a=>a.porcentaje<50).length;return{promedioPuntaje:n,mejorPuntaje:v,peorPuntaje:N,puntajePerfecto:p,distribucion:{excelente:C,bueno:S,regular:c,deficiente:_}}},[r]);return{...o,progressInfo:l,metricas:s,getEstadoColor:t=>t>=80?"success":t>=50?"warning":"danger",getDescripcionEstado:t=>t===100?"Completado perfectamente":t>=80?"Excelente progreso":t>=50?"Progreso moderado":t>0?"Progreso lento":"Sin progreso",formatearPorcentaje:t=>`${t}%`,formatearFecha:t=>t?new Date(t).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",hayCompletados:o.estudiantesCompletados>0,hayPendientes:o.estudiantesPendientes>0,estaCompleto:o.porcentajeCompletado===100,necesitaAtencion:o.porcentajeCompletado<50}},I=({titulo:r="Detalles",backUrl:o="/seguimiento",onBack:l})=>{const s=$(),m=()=>{l?l():s(o)};return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4 p-3",style:{backgroundColor:"#00a19B",borderRadius:"0.375rem",color:"white"},children:[e.jsxs("button",{className:"btn btn-outline-light btn-sm d-flex align-items-center",onClick:m,type:"button","aria-label":"Volver atrás",style:{borderColor:"rgba(255, 255, 255, 0.3)",color:"white",transition:"all 0.2s ease"},onMouseOver:u=>{u.currentTarget.style.backgroundColor="rgba(255, 255, 255, 0.2)",u.currentTarget.style.borderColor="rgba(255, 255, 255, 0.5)"},onMouseOut:u=>{u.currentTarget.style.backgroundColor="transparent",u.currentTarget.style.borderColor="rgba(255, 255, 255, 0.3)"},children:[e.jsx(q,{size:12,className:"me-2"})," Atrás"]}),e.jsx("h1",{className:"mb-0 text-white",style:{fontSize:"1rem",fontWeight:"500"},children:r})]})},Z=r=>{if(!r)return"";const o=r.split("T")[0].split("-");return o.length===3?`${o[2]}/${o[1]}/${o[0]}`:r},ee=({cuestionario:r,formatearFecha:o})=>{const l=o||Z;return e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx(G,{size:14,className:"me-2"}),"Información"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("h4",{className:"mb-3",style:{color:"#2c3e50"},children:r.titulo}),e.jsx("p",{className:"text-muted mb-4",style:{fontSize:"0.9rem",lineHeight:"1.5"},children:r.descripcion}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-graduation-cap me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Programa:"})]}),e.jsx("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:r.programa_nombre})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-calendar me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Periodo:"})]}),e.jsx("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:r.periodo_nombre})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:s=>{s.currentTarget.style.transform="translateY(-2px)",s.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:s=>{s.currentTarget.style.transform="translateY(0)",s.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-calendar-alt me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Fechas:"})]}),e.jsxs("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:[l(r.fecha_inicio)," - ",l(r.fecha_fin)]})]})})})]})]})]})},te=({estudiantes:r,cuestionarioId:o,formatearFecha:l=s=>s?new Date(s).toLocaleDateString():"-"})=>{const s=$(),m=(t,n)=>{o&&s(`/ver-respuesta/${t}/${o}`,{state:{estudiante:n}})},u=t=>{if(!t.completado)return"-";const n=t.puntaje_obtenido==null?0:t.puntaje_obtenido,h=t.puntaje_total==null?0:t.puntaje_total,v=t.porcentaje==null?0:t.porcentaje;return`${n}/${h} (${v}%)`},g=t=>t===1||t===!0||t==="1"?"badge bg-success":"badge bg-warning text-dark",D=t=>t===1||t===!0||t==="1"?"Completado":"Pendiente";return r.length===0?e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx(B,{size:14,className:"me-2"}),"Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"text-center text-muted py-4",children:"Sin estudiantes asignados."})})]}):e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx(B,{size:14,className:"me-2"}),"Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Nombre"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"ID"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Email"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Estado"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Fecha"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Puntaje"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"}})]})}),e.jsx("tbody",{children:r.map(t=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontSize:"0.8rem"},children:t.nombre}),e.jsx("td",{style:{fontSize:"0.8rem"},children:t.identificacion}),e.jsx("td",{style:{fontSize:"0.8rem"},children:t.email}),e.jsx("td",{children:e.jsx("span",{className:g(t.completado),style:{fontSize:"0.7rem"},children:D(t.completado)})}),e.jsx("td",{style:{fontSize:"0.8rem"},children:l(t.fecha_respuesta)}),e.jsx("td",{style:{fontSize:"0.8rem"},children:u(t)}),e.jsx("td",{children:t.completado===1||t.completado===!0||t.completado==="1"?e.jsxs("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>m(t.id,t),title:"Ver respuestas",type:"button",style:{borderColor:"#00a19B",color:"#00a19B",fontSize:"0.8rem",padding:"0.4rem 0.8rem",transition:"all 0.2s ease"},onMouseOver:n=>{n.currentTarget.style.backgroundColor="#00a19B",n.currentTarget.style.color="white"},onMouseOut:n=>{n.currentTarget.style.backgroundColor="transparent",n.currentTarget.style.color="#00a19B"},children:[e.jsx(J,{size:12,className:"me-1"})," Ver"]}):e.jsxs("button",{className:"btn btn-outline-secondary btn-sm",disabled:!0,title:"Sin respuestas",type:"button",style:{borderColor:"#6c757d",color:"#6c757d",fontSize:"0.8rem",padding:"0.4rem 0.8rem",opacity:"0.6"},children:[e.jsx(K,{size:12,className:"me-1"})," N/A"]})})]},t.id))})]})})})]})},oe=()=>{const{id:r}=U(),{cuestionario:o,estudiantes:l,loading:s,error:m,hayDatos:u}=Q(r),{formatearFecha:g}=X(l);return s?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsx("div",{className:"col-12 col-xl-10",children:e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"Cargando detalles..."})})})})}):m?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(I,{titulo:"Detalles"}),e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsxs("p",{children:["Error: ",m]})})]})})}):!u||!o?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(I,{titulo:"Detalles"}),e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"No se encontraron detalles del cuestionario."})})]})})}):e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(I,{titulo:"Detalles"}),e.jsx(ee,{cuestionario:o}),e.jsx(te,{estudiantes:l,cuestionarioId:o.cuestionario_id,formatearFecha:g})]})})})};export{oe as default};
