import{r as f,d as q,c as M,A as k,a as O,j as e,e as K}from"./index-4_f5pIIv.js";import{n as U,P as G,A as $}from"./index-O__zhACk.js";import{V as J}from"./VerRespuestaButton-YIqzqCH1.js";import"./iconBase-BPqFUofc.js";const Q=o=>{const[a,m]=f.useState(null),[i,h]=f.useState([]),[g,v]=f.useState(!0),[w,n]=f.useState(null),p=f.useContext(q),j=f.useRef(null),y=f.useRef(!1),_=async()=>{if(!o){v(!1);return}try{const x=p?.user?.id,t=`${o}:${x??"no-user"}`;if(j.current===t||y.current)return;j.current=t,y.current=!0,v(!0),n(null);const r=x;if(!r){try{p?.checkSession?.()}catch{}v(!1);return}const[s,b]=await Promise.all([M.get(k.asignacion.obtener(r)),M.get(k.seguimiento.info(Number(o)))]),c=b?.data?.data||b?.data||{},u={id:Number(c?.apertura_id??c?.id??o),titulo:String(c?.titulo??c?.cuestionario_titulo??c?.cuestionario?.titulo??"Sin título"),descripcion:String(c?.descripcion??c?.cuestionario_descripcion??c?.cuestionario?.descripcion??"Sin descripción"),periodo_nombre:String(c?.periodo_nombre??c?.periodo??"Sin periodo"),fecha_inicio:String(c?.fecha_inicio??c?.inicio??""),fecha_fin:String(c?.fecha_fin??c?.fin??""),programa_nombre:String(c?.programa_nombre??c?.programa??c?.cuestionario?.programa_nombre??"Sin programa"),id_cuestionario:Number(c?.id_cuestionario??c?.cuestionario_id??c?.cuestionario?.id??c?.id??0),cuestionario_id:Number(c?.cuestionario_id??c?.id_cuestionario??c?.cuestionario?.id??c?.id??0)};if(!u?.id)throw new Error("No se encontró la apertura especificada");const N=s?.data?.data||s?.data;let A=[];Array.isArray(N)?A=N:N?.asignaciones&&Array.isArray(N.asignaciones)?A=N.asignaciones:N?.asignacion&&Array.isArray(N.asignacion)&&(A=N.asignacion);const P=A.filter(E=>E.id_apertura===Number(o)),R=Number.isFinite(Number(u?.id_cuestionario))&&Number(u.id_cuestionario)>0?Number(u.id_cuestionario):Number.isFinite(Number(u?.cuestionario_id))&&Number(u.cuestionario_id)>0?Number(u.cuestionario_id):null;if(P.length>0){let E=null;try{const l=await M.get(k.seguimiento.estudiantes(Number(o)));E=l?.data?.data||l?.data}catch{}let z=[];Array.isArray(E)?z=E:Array.isArray(E?.estudiantes)&&(z=E.estudiantes);const I=new Map;z.forEach(l=>{const C=Number(l?.id_estudiante||l?.estudiante_id||l?.id);C&&I.set(C,l)});let S=R??u?.id_cuestionario??u?.cuestionario_id??u?.cuestionario?.id??null;if(!S||Number(S)===0){const l=Number(P?.[0]?.id_cuestionario??P?.[0]?.cuestionario_id??0);l>0&&(S=l)}if((!S||Number(S)===0)&&z.length){const l=z[0],C=Number(l?.cuestionario_id??l?.id_cuestionario??0);C>0&&(S=C)}const W={apertura_id:Number(o),id:Number(S||0),cuestionario_id:Number(S||0),titulo:u.titulo||"Sin título",descripcion:u.descripcion||"Sin descripción",periodo_nombre:u.periodo_nombre||"Sin periodo",fecha_inicio:u.fecha_inicio||"",fecha_fin:u.fecha_fin||"",programa_nombre:u.programa_nombre||"Sin programa"};try{console.log("[SeguimientoDetalle] cuestionario_id resolved",{apertura_id:Number(o),infoCuestionarioId:R,fromAsignaciones:P?.[0]?.id_cuestionario??P?.[0]?.cuestionario_id,fromSeguimiento:z?.[0]?.cuestionario_id??z?.[0]?.id_cuestionario,final:W.cuestionario_id})}catch{}m(W);const L=await Promise.all(P.map(async l=>{const C=Number(l.id_estudiante),d=I.get(C)||{},B=l?.completado===1||l?.completado===!0||l?.completado==="1"||d?.completado===1||d?.completado===!0||d?.completado==="1"||!!d?.intento_id||d?.ha_intentado===1||d?.estado==="completado",H=d?.nombre||d?.estudiante_nombre||"",V=d?.identificacion||d?.estudiante_identificacion||"",Y=d?.email||d?.estudiante_email||"";return{id:C,nombre:H||"Estudiante desconocido",identificacion:V,email:Y,completado:B,fecha_respuesta:l?.fecha_respuesta||d?.fecha_respuesta||d?.fecha||null,puntaje_obtenido:l?.puntaje_obtenido??d?.puntaje_obtenido??d?.puntaje??0,puntaje_total:l?.puntaje_total??d?.puntaje_total??0,porcentaje:l?.porcentaje??d?.porcentaje??0,total_preguntas:l?.total_preguntas??d?.total_preguntas??0,respuestas_correctas:l?.respuestas_correctas??d?.respuestas_correctas??0}}));h(L)}else h([])}catch(x){console.error("Error al cargar detalles:",x),n(x instanceof Error?x.message:"Error desconocido")}finally{y.current=!1,v(!1)}},T=()=>{_()},D=(x,t)=>{h(r=>r.map(s=>s.id===x?{...s,...t}:s))};return f.useEffect(()=>{_()},[o,p?.user?.id]),{cuestionario:a,estudiantes:i,loading:g,error:w,recargarDetalles:T,actualizarEstudianteLocal:D,totalEstudiantes:i.length,hayDatos:a!==null,hayEstudiantes:i.length>0}},X=o=>{const a=f.useMemo(()=>{const n=o.length,p=o.filter(_=>_.completado===1||_.completado===!0||_.completado==="1").length,j=n-p;return{porcentajeCompletado:n>0?Math.round(p/n*100):0,estudiantesCompletados:p,estudiantesPendientes:j,totalEstudiantes:n}},[o]),m=f.useMemo(()=>({porcentaje:a.porcentajeCompletado,completados:a.estudiantesCompletados,pendientes:a.estudiantesPendientes,total:a.totalEstudiantes}),[a]),i=f.useMemo(()=>{const n=o.filter(s=>s.completado===1||s.completado===!0||s.completado==="1"),p=n.length>0?Math.round(n.reduce((s,b)=>s+b.porcentaje,0)/n.length):0,j=n.map(s=>s.porcentaje),y=j.length>0?Math.max(...j):0,_=j.length>0?Math.min(...j):0,T=n.filter(s=>s.porcentaje===100).length,D=n.filter(s=>s.porcentaje>=90).length,x=n.filter(s=>s.porcentaje>=70&&s.porcentaje<90).length,t=n.filter(s=>s.porcentaje>=50&&s.porcentaje<70).length,r=n.filter(s=>s.porcentaje<50).length;return{promedioPuntaje:p,mejorPuntaje:y,peorPuntaje:_,puntajePerfecto:T,distribucion:{excelente:D,bueno:x,regular:t,deficiente:r}}},[o]);return{...a,progressInfo:m,metricas:i,getEstadoColor:n=>n>=80?"success":n>=50?"warning":"danger",getDescripcionEstado:n=>n===100?"Completado perfectamente":n>=80?"Excelente progreso":n>=50?"Progreso moderado":n>0?"Progreso lento":"Sin progreso",formatearPorcentaje:n=>`${n}%`,formatearFecha:n=>n?new Date(n).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",hayCompletados:a.estudiantesCompletados>0,hayPendientes:a.estudiantesPendientes>0,estaCompleto:a.porcentajeCompletado===100,necesitaAtencion:a.porcentajeCompletado<50}},F=({titulo:o="Detalles",backUrl:a="/seguimiento",onBack:m})=>{const i=O(),h=()=>{m?m():i(a)};return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4 p-3",style:{backgroundColor:"#00a19B",borderRadius:"0.375rem",color:"white"},children:[e.jsxs("button",{className:"btn btn-outline-light btn-sm d-flex align-items-center",onClick:h,type:"button","aria-label":"Volver atrás",style:{borderColor:"rgba(255, 255, 255, 0.3)",color:"white",transition:"all 0.2s ease"},onMouseOver:g=>{g.currentTarget.style.backgroundColor="rgba(255, 255, 255, 0.2)",g.currentTarget.style.borderColor="rgba(255, 255, 255, 0.5)"},onMouseOut:g=>{g.currentTarget.style.backgroundColor="transparent",g.currentTarget.style.borderColor="rgba(255, 255, 255, 0.3)"},children:[e.jsx(U,{size:12,className:"me-2"})," Atrás"]}),e.jsx("h1",{className:"mb-0 text-white",style:{fontSize:"1rem",fontWeight:"500"},children:o})]})},Z=o=>{if(!o)return"";const a=o.split("T")[0].split("-");return a.length===3?`${a[2]}/${a[1]}/${a[0]}`:o},ee=({cuestionario:o,formatearFecha:a})=>{const m=a||Z;return e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx(G,{size:14,className:"me-2"}),"Información"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("h4",{className:"mb-3",style:{color:"#2c3e50"},children:o.titulo}),e.jsx("p",{className:"text-muted mb-4",style:{fontSize:"0.9rem",lineHeight:"1.5"},children:o.descripcion}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:i=>{i.currentTarget.style.transform="translateY(-2px)",i.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:i=>{i.currentTarget.style.transform="translateY(0)",i.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-graduation-cap me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Programa:"})]}),e.jsx("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:o.programa_nombre})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:i=>{i.currentTarget.style.transform="translateY(-2px)",i.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:i=>{i.currentTarget.style.transform="translateY(0)",i.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-calendar me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Periodo:"})]}),e.jsx("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:o.periodo_nombre})]})})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"card border-0 shadow-sm h-100",style:{transition:"all 0.3s ease"},onMouseOver:i=>{i.currentTarget.style.transform="translateY(-2px)",i.currentTarget.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"},onMouseOut:i=>{i.currentTarget.style.transform="translateY(0)",i.currentTarget.style.boxShadow="0 2px 4px rgba(0,0,0,0.08)"},children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:"fas fa-calendar-alt me-2",style:{color:"#00a19B"}}),e.jsx("strong",{style:{fontSize:"0.8rem",color:"#666"},children:"Fechas:"})]}),e.jsxs("div",{style:{fontSize:"0.9rem",color:"#2c3e50",fontWeight:"500"},children:[m(o.fecha_inicio)," - ",m(o.fecha_fin)]})]})})})]})]})]})},te=({estudiantes:o,cuestionarioId:a,programaNombre:m,formatearFecha:i=h=>h?new Date(h).toLocaleDateString():"-"})=>{const h=O(),g=(t,r)=>{if(a){const s={...r,programa_nombre:r.programa_nombre||m||""};try{console.log("[EstudiantesTable] navigate -> /ver-respuesta",{estudianteId:t,cuestionarioId:a,estudianteState:s})}catch{}h(`/ver-respuesta/${t}/${a}`,{state:{estudiante:s}})}},v=t=>{if(!t.completado)return"-";const r=t.puntaje_obtenido==null?0:t.puntaje_obtenido,s=t.puntaje_total==null?0:t.puntaje_total,b=t.porcentaje==null?0:t.porcentaje;return`${r}/${s} (${b}%)`},w=t=>t===1||t===!0||t==="1"?"badge bg-success":"badge bg-warning text-dark",n=t=>t===1||t===!0||t==="1"?"Completado":"Pendiente",[p,j]=f.useState("todos"),[y,_]=f.useState(""),T=f.useMemo(()=>{const t=(r,s)=>r.toLowerCase().includes(s.toLowerCase());return o.filter(r=>{const s=r.completado===1||r.completado===!0||r.completado==="1";if(p==="completado"&&!s||p==="pendiente"&&s)return!1;if(y.trim()){const b=y.trim(),c=(r.nombre||"").toString(),u=(r.email||"").toString(),N=(r.identificacion||"").toString();if(!(t(c,b)||t(u,b)||t(N,b)))return!1}return!0})},[o,p,y]),D=t=>t===1||t===!0||t==="1"?1:0,x=[...T].sort((t,r)=>{const s=D(r.completado)-D(t.completado);if(s!==0)return s;const b=(t.nombre||"").toString(),c=(r.nombre||"").toString();return b.localeCompare(c,void 0,{sensitivity:"base"})});return o.length===0?e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx($,{size:14,className:"me-2"}),"Estudiantes"]})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"text-center text-muted py-4",children:"Sin estudiantes asignados."})})]}):e.jsxs("div",{className:"card shadow-sm border-0 mb-3",children:[e.jsx("div",{className:"card-header",style:{backgroundColor:"#343a40",color:"white",borderRadius:"0.375rem 0.375rem 0 0"},children:e.jsxs("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2",children:[e.jsxs("h5",{className:"mb-0 d-flex align-items-center",children:[e.jsx($,{size:14,className:"me-2"}),"Estudiantes"]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx("input",{type:"text",className:"form-control form-control-sm",placeholder:"Buscar...",value:y,onChange:t=>_(t.target.value),style:{width:"200px",height:"38px"}}),e.jsxs("select",{className:"form-select form-select-sm",value:p,onChange:t=>j(t.target.value),style:{width:"200px",height:"38px"},children:[e.jsx("option",{value:"todos",children:"Todos"}),e.jsx("option",{value:"completado",children:"Completado"}),e.jsx("option",{value:"pendiente",children:"Pendiente"})]})]})]})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Nombre"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Email"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"ID"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Estado"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Fecha"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"},children:"Puntaje"}),e.jsx("th",{style:{fontSize:"0.75rem",fontWeight:"600"}})]})}),e.jsx("tbody",{children:x.map(t=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontSize:"0.8rem"},children:t.nombre}),e.jsx("td",{style:{fontSize:"0.8rem"},children:t.email}),e.jsx("td",{style:{fontSize:"0.8rem"},children:t.identificacion}),e.jsx("td",{children:e.jsx("span",{className:w(t.completado),style:{fontSize:"0.7rem"},children:n(t.completado)})}),e.jsx("td",{style:{fontSize:"0.8rem"},children:i(t.fecha_respuesta)}),e.jsx("td",{style:{fontSize:"0.8rem"},children:v(t)}),e.jsx("td",{children:(()=>{const r=t,s=r.completado===1||r.completado===!0||r.completado==="1"||String(r.estado||"").toLowerCase()==="completado"||!!r.intento_id||r.ha_intentado===1||r.ha_intentado===!0||r.ha_intentado==="1"||!!r.fecha_respuesta&&String(r.fecha_respuesta).trim()!=="";try{console.log("[EstudiantesTable] puedeVer computed",{estudianteId:r.id,completado:r.completado,estado:r.estado,intento_id:r.intento_id,ha_intentado:r.ha_intentado,fecha_respuesta:r.fecha_respuesta,enabled:s})}catch{}return e.jsx(J,{enabled:s,onClick:()=>g(t.id,t),titleEnabled:"Ver respuestas",titleDisabled:"Sin respuestas",size:"sm"})})()})]},t.id))})]})})})]})},ne=()=>{const{id:o}=K(),{cuestionario:a,estudiantes:m,loading:i,error:h,hayDatos:g}=Q(o),{formatearFecha:v}=X(m);return i?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsx("div",{className:"col-12 col-xl-10",children:e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"Cargando detalles..."})})})})}):h?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(F,{titulo:"Detalles"}),e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsxs("p",{children:["Error: ",h]})})]})})}):!g||!a?e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(F,{titulo:"Detalles"}),e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"No se encontraron detalles del cuestionario."})})]})})}):e.jsx("div",{className:"container-fluid py-3",style:{backgroundColor:"#f8f9fa",minHeight:"100vh"},children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-12 col-xl-10",children:[e.jsx(F,{titulo:"Detalles"}),e.jsx(ee,{cuestionario:a}),(()=>{const w=Number(a.cuestionario_id)>0?Number(a.cuestionario_id):Number(a.id||0);try{console.log("[SeguimientoDetalle] passing props to EstudiantesTable",{apertura_id:a?.apertura_id,cuestionario_id:w})}catch{}return e.jsx(te,{estudiantes:m,cuestionarioId:w,programaNombre:a.programa_nombre,formatearFecha:v})})()]})})})};export{ne as default};
